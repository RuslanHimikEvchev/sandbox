var IV = (function (SCOPE) {

    SCOPE.baseData = {};

    SCOPE.baseData.app_data = {
        "customMetrics": [""],
        "customMetricsEnabled": false,
        "customMetricsTime": 15,
        "encodingTokens": [],
        "id": "12rn8b",
        "campaign-name": "Certification Testing VPAID - MRAID",
        "video-clicks": {"click-thru-url": ""},
        "theme": {
            "fontLibrary": {
                "fontLibrarySwfUrl": "http:\/\/cdn.innovid.com\/common\/runtime-libs\/font-packs\/flash\/defaultFontPack.swf",
                "name": "English\/Latin"
            }, "_explicitType": "com.innovid.vo.IRollAppsThemeConfigVO"
        },
        "version": "2.80",
        "apps": [{
            "id": "ie0j9",
            "title": "Media Gallery",
            "app-id": "app-media-gallery",
            "category": "regular",
            "app-version": "5.1.0",
            "tooltip": "Images & Videos",
            "data": {
                "galleryType": 1,
                "settings": {"supportYouTube": true, "supportImages": true, "supportVideos": true},
                "items": [{
                    "renditions": {
                        "iphone_stream": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7858\/Gin_Wigmore___Don_t_Stop__The_Old_Queens_Head_Session_.iphone_stream",
                        "webm": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7858\/Gin_Wigmore___Don_t_Stop__The_Old_Queens_Head_Session_.webm",
                        "low.mp4": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7858\/Gin_Wigmore___Don_t_Stop__The_Old_Queens_Head_Session_.low.mp4",
                        "high.mp4": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7858\/Gin_Wigmore___Don_t_Stop__The_Old_Queens_Head_Session_.high.mp4",
                        "flv": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7858\/Gin_Wigmore___Don_t_Stop__The_Old_Queens_Head_Session_.flv",
                        "png": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7858\/Gin_Wigmore___Don_t_Stop__The_Old_Queens_Head_Session_.png"
                    },
                    "autoplay": false,
                    "defaultPreview": "http:\/\/static.innovid.com\/media-uploads\/seJDwQ3IZG8hAQIbH6pPGA\/thumb.png",
                    "id": "Don't Stop",
                    "caption": "Don't Stop",
                    "preview": "http:\/\/static.innovid.com\/media-uploads\/seJDwQ3IZG8hAQIbH6pPGA\/thumb.png",
                    "hasPinterest": false,
                    "source": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7858\/Gin_Wigmore___Don_t_Stop__The_Old_Queens_Head_Session_.flv",
                    "type": "Video",
                    "height": 360,
                    "duration": 251.28634643555,
                    "width": 640,
                    "hide": false,
                    "encodingToken": "seJDwQ3IZG8hAQIbH6pPGA"
                }, {
                    "renditions": {
                        "iphone_stream": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7860\/Gin_Wigmore___Oh_My.iphone_stream",
                        "webm": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7860\/Gin_Wigmore___Oh_My.webm",
                        "low.mp4": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7860\/Gin_Wigmore___Oh_My.low.mp4",
                        "high.mp4": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7860\/Gin_Wigmore___Oh_My.high.mp4",
                        "flv": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7860\/Gin_Wigmore___Oh_My.flv",
                        "png": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7860\/Gin_Wigmore___Oh_My.png"
                    },
                    "autoplay": false,
                    "defaultPreview": "http:\/\/static.innovid.com\/media-uploads\/J7mN_bP.gAUnOj0wp7wo1Q\/thumb.png",
                    "id": "Oh My",
                    "caption": "Oh My",
                    "preview": "http:\/\/static.innovid.com\/media-uploads\/J7mN_bP.gAUnOj0wp7wo1Q\/thumb.png",
                    "hasPinterest": false,
                    "source": "http:\/\/static.innovid.com\/media\/encoded\/01_15\/7860\/Gin_Wigmore___Oh_My.flv",
                    "type": "Video",
                    "height": 288,
                    "duration": 248.89468383789,
                    "width": 500,
                    "hide": false,
                    "encodingToken": "J7mN_bP.gAUnOj0wp7wo1Q"
                }, {
                    "hasPinterest": false,
                    "autoFit": true,
                    "clickthruURL": "",
                    "clickthruCaption": "",
                    "type": "Image",
                    "height": 600,
                    "width": 475,
                    "hide": false,
                    "source": "http:\/\/static.innovid.com\/irollapps-upload\/107e80\/5a9a60abd046aa03064bdfc3918f5b43.jpg",
                    "caption": "",
                    "id": "Image 3"
                }, {
                    "hasPinterest": false,
                    "autoFit": true,
                    "clickthruURL": "",
                    "clickthruCaption": "",
                    "type": "Image",
                    "height": 391,
                    "width": 696,
                    "hide": false,
                    "source": "http:\/\/static.innovid.com\/irollapps-upload\/107e80\/75f1870ce66a4d9139568b80a31b81b9.jpg",
                    "caption": "",
                    "id": "Image 4"
                }, {
                    "hasPinterest": false,
                    "autoFit": true,
                    "clickthruURL": "",
                    "clickthruCaption": "",
                    "type": "Image",
                    "height": 1200,
                    "width": 1800,
                    "hide": false,
                    "source": "http:\/\/static.innovid.com\/irollapps-upload\/107e80\/32e0755a04d5e94cf34cb6010f07cb4e.jpg",
                    "caption": "",
                    "id": "Image 5"
                }, {
                    "hasPinterest": false,
                    "autoFit": true,
                    "clickthruURL": "",
                    "clickthruCaption": "",
                    "type": "Image",
                    "height": 2362,
                    "width": 2362,
                    "hide": false,
                    "source": "http:\/\/static.innovid.com\/irollapps-upload\/107e80\/33ff98e34848bb1820794f8885506cd2.jpg",
                    "caption": "",
                    "id": "Image 6"
                }]
            },
            "placeholder": {"type": "docked", "top": 95, "left": 3, "scale": 1, "offsetX": 0, "offsetY": 0},
            "useIconAsImage": true,
            "customLauncher": {
                "width": 1,
                "data": null,
                "type": "png",
                "height": 1,
                "url": "http:\/\/static.innovid.com\/irollapps-upload\/zcea5\/6274d6c344f05fbf90624aa16425aee4.png",
                "source": null,
                "scale": 1
            },
            "reporting": {"namespace": "Media Gallery"},
            "icons": [{
                "url": "http:\/\/cdn.innovid.com\/apps-repository\/app-media-gallery\/2.15.5\/assets\/icon24x24.png",
                "width": 24,
                "height": 24
            }, {
                "url": "http:\/\/cdn.innovid.com\/apps-repository\/app-media-gallery\/2.15.5\/assets\/icon32x32.png",
                "width": 32,
                "height": 32
            }, {
                "url": "http:\/\/cdn.innovid.com\/apps-repository\/app-media-gallery\/2.15.5\/assets\/icon48x48.png",
                "width": 48,
                "height": 48
            }, {
                "url": "http:\/\/cdn.innovid.com\/apps-repository\/app-media-gallery\/2.15.5\/assets\/icon64x64.png",
                "width": 64,
                "height": 64
            }],
            "runtime": {
                "type": "flash",
                "app-renderer": "http:\/\/static.innovid.com\/app-library\/uploads\/app-media-gallery\/5.1.0\/appRenderer.swf"
            }
        }, {
            "id": "f2c89",
            "title": "Overlay",
            "app-id": "app-microsite-launcher",
            "category": "special",
            "app-version": "1.0.0",
            "tooltip": "",
            "data": {
                "width": 90,
                "rolloverTime": 2.5,
                "clickthruURL": null,
                "type": "png",
                "height": 240,
                "uploadType": "unknown",
                "hasClickthru": false,
                "flashFriendly": false,
                "url": "http:\/\/static.innovid.com\/irollapps-upload\/107e80\/3435ee329395b36e68d8b70e4613218c.png",
                "scale": 0.75
            },
            "placeholder": {"type": "floating", "top": 97, "left": 0, "scale": 1, "offsetX": 1.0e-6, "offsetY": 1.0e-6},
            "useIconAsImage": false,
            "customLauncher": null,
            "reporting": {"namespace": "Overlay"},
            "icons": [{
                "url": "http:\/\/cdn.innovid.com\/apps-repository\/common\/icons\/icon_microsite_24x24.png",
                "width": 24,
                "height": 24
            }, {
                "url": "http:\/\/static.innovid.com\/app-library\/uploads\/app-microsite-launcher\/1.0.0\/ad85bc18497e746cd9f181c5c48b452d.png",
                "width": 32,
                "height": 32
            }, {
                "url": "http:\/\/cdn.innovid.com\/apps-repository\/common\/icons\/icon_microsite_48x48.png",
                "width": 48,
                "height": 48
            }, {
                "url": "http:\/\/cdn.innovid.com\/apps-repository\/common\/icons\/icon_microsite_64x64.png",
                "width": 64,
                "height": 64
            }],
            "runtime": {
                "type": "flash",
                "app-renderer": "apps-library:\/\/microsite-launcher",
                "icon-renderer": "apps-library:\/\/microsite-launcher"
            }
        }, {
            "id": "141dkd",
            "title": "Facebook Page",
            "app-id": "app-facebook-page",
            "category": "click-thru",
            "app-version": "1.0.0",
            "tooltip": "Facebook",
            "data": {"clickthruURL": "https:\/\/www.facebook.com\/GinWigmore"},
            "placeholder": {
                "type": "floating",
                "top": 99,
                "left": 99,
                "scale": 1,
                "offsetX": 1.0e-6,
                "offsetY": 1.0e-6
            },
            "useIconAsImage": false,
            "customLauncher": null,
            "reporting": {"namespace": "Facebook Page"},
            "icons": [{
                "url": "http:\/\/static.innovid.com\/app-library\/uploads\/app-facebook-page\/1.0.0\/3505bd9bdc7f51f3db08474e6867dc6f.png",
                "width": 24,
                "height": 24
            }, {
                "url": "http:\/\/static.innovid.com\/app-library\/uploads\/app-facebook-page\/1.0.0\/be642a4b6d8b1ef47e964d1d32bfe11c.png",
                "width": 32,
                "height": 32
            }, {
                "url": "http:\/\/static.innovid.com\/app-library\/uploads\/app-facebook-page\/1.0.0\/eaf71a86fe456a6b0bc8c2fd28029277.png",
                "width": 48,
                "height": 48
            }, {
                "url": "http:\/\/static.innovid.com\/app-library\/uploads\/app-facebook-page\/1.0.0\/f964bd0eff9e4b2f8acf0a594cd558ff.png",
                "width": 64,
                "height": 64
            }],
            "runtime": {
                "type": "flash",
                "app-renderer": "http:\/\/cdn.innovid.com\/apps-repository\/common\/runtimes\/clickthru-1.0.0.swf"
            }
        }],
        "toolbar": {
            "data": {
                "enableMicrositeHighlightEffect": false,
                "engagementType": "minisite",
                "enableSlideInAnimation": true,
                "menuStyle": "Icons Only",
                "position": "bm",
                "useCustomColor": true,
                "showTray": true,
                "showTooltips": true,
                "iconScaling": 0.25,
                "clickBehavior": "open-click-thru",
                "customColor": {"tint": 6710886, "alpha": 0.95, "captionColor": 16777215}
            }
        },
        "video": {
            "url": "http:\/\/static.innovid.com\/media\/encoded\/09_15\/12051\/media_5_400kbs.flv",
            "width": 640,
            "height": 360,
            "duration": 15.116189956665,
            "encodingToken": "GtktXZVcszZtCv_3WXoz2Q",
            "renditions": {
                "iphone_stream": "http:\/\/static.innovid.com\/media\/encoded\/09_15\/12051\/media_5_400kbs.iphone_stream",
                "webm": "http:\/\/static.innovid.com\/media\/encoded\/09_15\/12051\/media_5_400kbs.webm",
                "low.mp4": "http:\/\/static.innovid.com\/media\/encoded\/09_15\/12051\/media_5_400kbs.low.mp4",
                "high.mp4": "http:\/\/static.innovid.com\/media\/encoded\/09_15\/12051\/media_5_400kbs.high.mp4",
                "flv": "http:\/\/static.innovid.com\/media\/encoded\/09_15\/12051\/media_5_400kbs.flv",
                "png": "http:\/\/static.innovid.com\/media\/encoded\/09_15\/12051\/media_5_400kbs.png"
            }
        },
        "defaultLabels": {"videoClick": "Pre-roll.click"},
        "placement-config": {
            "placement-hash": "1hm14o",
            "project-hash": "1hi0hn",
            "client-id": 231,
            "channel-id": 78657,
            "publisher-id": 1228,
            "video-id": 63532,
            "placement-tag-id": 0,
            "project-state": 2,
            "child-manual-project-state": 9,
            "child-auto-project-state": 11,
            "real_estate_id": 96152,
            "hotspot-clicks": [{
                "id": "Facebook Page.clickthru",
                "type": "click-thru",
                "main": "https:\/\/www.facebook.com\/GinWigmore"
            }, {"id": "main", "type": "click-thru", "main": ""}, {
                "id": "Media Gallery.Mobile Main Screen",
                "type": "click-thru",
                "main": "http:\/\/shop.sprint.com\/mysprint\/shop_landing.jsp?pagename=whysprint&plan=unlimited&E"
            }],
            "tracking-events": []
        }
    };
    SCOPE.baseData.config_data = {
        "iconSizes": [24, 32, 48, 64, 128],
        "previewParam": {"width": 500, "height": 281, "iconSize": 32, "trayMargin": 1.05},
        "platformScaling": {"mobile": 1, "tablet": 1, "desktop": 1, "tv": 2},
        "aspectRatio": 1.3,
        "googleMapsApiKey": "AIzaSyAIvRFdH46ZxXWyLgE3_OjsL61tjxCDtS4"
    };

    SCOPE.baseData.cssPath = 'http://static.innovid.com/mobileapps/js/vpaid/1hm14o.css';
    SCOPE.baseData.config_data.mode = 'js';
    SCOPE.baseData.targetElement = 'div#content';
    SCOPE.baseData.appPath = 'http://cdn.innovid.com/m/';
    SCOPE.baseData.servicePath = 'http://c-service.innovid.com';
    SCOPE.baseData.nonCdnServicePath = 'http://service.innovid.com';
    SCOPE.baseData.reportUrl = 'http://s.innovid.com/1x1.gif';
    SCOPE.baseData.errorReportUrl = 'https://s3.amazonaws.com/innovid-iroll-runtime/1x1.gif';
    SCOPE.baseData.runtimeConfigUrl = 'http://static.innovid.com/runtime/iroll-runtime-config.js';
    SCOPE.baseData.mobileCoreVersion = '4.5.1388';

    return SCOPE;

})(IV || {});


/* Zepto v1.1.4 - zepto event ajax form ie - zeptojs.com/license */
var Zepto = function () {
    function L(t) {
        return null == t ? String(t) : j[S.call(t)] || "object"
    }

    function Z(t) {
        return "function" == L(t)
    }

    function $(t) {
        return null != t && t == t.window
    }

    function _(t) {
        return null != t && t.nodeType == t.DOCUMENT_NODE
    }

    function D(t) {
        return "object" == L(t)
    }

    function R(t) {
        return D(t) && !$(t) && Object.getPrototypeOf(t) == Object.prototype
    }

    function M(t) {
        return "number" == typeof t.length
    }

    function k(t) {
        return s.call(t, function (t) {
            return null != t
        })
    }

    function z(t) {
        return t.length > 0 ? n.fn.concat.apply([], t) : t
    }

    function F(t) {
        return t.replace(/::/g, "/").replace(/([A-Z]+)([A-Z][a-z])/g, "$1_$2").replace(/([a-z\d])([A-Z])/g, "$1_$2").replace(/_/g, "-").toLowerCase()
    }

    function q(t) {
        return t in f ? f[t] : f[t] = new RegExp("(^|\\s)" + t + "(\\s|$)")
    }

    function H(t, e) {
        return "number" != typeof e || c[F(t)] ? e : e + "px"
    }

    function I(t) {
        var e, n;
        return u[t] || (e = a.createElement(t), a.body.appendChild(e), n = getComputedStyle(e, "").getPropertyValue("display"), e.parentNode.removeChild(e), "none" == n && (n = "block"), u[t] = n), u[t]
    }

    function V(t) {
        return "children" in t ? o.call(t.children) : n.map(t.childNodes, function (t) {
            return 1 == t.nodeType ? t : void 0
        })
    }

    function B(n, i, r) {
        for (e in i)r && (R(i[e]) || A(i[e])) ? (R(i[e]) && !R(n[e]) && (n[e] = {}), A(i[e]) && !A(n[e]) && (n[e] = []), B(n[e], i[e], r)) : i[e] !== t && (n[e] = i[e])
    }

    function U(t, e) {
        return null == e ? n(t) : n(t).filter(e)
    }

    function J(t, e, n, i) {
        return Z(e) ? e.call(t, n, i) : e
    }

    function X(t, e, n) {
        null == n ? t.removeAttribute(e) : t.setAttribute(e, n)
    }

    function W(e, n) {
        var i = e.className, r = i && i.baseVal !== t;
        return n === t ? r ? i.baseVal : i : void(r ? i.baseVal = n : e.className = n)
    }

    function Y(t) {
        var e;
        try {
            return t ? "true" == t || ("false" == t ? !1 : "null" == t ? null : /^0/.test(t) || isNaN(e = Number(t)) ? /^[\[\{]/.test(t) ? n.parseJSON(t) : t : e) : t
        } catch (i) {
            return t
        }
    }

    function G(t, e) {
        e(t);
        for (var n = 0, i = t.childNodes.length; i > n; n++)G(t.childNodes[n], e)
    }

    var t, e, n, i, C, N, r = [], o = r.slice, s = r.filter, a = window.document, u = {}, f = {}, c = {
        "column-count": 1,
        columns: 1,
        "font-weight": 1,
        "line-height": 1,
        opacity: 1,
        "z-index": 1,
        zoom: 1
    }, l = /^\s*<(\w+|!)[^>]*>/, h = /^<(\w+)\s*\/?>(?:<\/\1>|)$/, p = /<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi, d = /^(?:body|html)$/i, m = /([A-Z])/g, g = ["val", "css", "html", "text", "data", "width", "height", "offset"], v = ["after", "prepend", "before", "append"], y = a.createElement("table"), x = a.createElement("tr"), b = {
        tr: a.createElement("tbody"),
        tbody: y,
        thead: y,
        tfoot: y,
        td: x,
        th: x,
        "*": a.createElement("div")
    }, w = /complete|loaded|interactive/, E = /^[\w-]*$/, j = {}, S = j.toString, T = {}, O = a.createElement("div"), P = {
        tabindex: "tabIndex",
        readonly: "readOnly",
        "for": "htmlFor",
        "class": "className",
        maxlength: "maxLength",
        cellspacing: "cellSpacing",
        cellpadding: "cellPadding",
        rowspan: "rowSpan",
        colspan: "colSpan",
        usemap: "useMap",
        frameborder: "frameBorder",
        contenteditable: "contentEditable"
    }, A = Array.isArray || function (t) {
            return t instanceof Array
        };
    return T.matches = function (t, e) {
        if (!e || !t || 1 !== t.nodeType)return !1;
        var n = t.webkitMatchesSelector || t.mozMatchesSelector || t.oMatchesSelector || t.matchesSelector;
        if (n)return n.call(t, e);
        var i, r = t.parentNode, o = !r;
        return o && (r = O).appendChild(t), i = ~T.qsa(r, e).indexOf(t), o && O.removeChild(t), i
    }, C = function (t) {
        return t.replace(/-+(.)?/g, function (t, e) {
            return e ? e.toUpperCase() : ""
        })
    }, N = function (t) {
        return s.call(t, function (e, n) {
            return t.indexOf(e) == n
        })
    }, T.fragment = function (e, i, r) {
        var s, u, f;
        return h.test(e) && (s = n(a.createElement(RegExp.$1))), s || (e.replace && (e = e.replace(p, "<$1></$2>")), i === t && (i = l.test(e) && RegExp.$1), i in b || (i = "*"), f = b[i], f.innerHTML = "" + e, s = n.each(o.call(f.childNodes), function () {
            f.removeChild(this)
        })), R(r) && (u = n(s), n.each(r, function (t, e) {
            g.indexOf(t) > -1 ? u[t](e) : u.attr(t, e)
        })), s
    }, T.Z = function (t, e) {
        return t = t || [], t.__proto__ = n.fn, t.selector = e || "", t
    }, T.isZ = function (t) {
        return t instanceof T.Z
    }, T.init = function (e, i) {
        var r;
        if (!e)return T.Z();
        if ("string" == typeof e)if (e = e.trim(), "<" == e[0] && l.test(e))r = T.fragment(e, RegExp.$1, i), e = null; else {
            if (i !== t)return n(i).find(e);
            r = T.qsa(a, e)
        } else {
            if (Z(e))return n(a).ready(e);
            if (T.isZ(e))return e;
            if (A(e))r = k(e); else if (D(e))r = [e], e = null; else if (l.test(e))r = T.fragment(e.trim(), RegExp.$1, i), e = null; else {
                if (i !== t)return n(i).find(e);
                r = T.qsa(a, e)
            }
        }
        return T.Z(r, e)
    }, n = function (t, e) {
        return T.init(t, e)
    }, n.extend = function (t) {
        var e, n = o.call(arguments, 1);
        return "boolean" == typeof t && (e = t, t = n.shift()), n.forEach(function (n) {
            B(t, n, e)
        }), t
    }, T.qsa = function (t, e) {
        var n, i = "#" == e[0], r = !i && "." == e[0], s = i || r ? e.slice(1) : e, a = E.test(s);
        return _(t) && a && i ? (n = t.getElementById(s)) ? [n] : [] : 1 !== t.nodeType && 9 !== t.nodeType ? [] : o.call(a && !i ? r ? t.getElementsByClassName(s) : t.getElementsByTagName(e) : t.querySelectorAll(e))
    }, n.contains = a.documentElement.contains ? function (t, e) {
        return t !== e && t.contains(e)
    } : function (t, e) {
        for (; e && (e = e.parentNode);)if (e === t)return !0;
        return !1
    }, n.type = L, n.isFunction = Z, n.isWindow = $, n.isArray = A, n.isPlainObject = R, n.isEmptyObject = function (t) {
        var e;
        for (e in t)return !1;
        return !0
    }, n.inArray = function (t, e, n) {
        return r.indexOf.call(e, t, n)
    }, n.camelCase = C, n.trim = function (t) {
        return null == t ? "" : String.prototype.trim.call(t)
    }, n.uuid = 0, n.support = {}, n.expr = {}, n.map = function (t, e) {
        var n, r, o, i = [];
        if (M(t))for (r = 0; r < t.length; r++)n = e(t[r], r), null != n && i.push(n); else for (o in t)n = e(t[o], o), null != n && i.push(n);
        return z(i)
    }, n.each = function (t, e) {
        var n, i;
        if (M(t)) {
            for (n = 0; n < t.length; n++)if (e.call(t[n], n, t[n]) === !1)return t
        } else for (i in t)if (e.call(t[i], i, t[i]) === !1)return t;
        return t
    }, n.grep = function (t, e) {
        return s.call(t, e)
    }, window.JSON && (n.parseJSON = JSON.parse), n.each("Boolean Number String Function Array Date RegExp Object Error".split(" "), function (t, e) {
        j["[object " + e + "]"] = e.toLowerCase()
    }), n.fn = {
        forEach: r.forEach,
        reduce: r.reduce,
        push: r.push,
        sort: r.sort,
        indexOf: r.indexOf,
        concat: r.concat,
        map: function (t) {
            return n(n.map(this, function (e, n) {
                return t.call(e, n, e)
            }))
        },
        slice: function () {
            return n(o.apply(this, arguments))
        },
        ready: function (t) {
            return w.test(a.readyState) && a.body ? t(n) : a.addEventListener("DOMContentLoaded", function () {
                t(n)
            }, !1), this
        },
        get: function (e) {
            return e === t ? o.call(this) : this[e >= 0 ? e : e + this.length]
        },
        toArray: function () {
            return this.get()
        },
        size: function () {
            return this.length
        },
        remove: function () {
            return this.each(function () {
                null != this.parentNode && this.parentNode.removeChild(this)
            })
        },
        each: function (t) {
            return r.every.call(this, function (e, n) {
                return t.call(e, n, e) !== !1
            }), this
        },
        filter: function (t) {
            return Z(t) ? this.not(this.not(t)) : n(s.call(this, function (e) {
                return T.matches(e, t)
            }))
        },
        add: function (t, e) {
            return n(N(this.concat(n(t, e))))
        },
        is: function (t) {
            return this.length > 0 && T.matches(this[0], t)
        },
        not: function (e) {
            var i = [];
            if (Z(e) && e.call !== t)this.each(function (t) {
                e.call(this, t) || i.push(this)
            }); else {
                var r = "string" == typeof e ? this.filter(e) : M(e) && Z(e.item) ? o.call(e) : n(e);
                this.forEach(function (t) {
                    r.indexOf(t) < 0 && i.push(t)
                })
            }
            return n(i)
        },
        has: function (t) {
            return this.filter(function () {
                return D(t) ? n.contains(this, t) : n(this).find(t).size()
            })
        },
        eq: function (t) {
            return -1 === t ? this.slice(t) : this.slice(t, +t + 1)
        },
        first: function () {
            var t = this[0];
            return t && !D(t) ? t : n(t)
        },
        last: function () {
            var t = this[this.length - 1];
            return t && !D(t) ? t : n(t)
        },
        find: function (t) {
            var e, i = this;
            return e = t ? "object" == typeof t ? n(t).filter(function () {
                var t = this;
                return r.some.call(i, function (e) {
                    return n.contains(e, t)
                })
            }) : 1 == this.length ? n(T.qsa(this[0], t)) : this.map(function () {
                return T.qsa(this, t)
            }) : []
        },
        closest: function (t, e) {
            var i = this[0], r = !1;
            for ("object" == typeof t && (r = n(t)); i && !(r ? r.indexOf(i) >= 0 : T.matches(i, t));)i = i !== e && !_(i) && i.parentNode;
            return n(i)
        },
        parents: function (t) {
            for (var e = [], i = this; i.length > 0;)i = n.map(i, function (t) {
                return (t = t.parentNode) && !_(t) && e.indexOf(t) < 0 ? (e.push(t), t) : void 0
            });
            return U(e, t)
        },
        parent: function (t) {
            return U(N(this.pluck("parentNode")), t)
        },
        children: function (t) {
            return U(this.map(function () {
                return V(this)
            }), t)
        },
        contents: function () {
            return this.map(function () {
                return o.call(this.childNodes)
            })
        },
        siblings: function (t) {
            return U(this.map(function (t, e) {
                return s.call(V(e.parentNode), function (t) {
                    return t !== e
                })
            }), t)
        },
        empty: function () {
            return this.each(function () {
                this.innerHTML = ""
            })
        },
        pluck: function (t) {
            return n.map(this, function (e) {
                return e[t]
            })
        },
        show: function () {
            return this.each(function () {
                "none" == this.style.display && (this.style.display = ""), "none" == (getComputedStyle(this, "") ? getComputedStyle(this, "").getPropertyValue("display") : "") && (this.style.display = I(this.nodeName))
            })
        },
        replaceWith: function (t) {
            return this.before(t).remove()
        },
        wrap: function (t) {
            var e = Z(t);
            if (this[0] && !e)var i = n(t).get(0), r = i.parentNode || this.length > 1;
            return this.each(function (o) {
                n(this).wrapAll(e ? t.call(this, o) : r ? i.cloneNode(!0) : i)
            })
        },
        wrapAll: function (t) {
            if (this[0]) {
                n(this[0]).before(t = n(t));
                for (var e; (e = t.children()).length;)t = e.first();
                n(t).append(this)
            }
            return this
        },
        wrapInner: function (t) {
            var e = Z(t);
            return this.each(function (i) {
                var r = n(this), o = r.contents(), s = e ? t.call(this, i) : t;
                o.length ? o.wrapAll(s) : r.append(s)
            })
        },
        unwrap: function () {
            return this.parent().each(function () {
                n(this).replaceWith(n(this).children())
            }), this
        },
        clone: function () {
            return this.map(function () {
                return this.cloneNode(!0)
            })
        },
        hide: function () {
            return this.css("display", "none")
        },
        toggle: function (e) {
            return this.each(function () {
                var i = n(this);
                (e === t ? "none" == i.css("display") : e) ? i.show() : i.hide()
            })
        },
        prev: function (t) {
            return n(this.pluck("previousElementSibling")).filter(t || "*")
        },
        next: function (t) {
            return n(this.pluck("nextElementSibling")).filter(t || "*")
        },
        html: function (t) {
            return 0 in arguments ? this.each(function (e) {
                var i = this.innerHTML;
                n(this).empty().append(J(this, t, e, i))
            }) : 0 in this ? this[0].innerHTML : null
        },
        text: function (t) {
            return 0 in arguments ? this.each(function (e) {
                var n = J(this, t, e, this.textContent);
                this.textContent = null == n ? "" : "" + n
            }) : 0 in this ? this[0].textContent : null
        },
        attr: function (n, i) {
            var r;
            return "string" != typeof n || 1 in arguments ? this.each(function (t) {
                if (1 === this.nodeType)if (D(n))for (e in n)X(this, e, n[e]); else X(this, n, J(this, i, t, this.getAttribute(n)))
            }) : this.length && 1 === this[0].nodeType ? !(r = this[0].getAttribute(n)) && n in this[0] ? this[0][n] : r : t
        },
        removeAttr: function (t) {
            return this.each(function () {
                1 === this.nodeType && X(this, t)
            })
        },
        prop: function (t, e) {
            return t = P[t] || t, 1 in arguments ? this.each(function (n) {
                this[t] = J(this, e, n, this[t])
            }) : this[0] && this[0][t]
        },
        data: function (e, n) {
            var i = "data-" + e.replace(m, "-$1").toLowerCase(), r = 1 in arguments ? this.attr(i, n) : this.attr(i);
            return null !== r ? Y(r) : t
        },
        val: function (t) {
            return 0 in arguments ? this.each(function (e) {
                this.value = J(this, t, e, this.value)
            }) : this[0] && (this[0].multiple ? n(this[0]).find("option").filter(function () {
                return this.selected
            }).pluck("value") : this[0].value)
        },
        offset: function (t) {
            if (t)return this.each(function (e) {
                var i = n(this), r = J(this, t, e, i.offset()), o = i.offsetParent().offset(), s = {
                    top: r.top - o.top,
                    left: r.left - o.left
                };
                "static" == i.css("position") && (s.position = "relative"), i.css(s)
            });
            if (!this.length)return null;
            var e;
            try {
                e = this[0].getBoundingClientRect()
            } catch (ex) {
                e = {left: 0, top: 0, width: 0, height: 0}
            }
            ;
            return {
                left: e.left + window.pageXOffset,
                top: e.top + window.pageYOffset,
                width: Math.round(e.width),
                height: Math.round(e.height)
            }
        },
        css: function (t, i) {
            if (arguments.length < 2) {
                var r = this[0], o = getComputedStyle(r, "");
                if (!r)return;
                if ("string" == typeof t)return r.style[C(t)] || o.getPropertyValue(t);
                if (A(t)) {
                    var s = {};
                    return n.each(A(t) ? t : [t], function (t, e) {
                        s[e] = r.style[C(e)] || o.getPropertyValue(e)
                    }), s
                }
            }
            var a = "";
            if ("string" == L(t))i || 0 === i ? a = F(t) + ":" + H(t, i) : this.each(function () {
                this.style.removeProperty(F(t))
            }); else for (e in t)t[e] || 0 === t[e] ? a += F(e) + ":" + H(e, t[e]) + ";" : this.each(function () {
                this.style.removeProperty(F(e))
            });
            return this.each(function () {
                this.style.cssText += ";" + a
            })
        },
        index: function (t) {
            return t ? this.indexOf(n(t)[0]) : this.parent().children().indexOf(this[0])
        },
        hasClass: function (t) {
            return t ? r.some.call(this, function (t) {
                return this.test(W(t))
            }, q(t)) : !1
        },
        addClass: function (t) {
            return t ? this.each(function (e) {
                i = [];
                var r = W(this), o = J(this, t, e, r);
                o.split(/\s+/g).forEach(function (t) {
                    n(this).hasClass(t) || i.push(t)
                }, this), i.length && W(this, r + (r ? " " : "") + i.join(" "))
            }) : this
        },
        removeClass: function (e) {
            return this.each(function (n) {
                return e === t ? W(this, "") : (i = W(this), J(this, e, n, i).split(/\s+/g).forEach(function (t) {
                    i = i.replace(q(t), " ")
                }), void W(this, i.trim()))
            })
        },
        toggleClass: function (e, i) {
            return e ? this.each(function (r) {
                var o = n(this), s = J(this, e, r, W(this));
                s.split(/\s+/g).forEach(function (e) {
                    (i === t ? !o.hasClass(e) : i) ? o.addClass(e) : o.removeClass(e)
                })
            }) : this
        },
        scrollTop: function (e) {
            if (this.length) {
                var n = "scrollTop" in this[0];
                return e === t ? n ? this[0].scrollTop : this[0].pageYOffset : this.each(n ? function () {
                    this.scrollTop = e
                } : function () {
                    this.scrollTo(this.scrollX, e)
                })
            }
        },
        scrollLeft: function (e) {
            if (this.length) {
                var n = "scrollLeft" in this[0];
                return e === t ? n ? this[0].scrollLeft : this[0].pageXOffset : this.each(n ? function () {
                    this.scrollLeft = e
                } : function () {
                    this.scrollTo(e, this.scrollY)
                })
            }
        },
        position: function () {
            if (this.length) {
                var t = this[0], e = this.offsetParent(), i = this.offset(), r = d.test(e[0].nodeName) ? {
                    top: 0,
                    left: 0
                } : e.offset();
                return i.top -= parseFloat(n(t).css("margin-top")) || 0, i.left -= parseFloat(n(t).css("margin-left")) || 0, r.top += parseFloat(n(e[0]).css("border-top-width")) || 0, r.left += parseFloat(n(e[0]).css("border-left-width")) || 0, {
                    top: i.top - r.top,
                    left: i.left - r.left
                }
            }
        },
        offsetParent: function () {
            return this.map(function () {
                for (var t = this.offsetParent || a.body; t && !d.test(t.nodeName) && "static" == n(t).css("position");)t = t.offsetParent;
                return t
            })
        }
    }, n.fn.detach = n.fn.remove, ["width", "height"].forEach(function (e) {
        var i = e.replace(/./, function (t) {
            return t[0].toUpperCase()
        });
        n.fn[e] = function (r) {
            var o, s = this[0];
            return r === t ? $(s) ? s["inner" + i] : _(s) ? s.documentElement["scroll" + i] : (o = this.offset()) && o[e] : this.each(function (t) {
                s = n(this), s.css(e, J(this, r, t, s[e]()))
            })
        }
    }), v.forEach(function (t, e) {
        var i = e % 2;
        n.fn[t] = function () {
            var t, o, r = n.map(arguments, function (e) {
                return t = L(e), "object" == t || "array" == t || null == e ? e : T.fragment(e)
            }), s = this.length > 1;
            return r.length < 1 ? this : this.each(function (t, u) {
                o = i ? u : u.parentNode, u = 0 == e ? u.nextSibling : 1 == e ? u.firstChild : 2 == e ? u : null;
                var f = n.contains(a.documentElement, o);
                r.forEach(function (t) {
                    if (s)t = t.cloneNode(!0); else if (!o)return n(t).remove();
                    o.insertBefore(t, u), f && G(t, function (t) {
                        null == t.nodeName || "SCRIPT" !== t.nodeName.toUpperCase() || t.type && "text/javascript" !== t.type || t.src || window.eval.call(window, t.innerHTML)
                    })
                })
            })
        }, n.fn[i ? t + "To" : "insert" + (e ? "Before" : "After")] = function (e) {
            return n(e)[t](this), this
        }
    }), T.Z.prototype = n.fn, T.uniq = N, T.deserializeValue = Y, n.zepto = T, n
}();
window.Zepto = Zepto, void 0 === window.$ && (window.$ = Zepto), function (t) {
    function l(t) {
        return t._zid || (t._zid = e++)
    }

    function h(t, e, n, i) {
        if (e = p(e), e.ns)var r = d(e.ns);
        return (s[l(t)] || []).filter(function (t) {
            return !(!t || e.e && t.e != e.e || e.ns && !r.test(t.ns) || n && l(t.fn) !== l(n) || i && t.sel != i)
        })
    }

    function p(t) {
        var e = ("" + t).split(".");
        return {e: e[0], ns: e.slice(1).sort().join(" ")}
    }

    function d(t) {
        return new RegExp("(?:^| )" + t.replace(" ", " .* ?") + "(?: |$)")
    }

    function m(t, e) {
        return t.del && !u && t.e in f || !!e
    }

    function g(t) {
        return c[t] || u && f[t] || t
    }

    function v(e, i, r, o, a, u, f) {
        var h = l(e), d = s[h] || (s[h] = []);
        i.split(/\s/).forEach(function (i) {
            if ("ready" == i)return t(document).ready(r);
            var s = p(i);
            s.fn = r, s.sel = a, s.e in c && (r = function (e) {
                var n = e.relatedTarget;
                return !n || n !== this && !t.contains(this, n) ? s.fn.apply(this, arguments) : void 0
            }), s.del = u;
            var l = u || r;
            s.proxy = function (t) {
                if (t = j(t), !t.isImmediatePropagationStopped()) {
                    t.data = o;
                    var i = l.apply(e, t._args == n ? [t] : [t].concat(t._args));
                    return i === !1 && (t.preventDefault(), t.stopPropagation()), i
                }
            }, s.i = d.length, d.push(s), "addEventListener" in e && e.addEventListener(g(s.e), s.proxy, m(s, f))
        })
    }

    function y(t, e, n, i, r) {
        var o = l(t);
        (e || "").split(/\s/).forEach(function (e) {
            h(t, e, n, i).forEach(function (e) {
                delete s[o][e.i], "removeEventListener" in t && t.removeEventListener(g(e.e), e.proxy, m(e, r))
            })
        })
    }

    function j(e, i) {
        return (i || !e.isDefaultPrevented) && (i || (i = e), t.each(E, function (t, n) {
            var r = i[t];
            e[t] = function () {
                return this[n] = x, r && r.apply(i, arguments)
            }, e[n] = b
        }), (i.defaultPrevented !== n ? i.defaultPrevented : "returnValue" in i ? i.returnValue === !1 : i.getPreventDefault && i.getPreventDefault()) && (e.isDefaultPrevented = x)), e
    }

    function S(t) {
        var e, i = {originalEvent: t};
        for (e in t)w.test(e) || t[e] === n || (i[e] = t[e]);
        return j(i, t)
    }

    var n, e = 1, i = Array.prototype.slice, r = t.isFunction, o = function (t) {
        return "string" == typeof t
    }, s = {}, a = {}, u = "onfocusin" in window, f = {
        focus: "focusin",
        blur: "focusout"
    }, c = {mouseenter: "mouseover", mouseleave: "mouseout"};
    a.click = a.mousedown = a.mouseup = a.mousemove = "MouseEvents", t.event = {
        add: v,
        remove: y
    }, t.proxy = function (e, n) {
        var s = 2 in arguments && i.call(arguments, 2);
        if (r(e)) {
            var a = function () {
                return e.apply(n, s ? s.concat(i.call(arguments)) : arguments)
            };
            return a._zid = l(e), a
        }
        if (o(n))return s ? (s.unshift(e[n], e), t.proxy.apply(null, s)) : t.proxy(e[n], e);
        throw new TypeError("expected function")
    }, t.fn.bind = function (t, e, n) {
        return this.on(t, e, n)
    }, t.fn.unbind = function (t, e) {
        return this.off(t, e)
    }, t.fn.one = function (t, e, n, i) {
        return this.on(t, e, n, i, 1)
    };
    var x = function () {
        return !0
    }, b = function () {
        return !1
    }, w = /^([A-Z]|returnValue$|layer[XY]$)/, E = {
        preventDefault: "isDefaultPrevented",
        stopImmediatePropagation: "isImmediatePropagationStopped",
        stopPropagation: "isPropagationStopped"
    };
    t.fn.delegate = function (t, e, n) {
        return this.on(e, t, n)
    }, t.fn.undelegate = function (t, e, n) {
        return this.off(e, t, n)
    }, t.fn.live = function (e, n) {
        return t(document.body).delegate(this.selector, e, n), this
    }, t.fn.die = function (e, n) {
        return t(document.body).undelegate(this.selector, e, n), this
    }, t.fn.on = function (e, s, a, u, f) {
        var c, l, h = this;
        return e && !o(e) ? (t.each(e, function (t, e) {
            h.on(t, s, a, e, f)
        }), h) : (o(s) || r(u) || u === !1 || (u = a, a = s, s = n), (r(a) || a === !1) && (u = a, a = n), u === !1 && (u = b), h.each(function (n, r) {
            f && (c = function (t) {
                return y(r, t.type, u), u.apply(this, arguments)
            }), s && (l = function (e) {
                var n, o = t(e.target).closest(s, r).get(0);
                return o && o !== r ? (n = t.extend(S(e), {
                    currentTarget: o,
                    liveFired: r
                }), (c || u).apply(o, [n].concat(i.call(arguments, 1)))) : void 0
            }), v(r, e, u, a, s, l || c)
        }))
    }, t.fn.off = function (e, i, s) {
        var a = this;
        return e && !o(e) ? (t.each(e, function (t, e) {
            a.off(t, i, e)
        }), a) : (o(i) || r(s) || s === !1 || (s = i, i = n), s === !1 && (s = b), a.each(function () {
            y(this, e, s, i)
        }))
    }, t.fn.trigger = function (e, n) {
        return e = o(e) || t.isPlainObject(e) ? t.Event(e) : j(e), e._args = n, this.each(function () {
            "dispatchEvent" in this ? this.dispatchEvent(e) : t(this).triggerHandler(e, n)
        })
    }, t.fn.triggerHandler = function (e, n) {
        var i, r;
        return this.each(function (s, a) {
            i = S(o(e) ? t.Event(e) : e), i._args = n, i.target = a, t.each(h(a, e.type || e), function (t, e) {
                return r = e.proxy(i), i.isImmediatePropagationStopped() ? !1 : void 0
            })
        }), r
    }, "focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select keydown keypress keyup error".split(" ").forEach(function (e) {
        t.fn[e] = function (t) {
            return t ? this.bind(e, t) : this.trigger(e)
        }
    }), ["focus", "blur"].forEach(function (e) {
        t.fn[e] = function (t) {
            return t ? this.bind(e, t) : this.each(function () {
                try {
                    this[e]()
                } catch (t) {
                }
            }), this
        }
    }), t.Event = function (t, e) {
        o(t) || (e = t, t = e.type);
        var n = document.createEvent(a[t] || "Events"), i = !0;
        if (e)for (var r in e)"bubbles" == r ? i = !!e[r] : n[r] = e[r];
        return n.initEvent(t, i, !0), j(n)
    }
}(Zepto), function (t) {
    function l(e, n, i) {
        var r = t.Event(n);
        return t(e).trigger(r, i), !r.isDefaultPrevented()
    }

    function h(t, e, i, r) {
        return t.global ? l(e || n, i, r) : void 0
    }

    function p(e) {
        e.global && 0 === t.active++ && h(e, null, "ajaxStart")
    }

    function d(e) {
        e.global && !--t.active && h(e, null, "ajaxStop")
    }

    function m(t, e) {
        var n = e.context;
        return e.beforeSend.call(n, t, e) === !1 || h(e, n, "ajaxBeforeSend", [t, e]) === !1 ? !1 : void h(e, n, "ajaxSend", [t, e])
    }

    function g(t, e, n, i) {
        var r = n.context, o = "success";
        n.success.call(r, t, o, e), i && i.resolveWith(r, [t, o, e]), h(n, r, "ajaxSuccess", [e, n, t]), y(o, e, n)
    }

    function v(t, e, n, i, r) {
        var o = i.context;
        i.error.call(o, n, e, t), r && r.rejectWith(o, [n, e, t]), h(i, o, "ajaxError", [n, i, t || e]), y(e, n, i)
    }

    function y(t, e, n) {
        var i = n.context;
        n.complete.call(i, e, t), h(n, i, "ajaxComplete", [e, n]), d(n)
    }

    function x() {
    }

    function b(t) {
        return t && (t = t.split(";", 2)[0]), t && (t == f ? "html" : t == u ? "json" : s.test(t) ? "script" : a.test(t) && "xml") || "text"
    }

    function w(t, e) {
        return "" == e ? t : (t + "&" + e).replace(/[&?]{1,2}/, "?")
    }

    function E(e) {
        e.processData && e.data && "string" != t.type(e.data) && (e.data = t.param(e.data, e.traditional)), !e.data || e.type && "GET" != e.type.toUpperCase() || (e.url = w(e.url, e.data), e.data = void 0)
    }

    function j(e, n, i, r) {
        return t.isFunction(n) && (r = i, i = n, n = void 0), t.isFunction(i) || (r = i, i = void 0), {
            url: e,
            data: n,
            success: i,
            dataType: r
        }
    }

    function T(e, n, i, r) {
        var o, s = t.isArray(n), a = t.isPlainObject(n);
        t.each(n, function (n, u) {
            o = t.type(u), r && (n = i ? r : r + "[" + (a || "object" == o || "array" == o ? n : "") + "]"), !r && s ? e.add(u.name, u.value) : "array" == o || !i && "object" == o ? T(e, u, i, n) : e.add(n, u)
        })
    }

    var i, r, e = 0, n = window.document, o = /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, s = /^(?:text|application)\/javascript/i, a = /^(?:text|application)\/xml/i, u = "application/json", f = "text/html", c = /^\s*$/;
    t.active = 0, t.ajaxJSONP = function (i, r) {
        if (!("type" in i))return t.ajax(i);
        var f, h, o = i.jsonpCallback, s = (t.isFunction(o) ? o() : o) || "jsonp" + ++e, a = n.createElement("script"), u = window[s], c = function (e) {
            t(a).triggerHandler("error", e || "abort")
        }, l = {abort: c};
        return r && r.promise(l), t(a).on("load error", function (e, n) {
            clearTimeout(h), t(a).off().remove(), "error" != e.type && f ? g(f[0], l, i, r) : v(null, n || "error", l, i, r), window[s] = u, f && t.isFunction(u) && u(f[0]), u = f = void 0
        }), m(l, i) === !1 ? (c("abort"), l) : (window[s] = function () {
            f = arguments
        }, a.src = i.url.replace(/\?(.+)=\?/, "?$1=" + s), n.head.appendChild(a), i.timeout > 0 && (h = setTimeout(function () {
            c("timeout")
        }, i.timeout)), l)
    }, t.ajaxSettings = {
        type: "GET",
        beforeSend: x,
        success: x,
        error: x,
        complete: x,
        context: null,
        global: !0,
        xhr: function () {
            return new window.XMLHttpRequest
        },
        accepts: {
            script: "text/javascript, application/javascript, application/x-javascript",
            json: u,
            xml: "application/xml, text/xml",
            html: f,
            text: "text/plain"
        },
        crossDomain: !1,
        timeout: 0,
        processData: !0,
        cache: !0
    }, t.ajax = function (e) {
        var n = t.extend({}, e || {}), o = t.Deferred && t.Deferred();
        for (i in t.ajaxSettings)void 0 === n[i] && (n[i] = t.ajaxSettings[i]);
        p(n), n.crossDomain || (n.crossDomain = /^([\w-]+:)?\/\/([^\/]+)/.test(n.url) && RegExp.$2 != window.location.host), n.url || (n.url = window.location.toString()), E(n);
        var s = n.dataType, a = /\?.+=\?/.test(n.url);
        if (a && (s = "jsonp"), n.cache !== !1 && (e && e.cache === !0 || "script" != s && "jsonp" != s) || (n.url = w(n.url, "_=" + Date.now())), "jsonp" == s)return a || (n.url = w(n.url, n.jsonp ? n.jsonp + "=?" : n.jsonp === !1 ? "" : "callback=?")), t.ajaxJSONP(n, o);
        var j, u = n.accepts[s], f = {}, l = function (t, e) {
            f[t.toLowerCase()] = [t, e]
        }, h = /^([\w-]+:)\/\//.test(n.url) ? RegExp.$1 : window.location.protocol, d = n.xhr(), y = d.setRequestHeader;
        if (o && o.promise(d), n.crossDomain || l("X-Requested-With", "XMLHttpRequest"), l("Accept", u || "*/*"), (u = n.mimeType || u) && (u.indexOf(",") > -1 && (u = u.split(",", 2)[0]), d.overrideMimeType && d.overrideMimeType(u)), (n.contentType || n.contentType !== !1 && n.data && "GET" != n.type.toUpperCase()) && l("Content-Type", n.contentType || "application/x-www-form-urlencoded"), n.headers)for (r in n.headers)l(r, n.headers[r]);
        if (d.setRequestHeader = l, d.onreadystatechange = function () {
                if (4 == d.readyState) {
                    d.onreadystatechange = x, clearTimeout(j);
                    var e, i = !1;
                    if (d.status >= 200 && d.status < 300 || 304 == d.status || 0 == d.status && "file:" == h) {
                        s = s || b(n.mimeType || d.getResponseHeader("content-type")), e = d.responseText;
                        try {
                            "script" == s ? (1, eval)(e) : "xml" == s ? e = d.responseXML : "json" == s && (e = c.test(e) ? null : t.parseJSON(e))
                        } catch (r) {
                            i = r
                        }
                        i ? v(i, "parsererror", d, n, o) : g(e, d, n, o)
                    } else v(d.statusText || null, d.status ? "error" : "abort", d, n, o)
                }
            }, m(d, n) === !1)return d.abort(), v(null, "abort", d, n, o), d;
        if (n.xhrFields)for (r in n.xhrFields)d[r] = n.xhrFields[r];
        var S = "async" in n ? n.async : !0;
        d.open(n.type, n.url, S, n.username, n.password);
        for (r in f)y.apply(d, f[r]);
        return n.timeout > 0 && (j = setTimeout(function () {
            d.onreadystatechange = x, d.abort(), v(null, "timeout", d, n, o)
        }, n.timeout)), d.send(n.data ? n.data : null), d
    }, t.get = function () {
        return t.ajax(j.apply(null, arguments))
    }, t.post = function () {
        var e = j.apply(null, arguments);
        return e.type = "POST", t.ajax(e)
    }, t.getJSON = function () {
        var e = j.apply(null, arguments);
        return e.dataType = "json", t.ajax(e)
    }, t.fn.load = function (e, n, i) {
        if (!this.length)return this;
        var a, r = this, s = e.split(/\s/), u = j(e, n, i), f = u.success;
        return s.length > 1 && (u.url = s[0], a = s[1]), u.success = function (e) {
            r.html(a ? t("<div>").html(e.replace(o, "")).find(a) : e), f && f.apply(r, arguments)
        }, t.ajax(u), this
    };
    var S = encodeURIComponent;
    t.param = function (t, e) {
        var n = [];
        return n.add = function (t, e) {
            this.push(S(t) + "=" + S(e))
        }, T(n, t, e), n.join("&").replace(/%20/g, "+")
    }
}(Zepto), function (t) {
    t.fn.serializeArray = function () {
        var n, e = [];
        return t([].slice.call(this.get(0).elements)).each(function () {
            n = t(this);
            var i = n.attr("type");
            "fieldset" != this.nodeName.toLowerCase() && !this.disabled && "submit" != i && "reset" != i && "button" != i && ("radio" != i && "checkbox" != i || this.checked) && e.push({
                name: n.attr("name"),
                value: n.val()
            })
        }), e
    }, t.fn.serialize = function () {
        var t = [];
        return this.serializeArray().forEach(function (e) {
            t.push(encodeURIComponent(e.name) + "=" + encodeURIComponent(e.value))
        }), t.join("&")
    }, t.fn.submit = function (e) {
        if (e)this.bind("submit", e); else if (this.length) {
            var n = t.Event("submit");
            this.eq(0).trigger(n), n.isDefaultPrevented() || this.get(0).submit()
        }
        return this
    }
}(Zepto), function (t) {
    "__proto__" in {} || t.extend(t.zepto, {
        Z: function (e, n) {
            return e = e || [], t.extend(e, t.fn), e.selector = n || "", e.__Z = !0, e
        }, isZ: function (e) {
            return "array" === t.type(e) && "__Z" in e
        }
    });
    try {
        getComputedStyle(void 0)
    } catch (e) {
        var n = getComputedStyle;
        window.getComputedStyle = function (t) {
            try {
                return n(t)
            } catch (e) {
                return null
            }
        }
    }
}(Zepto);

//     Underscore.js 1.7.0
//     http://underscorejs.org
//     (c) 2009-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.
(function () {
    var n = this, t = n._, r = Array.prototype, e = Object.prototype, u = Function.prototype, i = r.push, a = r.slice, o = r.concat, l = e.toString, c = e.hasOwnProperty, f = Array.isArray, s = Object.keys, p = u.bind, h = function (n) {
        return n instanceof h ? n : this instanceof h ? void(this._wrapped = n) : new h(n)
    };
    "undefined" != typeof exports ? ("undefined" != typeof module && module.exports && (exports = module.exports = h), exports._ = h) : n._ = h, h.VERSION = "1.7.0";
    var g = function (n, t, r) {
        if (t === void 0)return n;
        switch (null == r ? 3 : r) {
            case 1:
                return function (r) {
                    return n.call(t, r)
                };
            case 2:
                return function (r, e) {
                    return n.call(t, r, e)
                };
            case 3:
                return function (r, e, u) {
                    return n.call(t, r, e, u)
                };
            case 4:
                return function (r, e, u, i) {
                    return n.call(t, r, e, u, i)
                }
        }
        return function () {
            return n.apply(t, arguments)
        }
    };
    h.iteratee = function (n, t, r) {
        return null == n ? h.identity : h.isFunction(n) ? g(n, t, r) : h.isObject(n) ? h.matches(n) : h.property(n)
    }, h.each = h.forEach = function (n, t, r) {
        if (null == n)return n;
        t = g(t, r);
        var e, u = n.length;
        if (u === +u)for (e = 0; u > e; e++)t(n[e], e, n); else {
            var i = h.keys(n);
            for (e = 0, u = i.length; u > e; e++)t(n[i[e]], i[e], n)
        }
        return n
    }, h.map = h.collect = function (n, t, r) {
        if (null == n)return [];
        t = h.iteratee(t, r);
        for (var e, u = n.length !== +n.length && h.keys(n), i = (u || n).length, a = Array(i), o = 0; i > o; o++)e = u ? u[o] : o, a[o] = t(n[e], e, n);
        return a
    };
    var v = "Reduce of empty array with no initial value";
    h.reduce = h.foldl = h.inject = function (n, t, r, e) {
        null == n && (n = []), t = g(t, e, 4);
        var u, i = n.length !== +n.length && h.keys(n), a = (i || n).length, o = 0;
        if (arguments.length < 3) {
            if (!a)throw new TypeError(v);
            r = n[i ? i[o++] : o++]
        }
        for (; a > o; o++)u = i ? i[o] : o, r = t(r, n[u], u, n);
        return r
    }, h.reduceRight = h.foldr = function (n, t, r, e) {
        null == n && (n = []), t = g(t, e, 4);
        var u, i = n.length !== +n.length && h.keys(n), a = (i || n).length;
        if (arguments.length < 3) {
            if (!a)throw new TypeError(v);
            r = n[i ? i[--a] : --a]
        }
        for (; a--;)u = i ? i[a] : a, r = t(r, n[u], u, n);
        return r
    }, h.find = h.detect = function (n, t, r) {
        var e;
        return t = h.iteratee(t, r), h.some(n, function (n, r, u) {
            return t(n, r, u) ? (e = n, !0) : void 0
        }), e
    }, h.filter = h.select = function (n, t, r) {
        var e = [];
        return null == n ? e : (t = h.iteratee(t, r), h.each(n, function (n, r, u) {
            t(n, r, u) && e.push(n)
        }), e)
    }, h.reject = function (n, t, r) {
        return h.filter(n, h.negate(h.iteratee(t)), r)
    }, h.every = h.all = function (n, t, r) {
        if (null == n)return !0;
        t = h.iteratee(t, r);
        var e, u, i = n.length !== +n.length && h.keys(n), a = (i || n).length;
        for (e = 0; a > e; e++)if (u = i ? i[e] : e, !t(n[u], u, n))return !1;
        return !0
    }, h.some = h.any = function (n, t, r) {
        if (null == n)return !1;
        t = h.iteratee(t, r);
        var e, u, i = n.length !== +n.length && h.keys(n), a = (i || n).length;
        for (e = 0; a > e; e++)if (u = i ? i[e] : e, t(n[u], u, n))return !0;
        return !1
    }, h.contains = h.include = function (n, t) {
        return null == n ? !1 : (n.length !== +n.length && (n = h.values(n)), h.indexOf(n, t) >= 0)
    }, h.invoke = function (n, t) {
        var r = a.call(arguments, 2), e = h.isFunction(t);
        return h.map(n, function (n) {
            return (e ? t : n[t]).apply(n, r)
        })
    }, h.pluck = function (n, t) {
        return h.map(n, h.property(t))
    }, h.where = function (n, t) {
        return h.filter(n, h.matches(t))
    }, h.findWhere = function (n, t) {
        return h.find(n, h.matches(t))
    }, h.max = function (n, t, r) {
        var e, u, i = -1 / 0, a = -1 / 0;
        if (null == t && null != n) {
            n = n.length === +n.length ? n : h.values(n);
            for (var o = 0, l = n.length; l > o; o++)e = n[o], e > i && (i = e)
        } else t = h.iteratee(t, r), h.each(n, function (n, r, e) {
            u = t(n, r, e), (u > a || u === -1 / 0 && i === -1 / 0) && (i = n, a = u)
        });
        return i
    }, h.min = function (n, t, r) {
        var e, u, i = 1 / 0, a = 1 / 0;
        if (null == t && null != n) {
            n = n.length === +n.length ? n : h.values(n);
            for (var o = 0, l = n.length; l > o; o++)e = n[o], i > e && (i = e)
        } else t = h.iteratee(t, r), h.each(n, function (n, r, e) {
            u = t(n, r, e), (a > u || 1 / 0 === u && 1 / 0 === i) && (i = n, a = u)
        });
        return i
    }, h.shuffle = function (n) {
        for (var t, r = n && n.length === +n.length ? n : h.values(n), e = r.length, u = Array(e), i = 0; e > i; i++)t = h.random(0, i), t !== i && (u[i] = u[t]), u[t] = r[i];
        return u
    }, h.sample = function (n, t, r) {
        return null == t || r ? (n.length !== +n.length && (n = h.values(n)), n[h.random(n.length - 1)]) : h.shuffle(n).slice(0, Math.max(0, t))
    }, h.sortBy = function (n, t, r) {
        return t = h.iteratee(t, r), h.pluck(h.map(n, function (n, r, e) {
            return {value: n, index: r, criteria: t(n, r, e)}
        }).sort(function (n, t) {
            var r = n.criteria, e = t.criteria;
            if (r !== e) {
                if (r > e || r === void 0)return 1;
                if (e > r || e === void 0)return -1
            }
            return n.index - t.index
        }), "value")
    };
    var m = function (n) {
        return function (t, r, e) {
            var u = {};
            return r = h.iteratee(r, e), h.each(t, function (e, i) {
                var a = r(e, i, t);
                n(u, e, a)
            }), u
        }
    };
    h.groupBy = m(function (n, t, r) {
        h.has(n, r) ? n[r].push(t) : n[r] = [t]
    }), h.indexBy = m(function (n, t, r) {
        n[r] = t
    }), h.countBy = m(function (n, t, r) {
        h.has(n, r) ? n[r]++ : n[r] = 1
    }), h.sortedIndex = function (n, t, r, e) {
        r = h.iteratee(r, e, 1);
        for (var u = r(t), i = 0, a = n.length; a > i;) {
            var o = i + a >>> 1;
            r(n[o]) < u ? i = o + 1 : a = o
        }
        return i
    }, h.toArray = function (n) {
        return n ? h.isArray(n) ? a.call(n) : n.length === +n.length ? h.map(n, h.identity) : h.values(n) : []
    }, h.size = function (n) {
        return null == n ? 0 : n.length === +n.length ? n.length : h.keys(n).length
    }, h.partition = function (n, t, r) {
        t = h.iteratee(t, r);
        var e = [], u = [];
        return h.each(n, function (n, r, i) {
            (t(n, r, i) ? e : u).push(n)
        }), [e, u]
    }, h.first = h.head = h.take = function (n, t, r) {
        return null == n ? void 0 : null == t || r ? n[0] : 0 > t ? [] : a.call(n, 0, t)
    }, h.initial = function (n, t, r) {
        return a.call(n, 0, Math.max(0, n.length - (null == t || r ? 1 : t)))
    }, h.last = function (n, t, r) {
        return null == n ? void 0 : null == t || r ? n[n.length - 1] : a.call(n, Math.max(n.length - t, 0))
    }, h.rest = h.tail = h.drop = function (n, t, r) {
        return a.call(n, null == t || r ? 1 : t)
    }, h.compact = function (n) {
        return h.filter(n, h.identity)
    };
    var y = function (n, t, r, e) {
        if (t && h.every(n, h.isArray))return o.apply(e, n);
        for (var u = 0, a = n.length; a > u; u++) {
            var l = n[u];
            h.isArray(l) || h.isArguments(l) ? t ? i.apply(e, l) : y(l, t, r, e) : r || e.push(l)
        }
        return e
    };
    h.flatten = function (n, t) {
        return y(n, t, !1, [])
    }, h.without = function (n) {
        return h.difference(n, a.call(arguments, 1))
    }, h.uniq = h.unique = function (n, t, r, e) {
        if (null == n)return [];
        h.isBoolean(t) || (e = r, r = t, t = !1), null != r && (r = h.iteratee(r, e));
        for (var u = [], i = [], a = 0, o = n.length; o > a; a++) {
            var l = n[a];
            if (t)a && i === l || u.push(l), i = l; else if (r) {
                var c = r(l, a, n);
                h.indexOf(i, c) < 0 && (i.push(c), u.push(l))
            } else h.indexOf(u, l) < 0 && u.push(l)
        }
        return u
    }, h.union = function () {
        return h.uniq(y(arguments, !0, !0, []))
    }, h.intersection = function (n) {
        if (null == n)return [];
        for (var t = [], r = arguments.length, e = 0, u = n.length; u > e; e++) {
            var i = n[e];
            if (!h.contains(t, i)) {
                for (var a = 1; r > a && h.contains(arguments[a], i); a++);
                a === r && t.push(i)
            }
        }
        return t
    }, h.difference = function (n) {
        var t = y(a.call(arguments, 1), !0, !0, []);
        return h.filter(n, function (n) {
            return !h.contains(t, n)
        })
    }, h.zip = function (n) {
        if (null == n)return [];
        for (var t = h.max(arguments, "length").length, r = Array(t), e = 0; t > e; e++)r[e] = h.pluck(arguments, e);
        return r
    }, h.object = function (n, t) {
        if (null == n)return {};
        for (var r = {}, e = 0, u = n.length; u > e; e++)t ? r[n[e]] = t[e] : r[n[e][0]] = n[e][1];
        return r
    }, h.indexOf = function (n, t, r) {
        if (null == n)return -1;
        var e = 0, u = n.length;
        if (r) {
            if ("number" != typeof r)return e = h.sortedIndex(n, t), n[e] === t ? e : -1;
            e = 0 > r ? Math.max(0, u + r) : r
        }
        for (; u > e; e++)if (n[e] === t)return e;
        return -1
    }, h.lastIndexOf = function (n, t, r) {
        if (null == n)return -1;
        var e = n.length;
        for ("number" == typeof r && (e = 0 > r ? e + r + 1 : Math.min(e, r + 1)); --e >= 0;)if (n[e] === t)return e;
        return -1
    }, h.range = function (n, t, r) {
        arguments.length <= 1 && (t = n || 0, n = 0), r = r || 1;
        for (var e = Math.max(Math.ceil((t - n) / r), 0), u = Array(e), i = 0; e > i; i++, n += r)u[i] = n;
        return u
    };
    var d = function () {
    };
    h.bind = function (n, t) {
        var r, e;
        if (p && n.bind === p)return p.apply(n, a.call(arguments, 1));
        if (!h.isFunction(n))throw new TypeError("Bind must be called on a function");
        return r = a.call(arguments, 2), e = function () {
            if (!(this instanceof e))return n.apply(t, r.concat(a.call(arguments)));
            d.prototype = n.prototype;
            var u = new d;
            d.prototype = null;
            var i = n.apply(u, r.concat(a.call(arguments)));
            return h.isObject(i) ? i : u
        }
    }, h.partial = function (n) {
        var t = a.call(arguments, 1);
        return function () {
            for (var r = 0, e = t.slice(), u = 0, i = e.length; i > u; u++)e[u] === h && (e[u] = arguments[r++]);
            for (; r < arguments.length;)e.push(arguments[r++]);
            return n.apply(this, e)
        }
    }, h.bindAll = function (n) {
        var t, r, e = arguments.length;
        if (1 >= e)throw new Error("bindAll must be passed function names");
        for (t = 1; e > t; t++)r = arguments[t], n[r] = h.bind(n[r], n);
        return n
    }, h.memoize = function (n, t) {
        var r = function (e) {
            var u = r.cache, i = t ? t.apply(this, arguments) : e;
            return h.has(u, i) || (u[i] = n.apply(this, arguments)), u[i]
        };
        return r.cache = {}, r
    }, h.delay = function (n, t) {
        var r = a.call(arguments, 2);
        return setTimeout(function () {
            return n.apply(null, r)
        }, t)
    }, h.defer = function (n) {
        return h.delay.apply(h, [n, 1].concat(a.call(arguments, 1)))
    }, h.throttle = function (n, t, r) {
        var e, u, i, a = null, o = 0;
        r || (r = {});
        var l = function () {
            o = r.leading === !1 ? 0 : h.now(), a = null, i = n.apply(e, u), a || (e = u = null)
        };
        return function () {
            var c = h.now();
            o || r.leading !== !1 || (o = c);
            var f = t - (c - o);
            return e = this, u = arguments, 0 >= f || f > t ? (clearTimeout(a), a = null, o = c, i = n.apply(e, u), a || (e = u = null)) : a || r.trailing === !1 || (a = setTimeout(l, f)), i
        }
    }, h.debounce = function (n, t, r) {
        var e, u, i, a, o, l = function () {
            var c = h.now() - a;
            t > c && c > 0 ? e = setTimeout(l, t - c) : (e = null, r || (o = n.apply(i, u), e || (i = u = null)))
        };
        return function () {
            i = this, u = arguments, a = h.now();
            var c = r && !e;
            return e || (e = setTimeout(l, t)), c && (o = n.apply(i, u), i = u = null), o
        }
    }, h.wrap = function (n, t) {
        return h.partial(t, n)
    }, h.negate = function (n) {
        return function () {
            return !n.apply(this, arguments)
        }
    }, h.compose = function () {
        var n = arguments, t = n.length - 1;
        return function () {
            for (var r = t, e = n[t].apply(this, arguments); r--;)e = n[r].call(this, e);
            return e
        }
    }, h.after = function (n, t) {
        return function () {
            return --n < 1 ? t.apply(this, arguments) : void 0
        }
    }, h.before = function (n, t) {
        var r;
        return function () {
            return --n > 0 ? r = t.apply(this, arguments) : t = null, r
        }
    }, h.once = h.partial(h.before, 2), h.keys = function (n) {
        if (!h.isObject(n))return [];
        if (s)return s(n);
        var t = [];
        for (var r in n)h.has(n, r) && t.push(r);
        return t
    }, h.values = function (n) {
        for (var t = h.keys(n), r = t.length, e = Array(r), u = 0; r > u; u++)e[u] = n[t[u]];
        return e
    }, h.pairs = function (n) {
        for (var t = h.keys(n), r = t.length, e = Array(r), u = 0; r > u; u++)e[u] = [t[u], n[t[u]]];
        return e
    }, h.invert = function (n) {
        for (var t = {}, r = h.keys(n), e = 0, u = r.length; u > e; e++)t[n[r[e]]] = r[e];
        return t
    }, h.functions = h.methods = function (n) {
        var t = [];
        for (var r in n)h.isFunction(n[r]) && t.push(r);
        return t.sort()
    }, h.extend = function (n) {
        if (!h.isObject(n))return n;
        for (var t, r, e = 1, u = arguments.length; u > e; e++) {
            t = arguments[e];
            for (r in t)c.call(t, r) && (n[r] = t[r])
        }
        return n
    }, h.pick = function (n, t, r) {
        var e, u = {};
        if (null == n)return u;
        if (h.isFunction(t)) {
            t = g(t, r);
            for (e in n) {
                var i = n[e];
                t(i, e, n) && (u[e] = i)
            }
        } else {
            var l = o.apply([], a.call(arguments, 1));
            n = new Object(n);
            for (var c = 0, f = l.length; f > c; c++)e = l[c], e in n && (u[e] = n[e])
        }
        return u
    }, h.omit = function (n, t, r) {
        if (h.isFunction(t))t = h.negate(t); else {
            var e = h.map(o.apply([], a.call(arguments, 1)), String);
            t = function (n, t) {
                return !h.contains(e, t)
            }
        }
        return h.pick(n, t, r)
    }, h.defaults = function (n) {
        if (!h.isObject(n))return n;
        for (var t = 1, r = arguments.length; r > t; t++) {
            var e = arguments[t];
            for (var u in e)n[u] === void 0 && (n[u] = e[u])
        }
        return n
    }, h.clone = function (n) {
        return h.isObject(n) ? h.isArray(n) ? n.slice() : h.extend({}, n) : n
    }, h.tap = function (n, t) {
        return t(n), n
    };
    var b = function (n, t, r, e) {
        if (n === t)return 0 !== n || 1 / n === 1 / t;
        if (null == n || null == t)return n === t;
        n instanceof h && (n = n._wrapped), t instanceof h && (t = t._wrapped);
        var u = l.call(n);
        if (u !== l.call(t))return !1;
        switch (u) {
            case"[object RegExp]":
            case"[object String]":
                return "" + n == "" + t;
            case"[object Number]":
                return +n !== +n ? +t !== +t : 0 === +n ? 1 / +n === 1 / t : +n === +t;
            case"[object Date]":
            case"[object Boolean]":
                return +n === +t
        }
        if ("object" != typeof n || "object" != typeof t)return !1;
        for (var i = r.length; i--;)if (r[i] === n)return e[i] === t;
        var a = n.constructor, o = t.constructor;
        if (a !== o && "constructor" in n && "constructor" in t && !(h.isFunction(a) && a instanceof a && h.isFunction(o) && o instanceof o))return !1;
        r.push(n), e.push(t);
        var c, f;
        if ("[object Array]" === u) {
            if (c = n.length, f = c === t.length)for (; c-- && (f = b(n[c], t[c], r, e)););
        } else {
            var s, p = h.keys(n);
            if (c = p.length, f = h.keys(t).length === c)for (; c-- && (s = p[c], f = h.has(t, s) && b(n[s], t[s], r, e)););
        }
        return r.pop(), e.pop(), f
    };
    h.isEqual = function (n, t) {
        return b(n, t, [], [])
    }, h.isEmpty = function (n) {
        if (null == n)return !0;
        if (h.isArray(n) || h.isString(n) || h.isArguments(n))return 0 === n.length;
        for (var t in n)if (h.has(n, t))return !1;
        return !0
    }, h.isElement = function (n) {
        return !(!n || 1 !== n.nodeType)
    }, h.isArray = f || function (n) {
            return "[object Array]" === l.call(n)
        }, h.isObject = function (n) {
        var t = typeof n;
        return "function" === t || "object" === t && !!n
    }, h.each(["Arguments", "Function", "String", "Number", "Date", "RegExp"], function (n) {
        h["is" + n] = function (t) {
            return l.call(t) === "[object " + n + "]"
        }
    }), h.isArguments(arguments) || (h.isArguments = function (n) {
        return h.has(n, "callee")
    }), "function" != typeof/./ && (h.isFunction = function (n) {
        return "function" == typeof n || !1
    }), h.isFinite = function (n) {
        return isFinite(n) && !isNaN(parseFloat(n))
    }, h.isNaN = function (n) {
        return h.isNumber(n) && n !== +n
    }, h.isBoolean = function (n) {
        return n === !0 || n === !1 || "[object Boolean]" === l.call(n)
    }, h.isNull = function (n) {
        return null === n
    }, h.isUndefined = function (n) {
        return n === void 0
    }, h.has = function (n, t) {
        return null != n && c.call(n, t)
    }, h.noConflict = function () {
        return n._ = t, this
    }, h.identity = function (n) {
        return n
    }, h.constant = function (n) {
        return function () {
            return n
        }
    }, h.noop = function () {
    }, h.property = function (n) {
        return function (t) {
            return t[n]
        }
    }, h.matches = function (n) {
        var t = h.pairs(n), r = t.length;
        return function (n) {
            if (null == n)return !r;
            n = new Object(n);
            for (var e = 0; r > e; e++) {
                var u = t[e], i = u[0];
                if (u[1] !== n[i] || !(i in n))return !1
            }
            return !0
        }
    }, h.times = function (n, t, r) {
        var e = Array(Math.max(0, n));
        t = g(t, r, 1);
        for (var u = 0; n > u; u++)e[u] = t(u);
        return e
    }, h.random = function (n, t) {
        return null == t && (t = n, n = 0), n + Math.floor(Math.random() * (t - n + 1))
    }, h.now = Date.now || function () {
            return (new Date).getTime()
        };
    var _ = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#x27;",
        "`": "&#x60;"
    }, w = h.invert(_), j = function (n) {
        var t = function (t) {
            return n[t]
        }, r = "(?:" + h.keys(n).join("|") + ")", e = RegExp(r), u = RegExp(r, "g");
        return function (n) {
            return n = null == n ? "" : "" + n, e.test(n) ? n.replace(u, t) : n
        }
    };
    h.escape = j(_), h.unescape = j(w), h.result = function (n, t) {
        if (null == n)return void 0;
        var r = n[t];
        return h.isFunction(r) ? n[t]() : r
    };
    var x = 0;
    h.uniqueId = function (n) {
        var t = ++x + "";
        return n ? n + t : t
    }, h.templateSettings = {evaluate: /<%([\s\S]+?)%>/g, interpolate: /<%=([\s\S]+?)%>/g, escape: /<%-([\s\S]+?)%>/g};
    var A = /(.)^/, k = {
        "'": "'",
        "\\": "\\",
        "\r": "r",
        "\n": "n",
        "\u2028": "u2028",
        "\u2029": "u2029"
    }, O = /\\|'|\r|\n|\u2028|\u2029/g, F = function (n) {
        return "\\" + k[n]
    };
    h.template = function (n, t, r) {
        !t && r && (t = r), t = h.defaults({}, t, h.templateSettings);
        var e = RegExp([(t.escape || A).source, (t.interpolate || A).source, (t.evaluate || A).source].join("|") + "|$", "g"), u = 0, i = "__p+='";
        n.replace(e, function (t, r, e, a, o) {
            return i += n.slice(u, o).replace(O, F), u = o + t.length, r ? i += "'+\n((__t=(" + r + "))==null?'':_.escape(__t))+\n'" : e ? i += "'+\n((__t=(" + e + "))==null?'':__t)+\n'" : a && (i += "';\n" + a + "\n__p+='"), t
        }), i += "';\n", t.variable || (i = "with(obj||{}){\n" + i + "}\n"), i = "var __t,__p='',__j=Array.prototype.join," + "print=function(){__p+=__j.call(arguments,'');};\n" + i + "return __p;\n";
        try {
            var a = new Function(t.variable || "obj", "_", i)
        } catch (o) {
            throw o.source = i, o
        }
        var l = function (n) {
            return a.call(this, n, h)
        }, c = t.variable || "obj";
        return l.source = "function(" + c + "){\n" + i + "}", l
    }, h.chain = function (n) {
        var t = h(n);
        return t._chain = !0, t
    };
    var E = function (n) {
        return this._chain ? h(n).chain() : n
    };
    h.mixin = function (n) {
        h.each(h.functions(n), function (t) {
            var r = h[t] = n[t];
            h.prototype[t] = function () {
                var n = [this._wrapped];
                return i.apply(n, arguments), E.call(this, r.apply(h, n))
            }
        })
    }, h.mixin(h), h.each(["pop", "push", "reverse", "shift", "sort", "splice", "unshift"], function (n) {
        var t = r[n];
        h.prototype[n] = function () {
            var r = this._wrapped;
            return t.apply(r, arguments), "shift" !== n && "splice" !== n || 0 !== r.length || delete r[0], E.call(this, r)
        }
    }), h.each(["concat", "join", "slice"], function (n) {
        var t = r[n];
        h.prototype[n] = function () {
            return E.call(this, t.apply(this._wrapped, arguments))
        }
    }), h.prototype.value = function () {
        return this._wrapped
    }, "function" == typeof define && define.amd && define("underscore", [], function () {
        return h
    })
}).call(this);

// Backbone.js 0.9.2

// (c) 2010-2012 Jeremy Ashkenas, DocumentCloud Inc.
// Backbone may be freely distributed under the MIT license.
// For all details and documentation:
// http://backbonejs.org
(function () {
    var l = this, y = l.Backbone, z = Array.prototype.slice, A = Array.prototype.splice, g;
    g = "undefined" !== typeof exports ? exports : l.Backbone = {};
    g.VERSION = "0.9.2";
    var f = l._;
    !f && "undefined" !== typeof require && (f = require("underscore"));
    var i = l.jQuery || l.Zepto || l.ender;
    g.setDomLibrary = function (a) {
        i = a
    };
    g.noConflict = function () {
        l.Backbone = y;
        return this
    };
    g.emulateHTTP = !1;
    g.emulateJSON = !1;
    var p = /\s+/, k = g.Events = {
        on: function (a, b, c) {
            var d, e, f, g, j;
            if (!b)return this;
            a = a.split(p);
            for (d = this._callbacks || (this._callbacks =
                {}); e = a.shift();)f = (j = d[e]) ? j.tail : {}, f.next = g = {}, f.context = c, f.callback = b, d[e] = {
                tail: g,
                next: j ? j.next : f
            };
            return this
        }, off: function (a, b, c) {
            var d, e, h, g, j, q;
            if (e = this._callbacks) {
                if (!a && !b && !c)return delete this._callbacks, this;
                for (a = a ? a.split(p) : f.keys(e); d = a.shift();)if (h = e[d], delete e[d], h && (b || c))for (g = h.tail; (h = h.next) !== g;)if (j = h.callback, q = h.context, b && j !== b || c && q !== c)this.on(d, j, q);
                return this
            }
        }, trigger: function (a) {
            var b, c, d, e, f, g;
            if (!(d = this._callbacks))return this;
            f = d.all;
            a = a.split(p);
            for (g =
                     z.call(arguments, 1); b = a.shift();) {
                if (c = d[b])for (e = c.tail; (c = c.next) !== e;)c.callback.apply(c.context || this, g);
                if (c = f) {
                    e = c.tail;
                    for (b = [b].concat(g); (c = c.next) !== e;)c.callback.apply(c.context || this, b)
                }
            }
            return this
        }
    };
    k.bind = k.on;
    k.unbind = k.off;
    var o = g.Model = function (a, b) {
        var c;
        a || (a = {});
        b && b.parse && (a = this.parse(a));
        if (c = n(this, "defaults"))a = f.extend({}, c, a);
        b && b.collection && (this.collection = b.collection);
        this.attributes = {};
        this._escapedAttributes = {};
        this.cid = f.uniqueId("c");
        this.changed = {};
        this._silent =
        {};
        this._pending = {};
        this.set(a, {silent: !0});
        this.changed = {};
        this._silent = {};
        this._pending = {};
        this._previousAttributes = f.clone(this.attributes);
        this.initialize.apply(this, arguments)
    };
    f.extend(o.prototype, k, {
        changed: null, _silent: null, _pending: null, idAttribute: "id", initialize: function () {
        }, toJSON: function () {
            return f.clone(this.attributes)
        }, get: function (a) {
            return this.attributes[a]
        }, escape: function (a) {
            var b;
            if (b = this._escapedAttributes[a])return b;
            b = this.get(a);
            return this._escapedAttributes[a] = f.escape(null ==
            b ? "" : "" + b)
        }, has: function (a) {
            return null != this.get(a)
        }, set: function (a, b, c) {
            var d, e;
            f.isObject(a) || null == a ? (d = a, c = b) : (d = {}, d[a] = b);
            c || (c = {});
            if (!d)return this;
            d instanceof o && (d = d.attributes);
            if (c.unset)for (e in d)d[e] = void 0;
            if (!this._validate(d, c))return !1;
            this.idAttribute in d && (this.id = d[this.idAttribute]);
            var b = c.changes = {}, h = this.attributes, g = this._escapedAttributes, j = this._previousAttributes || {};
            for (e in d) {
                a = d[e];
                if (!f.isEqual(h[e], a) || c.unset && f.has(h, e))delete g[e], (c.silent ? this._silent :
                    b)[e] = !0;
                c.unset ? delete h[e] : h[e] = a;
                !f.isEqual(j[e], a) || f.has(h, e) != f.has(j, e) ? (this.changed[e] = a, c.silent || (this._pending[e] = !0)) : (delete this.changed[e], delete this._pending[e])
            }
            c.silent || this.change(c);
            return this
        }, unset: function (a, b) {
            (b || (b = {})).unset = !0;
            return this.set(a, null, b)
        }, clear: function (a) {
            (a || (a = {})).unset = !0;
            return this.set(f.clone(this.attributes), a)
        }, fetch: function (a) {
            var a = a ? f.clone(a) : {}, b = this, c = a.success;
            a.success = function (d, e, f) {
                if (!b.set(b.parse(d, f), a))return !1;
                c && c(b, d)
            };
            a.error = g.wrapError(a.error, b, a);
            return (this.sync || g.sync).call(this, "read", this, a)
        }, save: function (a, b, c) {
            var d, e;
            f.isObject(a) || null == a ? (d = a, c = b) : (d = {}, d[a] = b);
            c = c ? f.clone(c) : {};
            if (c.wait) {
                if (!this._validate(d, c))return !1;
                e = f.clone(this.attributes)
            }
            a = f.extend({}, c, {silent: !0});
            if (d && !this.set(d, c.wait ? a : c))return !1;
            var h = this, i = c.success;
            c.success = function (a, b, e) {
                b = h.parse(a, e);
                if (c.wait) {
                    delete c.wait;
                    b = f.extend(d || {}, b)
                }
                if (!h.set(b, c))return false;
                i ? i(h, a) : h.trigger("sync", h, a, c)
            };
            c.error = g.wrapError(c.error,
                h, c);
            b = this.isNew() ? "create" : "update";
            b = (this.sync || g.sync).call(this, b, this, c);
            c.wait && this.set(e, a);
            return b
        }, destroy: function (a) {
            var a = a ? f.clone(a) : {}, b = this, c = a.success, d = function () {
                b.trigger("destroy", b, b.collection, a)
            };
            if (this.isNew())return d(), !1;
            a.success = function (e) {
                a.wait && d();
                c ? c(b, e) : b.trigger("sync", b, e, a)
            };
            a.error = g.wrapError(a.error, b, a);
            var e = (this.sync || g.sync).call(this, "delete", this, a);
            a.wait || d();
            return e
        }, url: function () {
            var a = n(this, "urlRoot") || n(this.collection, "url") || t();
            return this.isNew() ? a : a + ("/" == a.charAt(a.length - 1) ? "" : "/") + encodeURIComponent(this.id)
        }, parse: function (a) {
            return a
        }, clone: function () {
            return new this.constructor(this.attributes)
        }, isNew: function () {
            return null == this.id
        }, change: function (a) {
            a || (a = {});
            var b = this._changing;
            this._changing = !0;
            for (var c in this._silent)this._pending[c] = !0;
            var d = f.extend({}, a.changes, this._silent);
            this._silent = {};
            for (c in d)this.trigger("change:" + c, this, this.get(c), a);
            if (b)return this;
            for (; !f.isEmpty(this._pending);) {
                this._pending =
                {};
                this.trigger("change", this, a);
                for (c in this.changed)!this._pending[c] && !this._silent[c] && delete this.changed[c];
                this._previousAttributes = f.clone(this.attributes)
            }
            this._changing = !1;
            return this
        }, hasChanged: function (a) {
            return !arguments.length ? !f.isEmpty(this.changed) : f.has(this.changed, a)
        }, changedAttributes: function (a) {
            if (!a)return this.hasChanged() ? f.clone(this.changed) : !1;
            var b, c = !1, d = this._previousAttributes, e;
            for (e in a)if (!f.isEqual(d[e], b = a[e]))(c || (c = {}))[e] = b;
            return c
        }, previous: function (a) {
            return !arguments.length || !this._previousAttributes ? null : this._previousAttributes[a]
        }, previousAttributes: function () {
            return f.clone(this._previousAttributes)
        }, isValid: function () {
            return !this.validate(this.attributes)
        }, _validate: function (a, b) {
            if (b.silent || !this.validate)return !0;
            var a = f.extend({}, this.attributes, a), c = this.validate(a, b);
            if (!c)return !0;
            b && b.error ? b.error(this, c, b) : this.trigger("error", this, c, b);
            return !1
        }
    });
    var r = g.Collection = function (a, b) {
        b || (b = {});
        b.model && (this.model = b.model);
        b.comparator && (this.comparator = b.comparator);
        this._reset();
        this.initialize.apply(this, arguments);
        a && this.reset(a, {silent: !0, parse: b.parse})
    };
    f.extend(r.prototype, k, {
        model: o, initialize: function () {
        }, toJSON: function (a) {
            return this.map(function (b) {
                return b.toJSON(a)
            })
        }, add: function (a, b) {
            var c, d, e, g, i, j = {}, k = {}, l = [];
            b || (b = {});
            a = f.isArray(a) ? a.slice() : [a];
            c = 0;
            for (d = a.length; c < d; c++) {
                if (!(e = a[c] = this._prepareModel(a[c], b)))throw Error("Can't add an invalid model to a collection");
                g = e.cid;
                i = e.id;
                j[g] || this._byCid[g] || null != i && (k[i] || this._byId[i]) ?
                    l.push(c) : j[g] = k[i] = e
            }
            for (c = l.length; c--;)a.splice(l[c], 1);
            c = 0;
            for (d = a.length; c < d; c++)(e = a[c]).on("all", this._onModelEvent, this), this._byCid[e.cid] = e, null != e.id && (this._byId[e.id] = e);
            this.length += d;
            A.apply(this.models, [null != b.at ? b.at : this.models.length, 0].concat(a));
            this.comparator && this.sort({silent: !0});
            if (b.silent)return this;
            c = 0;
            for (d = this.models.length; c < d; c++)if (j[(e = this.models[c]).cid])b.index = c, e.trigger("add", e, this, b);
            return this
        }, remove: function (a, b) {
            var c, d, e, g;
            b || (b = {});
            a = f.isArray(a) ?
                a.slice() : [a];
            c = 0;
            for (d = a.length; c < d; c++)if (g = this.getByCid(a[c]) || this.get(a[c]))delete this._byId[g.id], delete this._byCid[g.cid], e = this.indexOf(g), this.models.splice(e, 1), this.length--, b.silent || (b.index = e, g.trigger("remove", g, this, b)), this._removeReference(g);
            return this
        }, push: function (a, b) {
            a = this._prepareModel(a, b);
            this.add(a, b);
            return a
        }, pop: function (a) {
            var b = this.at(this.length - 1);
            this.remove(b, a);
            return b
        }, unshift: function (a, b) {
            a = this._prepareModel(a, b);
            this.add(a, f.extend({at: 0}, b));
            return a
        },
        shift: function (a) {
            var b = this.at(0);
            this.remove(b, a);
            return b
        }, get: function (a) {
            return null == a ? void 0 : this._byId[null != a.id ? a.id : a]
        }, getByCid: function (a) {
            return a && this._byCid[a.cid || a]
        }, at: function (a) {
            return this.models[a]
        }, where: function (a) {
            return f.isEmpty(a) ? [] : this.filter(function (b) {
                for (var c in a)if (a[c] !== b.get(c))return !1;
                return !0
            })
        }, sort: function (a) {
            a || (a = {});
            if (!this.comparator)throw Error("Cannot sort a set without a comparator");
            var b = f.bind(this.comparator, this);
            1 == this.comparator.length ?
                this.models = this.sortBy(b) : this.models.sort(b);
            a.silent || this.trigger("reset", this, a);
            return this
        }, pluck: function (a) {
            return f.map(this.models, function (b) {
                return b.get(a)
            })
        }, reset: function (a, b) {
            a || (a = []);
            b || (b = {});
            for (var c = 0, d = this.models.length; c < d; c++)this._removeReference(this.models[c]);
            this._reset();
            this.add(a, f.extend({silent: !0}, b));
            b.silent || this.trigger("reset", this, b);
            return this
        }, fetch: function (a) {
            a = a ? f.clone(a) : {};
            void 0 === a.parse && (a.parse = !0);
            var b = this, c = a.success;
            a.success = function (d,
                                  e, f) {
                b[a.add ? "add" : "reset"](b.parse(d, f), a);
                c && c(b, d)
            };
            a.error = g.wrapError(a.error, b, a);
            return (this.sync || g.sync).call(this, "read", this, a)
        }, create: function (a, b) {
            var c = this, b = b ? f.clone(b) : {}, a = this._prepareModel(a, b);
            if (!a)return !1;
            b.wait || c.add(a, b);
            var d = b.success;
            b.success = function (e, f) {
                b.wait && c.add(e, b);
                d ? d(e, f) : e.trigger("sync", a, f, b)
            };
            a.save(null, b);
            return a
        }, parse: function (a) {
            return a
        }, chain: function () {
            return f(this.models).chain()
        }, _reset: function () {
            this.length = 0;
            this.models = [];
            this._byId =
            {};
            this._byCid = {}
        }, _prepareModel: function (a, b) {
            b || (b = {});
            a instanceof o ? a.collection || (a.collection = this) : (b.collection = this, a = new this.model(a, b), a._validate(a.attributes, b) || (a = !1));
            return a
        }, _removeReference: function (a) {
            this == a.collection && delete a.collection;
            a.off("all", this._onModelEvent, this)
        }, _onModelEvent: function (a, b, c, d) {
            ("add" == a || "remove" == a) && c != this || ("destroy" == a && this.remove(b, d), b && a === "change:" + b.idAttribute && (delete this._byId[b.previous(b.idAttribute)], this._byId[b.id] = b), this.trigger.apply(this,
                arguments))
        }
    });
    f.each("forEach,each,map,reduce,reduceRight,find,detect,filter,select,reject,every,all,some,any,include,contains,invoke,max,min,sortBy,sortedIndex,toArray,size,first,initial,rest,last,without,indexOf,shuffle,lastIndexOf,isEmpty,groupBy".split(","), function (a) {
        r.prototype[a] = function () {
            return f[a].apply(f, [this.models].concat(f.toArray(arguments)))
        }
    });
    var v = g.View = function (a) {
        this.cid = f.uniqueId("view");
        this._configure(a || {});
        this._ensureElement();
        this.initialize.apply(this, arguments);
        this.delegateEvents()
    }, F = /^(\S+)\s*(.*)$/, w = "model,collection,el,id,attributes,className,tagName".split(",");
    f.extend(v.prototype, k, {
        tagName: "div", $: function (a) {
            return this.$el.find(a)
        }, initialize: function () {
        }, render: function () {
            return this
        }, remove: function () {
            this.$el.remove();
            return this
        }, make: function (a, b, c) {
            a = document.createElement(a);
            b && i(a).attr(b);
            c && i(a).html(c);
            return a
        }, setElement: function (a, b) {
            this.$el && this.undelegateEvents();
            this.$el = a instanceof i ? a : i(a);
            this.el = this.$el[0];
            !1 !== b && this.delegateEvents();
            return this
        }, delegateEvents: function (a) {
            if (a || (a = n(this, "events"))) {
                this.undelegateEvents();
                for (var b in a) {
                    var c = a[b];
                    f.isFunction(c) || (c = this[a[b]]);
                    if (!c)throw Error('Method "' + a[b] + '" does not exist');
                    var d = b.match(F), e = d[1], d = d[2], c = f.bind(c, this), e = e + (".delegateEvents" + this.cid);
                    "" === d ? this.$el.bind(e, c) : this.$el.delegate(d, e, c)
                }
            }
        }, undelegateEvents: function () {
            this.$el.unbind(".delegateEvents" + this.cid)
        }, _configure: function (a) {
            this.options && (a = f.extend({}, this.options, a));
            for (var b = 0, c = w.length; b < c; b++) {
                var d = w[b];
                a[d] && (this[d] = a[d])
            }
            this.options = a
        }, _ensureElement: function () {
            if (this.el)this.setElement(this.el,
                !1); else {
                var a = n(this, "attributes") || {};
                this.id && (a.id = this.id);
                this.className && (a["class"] = this.className);
                this.setElement(this.make(this.tagName, a), !1)
            }
        }
    });
    o.extend = r.extend = v.extend = function (a, b) {
        var c = G(this, a, b);
        c.extend = this.extend;
        return c
    };
    var H = {create: "POST", update: "PUT", "delete": "DELETE", read: "GET"};
    g.sync = function (a, b, c) {
        var d = H[a];
        c || (c = {});
        var e = {type: d, dataType: "json"};
        c.url || (e.url = n(b, "url") || t());
        if (!c.data && b && ("create" == a || "update" == a))e.contentType = "application/json",
            e.data = JSON.stringify(b.toJSON());
        g.emulateJSON && (e.contentType = "application/x-www-form-urlencoded", e.data = e.data ? {model: e.data} : {});
        if (g.emulateHTTP && ("PUT" === d || "DELETE" === d))g.emulateJSON && (e.data._method = d), e.type = "POST", e.beforeSend = function (a) {
            a.setRequestHeader("X-HTTP-Method-Override", d)
        };
        "GET" !== e.type && !g.emulateJSON && (e.processData = !1);
        return i.ajax(f.extend(e, c))
    };
    g.wrapError = function (a, b, c) {
        return function (d, e) {
            e = d === b ? e : d;
            a ? a(b, e, c) : b.trigger("error", b, e, c)
        }
    };
    var x = function () {
    }, G = function (a,
                     b, c) {
        var d;
        d = b && b.hasOwnProperty("constructor") ? b.constructor : function () {
            a.apply(this, arguments)
        };
        f.extend(d, a);
        x.prototype = a.prototype;
        d.prototype = new x;
        b && f.extend(d.prototype, b);
        c && f.extend(d, c);
        d.prototype.constructor = d;
        d.__super__ = a.prototype;
        return d
    }, n = function (a, b) {
        return !a || !a[b] ? null : f.isFunction(a[b]) ? a[b]() : a[b]
    }, t = function () {
        throw Error('A "url" property or function must be specified');
    }
}).call(this);

(function ($) {
    $.fn.tweet = function (o) {
        var s = $.extend({
            username: null,
            list: null,
            favorites: false,
            query: null,
            avatar_size: null,
            count: 3,
            fetch: null,
            page: 1,
            retweets: true,
            intro_text: null,
            outro_text: null,
            join_text: null,
            auto_join_text_default: "i said,",
            auto_join_text_ed: "i",
            auto_join_text_ing: "i am",
            auto_join_text_reply: "i replied to",
            auto_join_text_url: "i was looking at",
            loading_text: null,
            refresh_interval: null,
            twitter_url: "twitter.com",
            twitter_api_url: "api.twitter.com",
            twitter_search_url: "search.twitter.com",
            twitterServiceURL: null,
            tweetOpenHandler: null,
            template: "{avatar}{time}{join}{text}",
            comparator: function (tweet1, tweet2) {
                return tweet2["tweet_time"] - tweet1["tweet_time"];
            },
            filter: function (tweet) {
                return true;
            }
        }, o);
        var url_regexp = /\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?]))/gi;

        function t(template, info) {
            if (typeof template === "string") {
                var result = template;
                for (var key in info) {
                    var val = info[key];
                    result = result.replace(new RegExp('{' + key + '}', 'g'), val === null ? '' : val);
                }
                return result;
            } else return template(info);
        }

        $.extend({tweet: {t: t}});
        function replacer(regex, replacement) {
            return function () {
                var returning = [];
                this.each(function () {
                    returning.push(this.replace(regex, replacement));
                });
                return $(returning);
            };
        }

        function escapeHTML(s) {
            return s.replace(/</g, "&lt;").replace(/>/g, "^&gt;");
        }

        $.extend($.fn, {
            linkUser: replacer(/(^|[\W])@(\w+)/gi, "$1@<span class=\"tweet-link\" url=\"http://" + s.twitter_url + "/$2\">$2</span>"),
            linkHash: replacer(/(?:^| )[\#]+([\w\u00c0-\u00d6\u00d8-\u00f6\u00f8-\u00ff\u0600-\u06ff]+)/gi, ' <span class=\"tweet-link\" url="https://' + s.twitter_url + '/search?q=%23$1&src=hash&lang=all' +
                ((s.username && s.username.length === 1 && !s.list) ? '&from=' + s.username.join("%2BOR%2B") : '') + '" class="tweet_hashtag">#$1</span>'),
            capAwesome: replacer(/\b(awesome)\b/gi, '<span class="awesome">$1</span>'),
            capEpic: replacer(/\b(epic)\b/gi, '<span class="epic">$1</span>'),
            makeHeart: replacer(/(&lt;)+[3]/gi, "<tt class='heart'>&#x2665;</tt>")
        });
        function linkURLs(text, entities) {
            return text.replace(url_regexp, function (match) {
                var url = (/^[a-z]+:/i).test(match) ? match : "http://" + match;
                var text = match;
                for (var i = 0; i < entities.length; ++i) {
                    var entity = entities[i];
                    if (entity.url == url && entity.expanded_url) {
                        url = entity.expanded_url;
                        text = entity.display_url;
                        break;
                    }
                }
                return "<span class=\"tweet-link\" url=\"" + escapeHTML(url) + "\">" + escapeHTML(text) + "</span>";
            });
        }

        function parse_date(date_str) {
            return Date.parse(date_str.replace(/^([a-z]{3})( [a-z]{3} \d\d?)(.*)( \d{4})$/i, '$1,$2$4$3'));
        }

        function relative_time(date) {
            var relative_to = (arguments.length > 1) ? arguments[1] : new Date();
            var delta = parseInt((relative_to.getTime() - date) / 1000, 10);
            var r = '';
            if (delta < 1) {
                r = 'just now';
            } else if (delta < 60) {
                r = delta + ' seconds ago';
            } else if (delta < 120) {
                r = 'a minute ago';
            } else if (delta < (45 * 60)) {
                r = (parseInt(delta / 60, 10)).toString() + ' minutes ago';
            } else if (delta < (2 * 60 * 60)) {
                r = 'an hour ago';
            } else if (delta < (24 * 60 * 60)) {
                r = '' + (parseInt(delta / 3600, 10)).toString() + ' hours ago';
            } else if (delta < (48 * 60 * 60)) {
                r = 'a day ago';
            } else {
                r = (parseInt(delta / 86400, 10)).toString() + ' days ago';
            }
            return 'about ' + r;
        }

        function build_auto_join_text(text) {
            if (text.match(/^(@([A-Za-z0-9-_]+)) .*/i)) {
                return s.auto_join_text_reply;
            } else if (text.match(url_regexp)) {
                return s.auto_join_text_url;
            } else if (text.match(/^((\w+ed)|just) .*/im)) {
                return s.auto_join_text_ed;
            } else if (text.match(/^(\w*ing) .*/i)) {
                return s.auto_join_text_ing;
            } else {
                return s.auto_join_text_default;
            }
        }

        function build_api_url() {
            var proto = ('https:' == document.location.protocol ? 'https:' : 'http:');
            var count = (s.fetch === null) ? s.count : s.fetch;
            var common_params = '&include_entities=1&callback=?';
            if (s.list) {
                return proto + "//" + s.twitter_api_url + "/1/" + s.username[0] + "/lists/" + s.list + "/statuses.json?page=" + s.page + "&per_page=" + count + common_params;
            } else if (s.favorites) {
                return s.twitterServiceURL + "/twitter/q/favorites?filter=" + encodeURIComponent('@' + s.username[0]) + '&count=' + count + '&page=' + s.page + common_params;
            } else if (s.query === null && s.username.length == 1) {
                return proto + '//' + s.twitter_api_url + '/1/statuses/user_timeline.json?screen_name=' + s.username[0] + '&count=' + count + (s.retweets ? '&include_rts=1' : '') + '&page=' + s.page + common_params;
            } else {
                var query = (s.query || 'from:' + s.username.join(' OR from:'));
                return s.twitterServiceURL + "/twitter/q/search?filter=" + encodeURIComponent(query) + '&rpp=' + count + '&page=' + s.page + common_params;
            }
        }

        function extract_avatar_url(item, secure) {
            if (secure) {
                return ('user' in item) ? item.user.profile_image_url_https : extract_avatar_url(item, false).replace(/^http:\/\/[a-z0-9]{1,3}\.twimg\.com\//, "https://s3.amazonaws.com/twitter_production/");
            } else {
                return item.profile_image_url || item.user.profile_image_url;
            }
        }

        function extract_template_data(item) {
            var o = {};
            o.item = item;
            o.source = item.source;
            o.screen_name = item.from_user || item.user.screen_name;
            o.avatar_size = s.avatar_size;
            o.avatar_url = extract_avatar_url(item, (document.location.protocol === 'https:'));
            o.retweet = typeof(item.retweeted_status) != 'undefined';
            o.tweet_time = parse_date(item.created_at);
            o.join_text = s.join_text == "auto" ? build_auto_join_text(item.text) : s.join_text;
            o.tweet_id = item.id_str;
            o.twitter_base = "http://" + s.twitter_url + "/";
            o.user_url = o.twitter_base + o.screen_name;
            o.tweet_url = o.user_url + "/status/" + o.tweet_id;
            o.reply_url = o.twitter_base + "intent/tweet?in_reply_to=" + o.tweet_id;
            o.retweet_url = o.twitter_base + "intent/retweet?tweet_id=" + o.tweet_id;
            o.favorite_url = o.twitter_base + "intent/favorite?tweet_id=" + o.tweet_id;
            o.retweeted_screen_name = o.retweet && item.retweeted_status.user.screen_name;
            o.tweet_relative_time = relative_time(o.tweet_time);
            o.entities = item.entities ? (item.entities.urls || []).concat(item.entities.media || []) : [];
            o.tweet_raw_text = o.retweet ? ('RT @' + o.retweeted_screen_name + ' ' + item.retweeted_status.text) : item.text;
            o.tweet_text = $([linkURLs(o.tweet_raw_text, o.entities)]).linkUser().linkHash()[0];
            o.tweet_text_fancy = $([o.tweet_text]).makeHeart().capAwesome().capEpic()[0];
            o.user = t('<span class="tweet_user" url="{user_url}">{screen_name}</span>', o);
            o.join = s.join_text ? t(' <span class="tweet_join">{join_text}</span> ', o) : ' ';
            o.avatar = o.avatar_size ? t('<a class="tweet_avatar" href="{user_url}"><img src="{avatar_url}" height="{avatar_size}" width="{avatar_size}" alt="{screen_name}\'s avatar" title="{screen_name}\'s avatar" border="0"/></a>', o) : '';
            o.time = t('<span class="tweet_time"><a href="{tweet_url}" title="view tweet on twitter">{tweet_relative_time}</a></span>', o);
            o.text = t('<span class="tweet_text">{tweet_text_fancy}</span>', o);
            o.reply_action = t('<a class="tweet_action tweet_reply" href="{reply_url}">reply</a>', o);
            o.retweet_action = t('<a class="tweet_action tweet_retweet" href="{retweet_url}">retweet</a>', o);
            o.favorite_action = t('<a class="tweet_action tweet_favorite" href="{favorite_url}">favorite</a>', o);
            return o;
        }

        return this.each(function (i, widget) {
            var list = $('<ul class="tweet_list">');
            var intro = '<p class="tweet_intro">' + s.intro_text + '</p>';
            var outro = '<p class="tweet_outro">' + s.outro_text + '</p>';
            var loading = $('<p class="loading">' + s.loading_text + '</p>');
            if (s.username && typeof(s.username) == "string") {
                s.username = [s.username];
            }
            $(widget).unbind("tweet:load").bind("tweet:load", function () {
                if (s.loading_text)$(widget).empty().append(loading);
                $.getJSON(build_api_url(), function (data) {
                    $(widget).empty().append(list);
                    if (s.intro_text)list.before(intro);
                    list.empty();
                    var tweets = $.map(data.statuses || data, extract_template_data);
                    tweets = $.grep(tweets, s.filter).sort(s.comparator).slice(0, s.count);
                    list.append($.map(tweets, function (o) {
                        return "<li>" + t(s.template, o) + "</li>";
                    }).join('')).children('li').first().addClass('tweet_first').end().children('li:odd').addClass('tweet_even').end().children('li:even').addClass('tweet_odd');
                    if (s.outro_text)list.after(outro);
                    $(widget).trigger("loaded").trigger((tweets.length === 0 ? "empty" : "full"));
                    if (s.refresh_interval) {
                        window.setTimeout(function () {
                            $(widget).trigger("tweet:load");
                        }, 1000 * s.refresh_interval);
                    }
                    $(widget).find(".tweet-link[url]").click(function () {
                        s.tweetOpenHandler && s.tweetOpenHandler.openTweet($(this).attr("url"));
                    });
                    $(widget).find(".tweet_user[url]").click(function () {
                        s.tweetOpenHandler && s.tweetOpenHandler.openUser($(this).attr("url"));
                    });
                });
            }).trigger("tweet:load");
        });
    };
})(Zepto);
!function (a, b) {
    function c(a) {
        return "" === f ? a : (a = a.charAt(0).toUpperCase() + a.substr(1), f + a)
    }

    var d = Math, e = b.createElement("div").style, f = function () {
        for (var a, b = "t,webkitT,MozT,msT,OT".split(","), c = 0, d = b.length; d > c; c++)if (a = b[c] + "ransform", a in e)return b[c].substr(0, b[c].length - 1);
        return !1
    }(), g = f ? "-" + f.toLowerCase() + "-" : "", h = c("transform"), i = c("transitionProperty"), j = c("transitionDuration"), k = c("transformOrigin"), l = c("transitionTimingFunction"), m = c("transitionDelay"), n = /android/gi.test(navigator.appVersion), o = /iphone|ipad/gi.test(navigator.appVersion), p = /hp-tablet/gi.test(navigator.appVersion), q = c("perspective") in e, r = "ontouchstart" in a && !p, s = f !== !1, t = c("transition") in e, u = "onorientationchange" in a ? "orientationchange" : "resize", v = r ? "touchstart" : "mousedown", w = r ? "touchmove" : "mousemove", x = r ? "touchend" : "mouseup", y = r ? "touchcancel" : "mouseup", z = function () {
        if (f === !1)return !1;
        var a = {
            "": "transitionend",
            webkit: "webkitTransitionEnd",
            Moz: "transitionend",
            O: "otransitionend",
            ms: "MSTransitionEnd"
        };
        return a[f]
    }(), A = function () {
        return a.requestAnimationFrame || a.webkitRequestAnimationFrame || a.mozRequestAnimationFrame || a.oRequestAnimationFrame || a.msRequestAnimationFrame || function (a) {
                return setTimeout(a, 1)
            }
    }(), B = function () {
        return a.cancelRequestAnimationFrame || a.webkitCancelAnimationFrame || a.webkitCancelRequestAnimationFrame || a.mozCancelRequestAnimationFrame || a.oCancelRequestAnimationFrame || a.msCancelRequestAnimationFrame || clearTimeout
    }(), C = q ? " translateZ(0)" : "", D = function (c, d) {
        var e, f = this;
        f.wrapper = "object" == typeof c ? c : b.getElementById(c), f.wrapper.style.overflow = "hidden", f.scroller = f.wrapper.children[0], f.options = {
            hScroll: !0,
            vScroll: !0,
            x: 0,
            y: 0,
            bounce: !0,
            bounceLock: !1,
            momentum: !0,
            lockDirection: !0,
            useTransform: !0,
            useTransition: !1,
            topOffset: 0,
            checkDOMChanges: !1,
            handleClick: !0,
            hScrollbar: !0,
            vScrollbar: !0,
            fixedScrollbar: n,
            hideScrollbar: o,
            fadeScrollbar: o && q,
            scrollbarClass: "",
            zoom: !1,
            zoomMin: 1,
            zoomMax: 4,
            doubleTapZoom: 2,
            wheelAction: "scroll",
            snap: !1,
            snapThreshold: 1,
            onRefresh: null,
            onBeforeScrollStart: function (a) {
                a.preventDefault()
            },
            onScrollStart: null,
            onBeforeScrollMove: null,
            onScrollMove: null,
            onBeforeScrollEnd: null,
            onScrollEnd: null,
            onTouchEnd: null,
            onDestroy: null,
            onZoomStart: null,
            onZoom: null,
            onZoomEnd: null
        };
        for (e in d)f.options[e] = d[e];
        f.x = f.options.x, f.y = f.options.y, f.options.useTransform = s && f.options.useTransform, f.options.hScrollbar = f.options.hScroll && f.options.hScrollbar, f.options.vScrollbar = f.options.vScroll && f.options.vScrollbar, f.options.zoom = f.options.useTransform && f.options.zoom, f.options.useTransition = t && f.options.useTransition, f.options.zoom && n && (C = ""), f.scroller.style[i] = f.options.useTransform ? g + "transform" : "top left", f.scroller.style[j] = "0", f.scroller.style[k] = "0 0", f.options.useTransition && (f.scroller.style[l] = "cubic-bezier(0.33,0.66,0.66,1)"), f.options.useTransform ? f.scroller.style[h] = "translate(" + f.x + "px," + f.y + "px)" + C : f.scroller.style.cssText += ";position:absolute;top:" + f.y + "px;left:" + f.x + "px", f.options.useTransition && (f.options.fixedScrollbar = !0), f.refresh(), f._bind(u, a), f._bind(v), r || "none" != f.options.wheelAction && (f._bind("DOMMouseScroll"), f._bind("mousewheel")), f.options.checkDOMChanges && (f.checkDOMTime = setInterval(function () {
            f._checkDOMChanges()
        }, 500))
    };
    D.prototype = {
        enabled: !0,
        x: 0,
        y: 0,
        steps: [],
        scale: 1,
        currPageX: 0,
        currPageY: 0,
        pagesX: [],
        pagesY: [],
        aniTime: null,
        wheelZoomCount: 0,
        handleEvent: function (a) {
            var b = this;
            switch (a.type) {
                case v:
                    if (!r && 0 !== a.button)return;
                    b._start(a);
                    break;
                case w:
                    b._move(a);
                    break;
                case x:
                case y:
                    b._end(a);
                    break;
                case u:
                    b._resize();
                    break;
                case"DOMMouseScroll":
                case"mousewheel":
                    b._wheel(a);
                    break;
                case z:
                    b._transitionEnd(a)
            }
        },
        _checkDOMChanges: function () {
            this.moved || this.zoomed || this.animating || this.scrollerW == this.scroller.offsetWidth * this.scale && this.scrollerH == this.scroller.offsetHeight * this.scale || this.refresh()
        },
        _scrollbar: function (a) {
            var c, e = this;
            return e[a + "Scrollbar"] ? (e[a + "ScrollbarWrapper"] || (c = b.createElement("div"), e.options.scrollbarClass ? c.className = e.options.scrollbarClass + a.toUpperCase() : c.style.cssText = "position:absolute;z-index:100;" + ("h" == a ? "height:7px;bottom:1px;left:2px;right:" + (e.vScrollbar ? "7" : "2") + "px" : "width:7px;bottom:" + (e.hScrollbar ? "7" : "2") + "px;top:2px;right:1px"), c.style.cssText += ";pointer-events:none;" + g + "transition-property:opacity;" + g + "transition-duration:" + (e.options.fadeScrollbar ? "350ms" : "0") + ";overflow:hidden;opacity:" + (e.options.hideScrollbar ? "0" : "1"), e.wrapper.appendChild(c), e[a + "ScrollbarWrapper"] = c, c = b.createElement("div"), e.options.scrollbarClass || (c.style.cssText = "position:absolute;z-index:100;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.9);" + g + "background-clip:padding-box;" + g + "box-sizing:border-box;" + ("h" == a ? "height:100%" : "width:100%") + ";" + g + "border-radius:3px;border-radius:3px"), c.style.cssText += ";pointer-events:none;" + g + "transition-property:" + g + "transform;" + g + "transition-timing-function:cubic-bezier(0.33,0.66,0.66,1);" + g + "transition-duration:0;" + g + "transform: translate(0,0)" + C, e.options.useTransition && (c.style.cssText += ";" + g + "transition-timing-function:cubic-bezier(0.33,0.66,0.66,1)"), e[a + "ScrollbarWrapper"].appendChild(c), e[a + "ScrollbarIndicator"] = c), "h" == a ? (e.hScrollbarSize = e.hScrollbarWrapper.clientWidth, e.hScrollbarIndicatorSize = d.max(d.round(e.hScrollbarSize * e.hScrollbarSize / e.scrollerW), 8), e.hScrollbarIndicator.style.width = e.hScrollbarIndicatorSize + "px", e.hScrollbarMaxScroll = e.hScrollbarSize - e.hScrollbarIndicatorSize, e.hScrollbarProp = e.hScrollbarMaxScroll / e.maxScrollX) : (e.vScrollbarSize = e.vScrollbarWrapper.clientHeight, e.vScrollbarIndicatorSize = d.max(d.round(e.vScrollbarSize * e.vScrollbarSize / e.scrollerH), 8), e.vScrollbarIndicator.style.height = e.vScrollbarIndicatorSize + "px", e.vScrollbarMaxScroll = e.vScrollbarSize - e.vScrollbarIndicatorSize, e.vScrollbarProp = e.vScrollbarMaxScroll / e.maxScrollY), void e._scrollbarPos(a, !0)) : void(e[a + "ScrollbarWrapper"] && (s && (e[a + "ScrollbarIndicator"].style[h] = ""), e[a + "ScrollbarWrapper"].parentNode.removeChild(e[a + "ScrollbarWrapper"]), e[a + "ScrollbarWrapper"] = null, e[a + "ScrollbarIndicator"] = null))
        },
        _resize: function () {
            var a = this;
            setTimeout(function () {
                a.refresh()
            }, n ? 200 : 0)
        },
        _pos: function (a, b) {
            this.zoomed || (a = this.hScroll ? a : 0, b = this.vScroll ? b : 0, this.options.useTransform ? this.scroller.style[h] = "translate(" + a + "px," + b + "px) scale(" + this.scale + ")" + C : (a = d.round(a), b = d.round(b), this.scroller.style.left = a + "px", this.scroller.style.top = b + "px"), this.x = a, this.y = b, this._scrollbarPos("h"), this._scrollbarPos("v"))
        },
        _scrollbarPos: function (a, b) {
            var c, e = this, f = "h" == a ? e.x : e.y;
            e[a + "Scrollbar"] && (f = e[a + "ScrollbarProp"] * f, 0 > f ? (e.options.fixedScrollbar || (c = e[a + "ScrollbarIndicatorSize"] + d.round(3 * f), 8 > c && (c = 8), e[a + "ScrollbarIndicator"].style["h" == a ? "width" : "height"] = c + "px"), f = 0) : f > e[a + "ScrollbarMaxScroll"] && (e.options.fixedScrollbar ? f = e[a + "ScrollbarMaxScroll"] : (c = e[a + "ScrollbarIndicatorSize"] - d.round(3 * (f - e[a + "ScrollbarMaxScroll"])), 8 > c && (c = 8), e[a + "ScrollbarIndicator"].style["h" == a ? "width" : "height"] = c + "px", f = e[a + "ScrollbarMaxScroll"] + (e[a + "ScrollbarIndicatorSize"] - c))), e[a + "ScrollbarWrapper"].style[m] = "0", e[a + "ScrollbarWrapper"].style.opacity = b && e.options.hideScrollbar ? "0" : "1", e[a + "ScrollbarIndicator"].style[h] = "translate(" + ("h" == a ? f + "px,0)" : "0," + f + "px)") + C)
        },
        _start: function (b) {
            var c, e, f, g, i, j = this, k = r ? b.touches[0] : b;
            j.enabled && (j.options.onBeforeScrollStart && j.options.onBeforeScrollStart.call(j, b), (j.options.useTransition || j.options.zoom) && j._transitionTime(0), j.moved = !1, j.animating = !1, j.zoomed = !1, j.distX = 0, j.distY = 0, j.absDistX = 0, j.absDistY = 0, j.dirX = 0, j.dirY = 0, j.options.zoom && r && b.touches.length > 1 && (g = d.abs(b.touches[0].pageX - b.touches[1].pageX), i = d.abs(b.touches[0].pageY - b.touches[1].pageY), j.touchesDistStart = d.sqrt(g * g + i * i), j.originX = d.abs(b.touches[0].pageX + b.touches[1].pageX - 2 * j.wrapperOffsetLeft) / 2 - j.x, j.originY = d.abs(b.touches[0].pageY + b.touches[1].pageY - 2 * j.wrapperOffsetTop) / 2 - j.y, j.options.onZoomStart && j.options.onZoomStart.call(j, b)), j.options.momentum && (j.options.useTransform ? (c = getComputedStyle(j.scroller, null)[h].replace(/[^0-9\-.,]/g, "").split(","), e = +(c[12] || c[4]), f = +(c[13] || c[5])) : (e = +getComputedStyle(j.scroller, null).left.replace(/[^0-9-]/g, ""), f = +getComputedStyle(j.scroller, null).top.replace(/[^0-9-]/g, "")), (e != j.x || f != j.y) && (j.options.useTransition ? j._unbind(z) : B(j.aniTime), j.steps = [], j._pos(e, f), j.options.onScrollEnd && j.options.onScrollEnd.call(j))), j.absStartX = j.x, j.absStartY = j.y, j.startX = j.x, j.startY = j.y, j.pointX = k.pageX, j.pointY = k.pageY, j.startTime = b.timeStamp || Date.now(), j.options.onScrollStart && j.options.onScrollStart.call(j, b), j._bind(w, a), j._bind(x, a), j._bind(y, a))
        },
        _move: function (a) {
            var b, c, e, f = this, g = r ? a.touches[0] : a, i = g.pageX - f.pointX, j = g.pageY - f.pointY, k = f.x + i, l = f.y + j, m = a.timeStamp || Date.now();
            return f.options.onBeforeScrollMove && f.options.onBeforeScrollMove.call(f, a), f.options.zoom && r && a.touches.length > 1 ? (b = d.abs(a.touches[0].pageX - a.touches[1].pageX), c = d.abs(a.touches[0].pageY - a.touches[1].pageY), f.touchesDist = d.sqrt(b * b + c * c), f.zoomed = !0, e = 1 / f.touchesDistStart * f.touchesDist * this.scale, e < f.options.zoomMin ? e = .5 * f.options.zoomMin * Math.pow(2, e / f.options.zoomMin) : e > f.options.zoomMax && (e = 2 * f.options.zoomMax * Math.pow(.5, f.options.zoomMax / e)), f.lastScale = e / this.scale, k = this.originX - this.originX * f.lastScale + this.x, l = this.originY - this.originY * f.lastScale + this.y, this.scroller.style[h] = "translate(" + k + "px," + l + "px) scale(" + e + ")" + C, void(f.options.onZoom && f.options.onZoom.call(f, a))) : (f.pointX = g.pageX, f.pointY = g.pageY, (k > 0 || k < f.maxScrollX) && (k = f.options.bounce ? f.x + i / 2 : k >= 0 || f.maxScrollX >= 0 ? 0 : f.maxScrollX), (l > f.minScrollY || l < f.maxScrollY) && (l = f.options.bounce ? f.y + j / 2 : l >= f.minScrollY || f.maxScrollY >= 0 ? f.minScrollY : f.maxScrollY), f.distX += i, f.distY += j, f.absDistX = d.abs(f.distX), f.absDistY = d.abs(f.distY), void(f.absDistX < 6 && f.absDistY < 6 || (f.options.lockDirection && (f.absDistX > f.absDistY + 5 ? (l = f.y, j = 0) : f.absDistY > f.absDistX + 5 && (k = f.x, i = 0)), f.moved = !0, f._pos(k, l), f.dirX = i > 0 ? -1 : 0 > i ? 1 : 0, f.dirY = j > 0 ? -1 : 0 > j ? 1 : 0, m - f.startTime > 300 && (f.startTime = m, f.startX = f.x, f.startY = f.y), f.options.onScrollMove && f.options.onScrollMove.call(f, a))))
        },
        _end: function (c) {
            if (!r || 0 === c.touches.length) {
                var e, f, g, i, k, l, m, n = this, o = r ? c.changedTouches[0] : c, p = {
                    dist: 0,
                    time: 0
                }, q = {dist: 0, time: 0}, s = (c.timeStamp || Date.now()) - n.startTime, t = n.x, u = n.y;
                if (n._unbind(w, a), n._unbind(x, a), n._unbind(y, a), n.options.onBeforeScrollEnd && n.options.onBeforeScrollEnd.call(n, c), n.zoomed)return m = n.scale * n.lastScale, m = Math.max(n.options.zoomMin, m), m = Math.min(n.options.zoomMax, m), n.lastScale = m / n.scale, n.scale = m, n.x = n.originX - n.originX * n.lastScale + n.x, n.y = n.originY - n.originY * n.lastScale + n.y, n.scroller.style[j] = "200ms", n.scroller.style[h] = "translate(" + n.x + "px," + n.y + "px) scale(" + n.scale + ")" + C, n.zoomed = !1, n.refresh(), void(n.options.onZoomEnd && n.options.onZoomEnd.call(n, c));
                if (!n.moved)return r && (n.doubleTapTimer && n.options.zoom ? (clearTimeout(n.doubleTapTimer), n.doubleTapTimer = null, n.options.onZoomStart && n.options.onZoomStart.call(n, c), n.zoom(n.pointX, n.pointY, 1 == n.scale ? n.options.doubleTapZoom : 1), n.options.onZoomEnd && setTimeout(function () {
                    n.options.onZoomEnd.call(n, c)
                }, 200)) : this.options.handleClick && (n.doubleTapTimer = setTimeout(function () {
                    for (n.doubleTapTimer = null, e = o.target; 1 != e.nodeType;)e = e.parentNode;
                    "SELECT" != e.tagName && "INPUT" != e.tagName && "TEXTAREA" != e.tagName && (f = b.createEvent("MouseEvents"), f.initMouseEvent("click", !0, !0, c.view, 1, o.screenX, o.screenY, o.clientX, o.clientY, c.ctrlKey, c.altKey, c.shiftKey, c.metaKey, 0, null), f._fake = !0, e.dispatchEvent(f))
                }, n.options.zoom ? 250 : 0))), n._resetPos(400), void(n.options.onTouchEnd && n.options.onTouchEnd.call(n, c));
                if (300 > s && n.options.momentum && (p = t ? n._momentum(t - n.startX, s, -n.x, n.scrollerW - n.wrapperW + n.x, n.options.bounce ? n.wrapperW : 0) : p, q = u ? n._momentum(u - n.startY, s, -n.y, n.maxScrollY < 0 ? n.scrollerH - n.wrapperH + n.y - n.minScrollY : 0, n.options.bounce ? n.wrapperH : 0) : q, t = n.x + p.dist, u = n.y + q.dist, (n.x > 0 && t > 0 || n.x < n.maxScrollX && t < n.maxScrollX) && (p = {
                        dist: 0,
                        time: 0
                    }), (n.y > n.minScrollY && u > n.minScrollY || n.y < n.maxScrollY && u < n.maxScrollY) && (q = {
                        dist: 0,
                        time: 0
                    })), p.dist || q.dist)return k = d.max(d.max(p.time, q.time), 10), n.options.snap && (g = t - n.absStartX, i = u - n.absStartY, d.abs(g) < n.options.snapThreshold && d.abs(i) < n.options.snapThreshold ? n.scrollTo(n.absStartX, n.absStartY, 200) : (l = n._snap(t, u), t = l.x, u = l.y, k = d.max(l.time, k))), n.scrollTo(d.round(t), d.round(u), k), void(n.options.onTouchEnd && n.options.onTouchEnd.call(n, c));
                if (n.options.snap)return g = t - n.absStartX, i = u - n.absStartY, d.abs(g) < n.options.snapThreshold && d.abs(i) < n.options.snapThreshold ? n.scrollTo(n.absStartX, n.absStartY, 200) : (l = n._snap(n.x, n.y), (l.x != n.x || l.y != n.y) && n.scrollTo(l.x, l.y, l.time)), void(n.options.onTouchEnd && n.options.onTouchEnd.call(n, c));
                n._resetPos(200), n.options.onTouchEnd && n.options.onTouchEnd.call(n, c)
            }
        },
        _resetPos: function (a) {
            var b = this, c = b.x >= 0 ? 0 : b.x < b.maxScrollX ? b.maxScrollX : b.x, d = b.y >= b.minScrollY || b.maxScrollY > 0 ? b.minScrollY : b.y < b.maxScrollY ? b.maxScrollY : b.y;
            return c == b.x && d == b.y ? (b.moved && (b.moved = !1, b.options.onScrollEnd && b.options.onScrollEnd.call(b)), b.hScrollbar && b.options.hideScrollbar && ("webkit" == f && (b.hScrollbarWrapper.style[m] = "300ms"), b.hScrollbarWrapper.style.opacity = "0"), void(b.vScrollbar && b.options.hideScrollbar && ("webkit" == f && (b.vScrollbarWrapper.style[m] = "300ms"), b.vScrollbarWrapper.style.opacity = "0"))) : void b.scrollTo(c, d, a || 0)
        },
        _wheel: function (a) {
            var b, c, d, e, f, g = this;
            if ("wheelDeltaX" in a)b = a.wheelDeltaX / 12, c = a.wheelDeltaY / 12; else if ("wheelDelta" in a)b = c = a.wheelDelta / 12; else {
                if (!("detail" in a))return;
                b = c = 3 * -a.detail
            }
            return "zoom" == g.options.wheelAction ? (f = g.scale * Math.pow(2, 1 / 3 * (c ? c / Math.abs(c) : 0)), f < g.options.zoomMin && (f = g.options.zoomMin), f > g.options.zoomMax && (f = g.options.zoomMax), void(f != g.scale && (!g.wheelZoomCount && g.options.onZoomStart && g.options.onZoomStart.call(g, a), g.wheelZoomCount++, g.zoom(a.pageX, a.pageY, f, 400), setTimeout(function () {
                g.wheelZoomCount--, !g.wheelZoomCount && g.options.onZoomEnd && g.options.onZoomEnd.call(g, a)
            }, 400)))) : (d = g.x + b, e = g.y + c, d > 0 ? d = 0 : d < g.maxScrollX && (d = g.maxScrollX), e > g.minScrollY ? e = g.minScrollY : e < g.maxScrollY && (e = g.maxScrollY), void(g.maxScrollY < 0 && g.scrollTo(d, e, 0)))
        },
        _transitionEnd: function (a) {
            var b = this;
            a.target == b.scroller && (b._unbind(z), b._startAni())
        },
        _startAni: function () {
            var a, b, c, e = this, f = e.x, g = e.y, h = Date.now();
            if (!e.animating) {
                if (!e.steps.length)return void e._resetPos(400);
                if (a = e.steps.shift(), a.x == f && a.y == g && (a.time = 0), e.animating = !0, e.moved = !0, e.options.useTransition)return e._transitionTime(a.time), e._pos(a.x, a.y), e.animating = !1, void(a.time ? e._bind(z) : e._resetPos(0));
                c = function () {
                    var i, j, k = Date.now();
                    return k >= h + a.time ? (e._pos(a.x, a.y), e.animating = !1, e.options.onAnimationEnd && e.options.onAnimationEnd.call(e), void e._startAni()) : (k = (k - h) / a.time - 1, b = d.sqrt(1 - k * k), i = (a.x - f) * b + f, j = (a.y - g) * b + g, e._pos(i, j), void(e.animating && (e.aniTime = A(c))))
                }, c()
            }
        },
        _transitionTime: function (a) {
            a += "ms", this.scroller.style[j] = a, this.hScrollbar && (this.hScrollbarIndicator.style[j] = a), this.vScrollbar && (this.vScrollbarIndicator.style[j] = a)
        },
        _momentum: function (a, b, c, e, f) {
            var g = 6e-4, h = d.abs(a) / b, i = h * h / (2 * g), j = 0, k = 0;
            return a > 0 && i > c ? (k = f / (6 / (i / h * g)), c += k, h = h * c / i, i = c) : 0 > a && i > e && (k = f / (6 / (i / h * g)), e += k, h = h * e / i, i = e), i *= 0 > a ? -1 : 1, j = h / g, {
                dist: i,
                time: d.round(j)
            }
        },
        _offset: function (a) {
            for (var b = -a.offsetLeft, c = -a.offsetTop; a = a.offsetParent;)b -= a.offsetLeft, c -= a.offsetTop;
            return a != this.wrapper && (b *= this.scale, c *= this.scale), {left: b, top: c}
        },
        _snap: function (a, b) {
            var c, e, f, g, h, i, j = this;
            for (f = j.pagesX.length - 1, c = 0, e = j.pagesX.length; e > c; c++)if (a >= j.pagesX[c]) {
                f = c;
                break
            }
            for (f == j.currPageX && f > 0 && j.dirX < 0 && f--, a = j.pagesX[f], h = d.abs(a - j.pagesX[j.currPageX]), h = h ? d.abs(j.x - a) / h * 500 : 0, j.currPageX = f, f = j.pagesY.length - 1, c = 0; f > c; c++)if (b >= j.pagesY[c]) {
                f = c;
                break
            }
            return f == j.currPageY && f > 0 && j.dirY < 0 && f--, b = j.pagesY[f], i = d.abs(b - j.pagesY[j.currPageY]), i = i ? d.abs(j.y - b) / i * 500 : 0, j.currPageY = f, g = d.round(d.max(h, i)) || 200, {
                x: a,
                y: b,
                time: g
            }
        },
        _bind: function (a, b, c) {
            (b || this.scroller).addEventListener(a, this, !!c)
        },
        _unbind: function (a, b, c) {
            (b || this.scroller).removeEventListener(a, this, !!c)
        },
        destroy: function () {
            var b = this;
            b.scroller.style[h] = "", b.hScrollbar = !1, b.vScrollbar = !1, b._scrollbar("h"), b._scrollbar("v"), b._unbind(u, a), b._unbind(v), b._unbind(w, a), b._unbind(x, a), b._unbind(y, a), b.options.hasTouch || (b._unbind("DOMMouseScroll"), b._unbind("mousewheel")), b.options.useTransition && b._unbind(z), b.options.checkDOMChanges && clearInterval(b.checkDOMTime), b.options.onDestroy && b.options.onDestroy.call(b)
        },
        refresh: function () {
            var a, b, c, e, f = this, g = 0, h = 0;
            if (f.scale < f.options.zoomMin && (f.scale = f.options.zoomMin), f.wrapperW = f.wrapper.clientWidth || 1, f.wrapperH = f.wrapper.clientHeight || 1, f.minScrollY = -f.options.topOffset || 0, f.scrollerW = d.round(f.scroller.offsetWidth * f.scale), f.scrollerH = d.round((f.scroller.offsetHeight + f.minScrollY) * f.scale), f.maxScrollX = f.wrapperW - f.scrollerW, f.maxScrollY = f.wrapperH - f.scrollerH + f.minScrollY, f.dirX = 0, f.dirY = 0, f.options.onRefresh && f.options.onRefresh.call(f), f.hScroll = f.options.hScroll && f.maxScrollX < 0, f.vScroll = f.options.vScroll && (!f.options.bounceLock && !f.hScroll || f.scrollerH > f.wrapperH), f.hScrollbar = f.hScroll && f.options.hScrollbar, f.vScrollbar = f.vScroll && f.options.vScrollbar && f.scrollerH > f.wrapperH, a = f._offset(f.wrapper), f.wrapperOffsetLeft = -a.left, f.wrapperOffsetTop = -a.top, "string" == typeof f.options.snap)for (f.pagesX = [], f.pagesY = [], e = f.scroller.querySelectorAll(f.options.snap), b = 0, c = e.length; c > b; b++)g = f._offset(e[b]), g.left += f.wrapperOffsetLeft, g.top += f.wrapperOffsetTop, f.pagesX[b] = g.left < f.maxScrollX ? f.maxScrollX : g.left * f.scale, f.pagesY[b] = g.top < f.maxScrollY ? f.maxScrollY : g.top * f.scale; else if (f.options.snap) {
                for (f.pagesX = []; g >= f.maxScrollX;)f.pagesX[h] = g, g -= f.wrapperW, h++;
                for (f.maxScrollX % f.wrapperW && (f.pagesX[f.pagesX.length] = f.maxScrollX - f.pagesX[f.pagesX.length - 1] + f.pagesX[f.pagesX.length - 1]), g = 0, h = 0, f.pagesY = []; g >= f.maxScrollY;)f.pagesY[h] = g, g -= f.wrapperH, h++;
                f.maxScrollY % f.wrapperH && (f.pagesY[f.pagesY.length] = f.maxScrollY - f.pagesY[f.pagesY.length - 1] + f.pagesY[f.pagesY.length - 1])
            }
            f._scrollbar("h"), f._scrollbar("v"), f.zoomed || (f.scroller.style[j] = "0", f._resetPos(400))
        },
        scrollTo: function (a, b, c, d) {
            var e, f, g = this, h = a;
            for (g.stop(), h.length || (h = [{
                x: a,
                y: b,
                time: c,
                relative: d
            }]), e = 0, f = h.length; f > e; e++)h[e].relative && (h[e].x = g.x - h[e].x, h[e].y = g.y - h[e].y), g.steps.push({
                x: h[e].x,
                y: h[e].y,
                time: h[e].time || 0
            });
            g._startAni()
        },
        scrollToElement: function (a, b) {
            var c, e = this;
            a = a.nodeType ? a : e.scroller.querySelector(a), a && (c = e._offset(a), c.left += e.wrapperOffsetLeft, c.top += e.wrapperOffsetTop, c.left = c.left > 0 ? 0 : c.left < e.maxScrollX ? e.maxScrollX : c.left, c.top = c.top > e.minScrollY ? e.minScrollY : c.top < e.maxScrollY ? e.maxScrollY : c.top, b = void 0 === b ? d.max(2 * d.abs(c.left), 2 * d.abs(c.top)) : b, e.scrollTo(c.left, c.top, b))
        },
        scrollToPage: function (a, b, c) {
            var d, e, f = this;
            c = void 0 === c ? 400 : c, f.options.onScrollStart && f.options.onScrollStart.call(f), f.options.snap ? (a = "next" == a ? f.currPageX + 1 : "prev" == a ? f.currPageX - 1 : a, b = "next" == b ? f.currPageY + 1 : "prev" == b ? f.currPageY - 1 : b, a = 0 > a ? 0 : a > f.pagesX.length - 1 ? f.pagesX.length - 1 : a, b = 0 > b ? 0 : b > f.pagesY.length - 1 ? f.pagesY.length - 1 : b, f.currPageX = a, f.currPageY = b, d = f.pagesX[a], e = f.pagesY[b]) : (d = -f.wrapperW * a, e = -f.wrapperH * b, d < f.maxScrollX && (d = f.maxScrollX), e < f.maxScrollY && (e = f.maxScrollY)), f.scrollTo(d, e, c)
        },
        disable: function () {
            this.stop(), this._resetPos(0), this.enabled = !1, this._unbind(w, a), this._unbind(x, a), this._unbind(y, a)
        },
        enable: function () {
            this.enabled = !0
        },
        stop: function () {
            this.options.useTransition ? this._unbind(z) : B(this.aniTime), this.steps = [], this.moved = !1, this.animating = !1
        },
        zoom: function (a, b, c, d) {
            var e = this, f = c / e.scale;
            e.options.useTransform && (e.zoomed = !0, d = void 0 === d ? 200 : d, a = a - e.wrapperOffsetLeft - e.x, b = b - e.wrapperOffsetTop - e.y, e.x = a - a * f + e.x, e.y = b - b * f + e.y, e.scale = c, e.refresh(), e.x = e.x > 0 ? 0 : e.x < e.maxScrollX ? e.maxScrollX : e.x, e.y = e.y > e.minScrollY ? e.minScrollY : e.y < e.maxScrollY ? e.maxScrollY : e.y, e.scroller.style[j] = d + "ms", e.scroller.style[h] = "translate(" + e.x + "px," + e.y + "px) scale(" + c + ")" + C, e.zoomed = !1)
        },
        isReady: function () {
            return !this.moved && !this.zoomed && !this.animating
        }
    }, e = null, "undefined" != typeof exports ? exports.iScroll = D : a.iScroll = D
}(window, document);
['width', 'height'].forEach(function (dimension) {
    var offset, Dimension = dimension.replace(/./, function (m) {
        return m[0].toUpperCase()
    });
    $.fn['outer' + Dimension] = function (margin) {
        var elem = this;
        if (elem) {
            var size = elem[dimension]();
            var sides = {'width': ['left', 'right'], 'height': ['top', 'bottom']};
            sides[dimension].forEach(function (side) {
                if (margin)size += parseInt(elem.css('margin-' + side), 10);
            });
            return size;
        } else {
            return null;
        }
    };
});
$.fn['end'] = function () {
    return this.prevObject || $();
};
(function ($) {
    var data = {}, dataAttr = $.fn.data, camelize = $.camelCase, exp = $.expando = 'Zepto' + (+new Date())

    function getData(node, name) {
        var id = node[exp], store = id && data[id]
        if (name === undefined)return store || setData(node)
        else {
            if (store) {
                if (name in store)return store[name]
                var camelName = camelize(name)
                if (camelName in store)return store[camelName]
            }
            return dataAttr.call($(node), name)
        }
    }

    function setData(node, name, value) {
        var id = node[exp] || (node[exp] = ++$.uuid), store = data[id] || (data[id] = attributeData(node))
        if (name !== undefined)store[camelize(name)] = value
        return store
    }

    function attributeData(node) {
        var store = {}
        $.each(node.attributes, function (i, attr) {
            if (attr.name.indexOf('data-') == 0)
                store[camelize(attr.name.replace('data-', ''))] = $.zepto.deserializeValue(attr.value)
        })
        return store
    }

    $.fn.data = function (name, value) {
        return value === undefined ? $.isPlainObject(name) ? this.each(function (i, node) {
            $.each(name, function (key, value) {
                setData(node, key, value)
            })
        }) : this.length == 0 ? undefined : getData(this[0], name) : this.each(function () {
            setData(this, name, value)
        })
    }
    $.fn.removeData = function (names) {
        if (typeof names == 'string')names = names.split(/\s+/)
        return this.each(function () {
            var id = this[exp], store = id && data[id]
            if (store)$.each(names, function () {
                delete store[camelize(this)]
            })
        })
    }
})(Zepto);
(function ($) {
    var touch = {}, touchTimeout, tapTimeout, swipeTimeout, longTapTimeout, longTapDelay = 750, gesture

    function swipeDirection(x1, x2, y1, y2) {
        return Math.abs(x1 - x2) >= Math.abs(y1 - y2) ? (x1 - x2 > 0 ? 'Left' : 'Right') : (y1 - y2 > 0 ? 'Up' : 'Down')
    }

    function longTap() {
        longTapTimeout = null
        if (touch.last) {
            touch.el.trigger('longTap')
            touch = {}
        }
    }

    function cancelLongTap() {
        if (longTapTimeout)clearTimeout(longTapTimeout)
        longTapTimeout = null
    }

    function cancelAll() {
        if (touchTimeout)clearTimeout(touchTimeout)
        if (tapTimeout)clearTimeout(tapTimeout)
        if (swipeTimeout)clearTimeout(swipeTimeout)
        if (longTapTimeout)clearTimeout(longTapTimeout)
        touchTimeout = tapTimeout = swipeTimeout = longTapTimeout = null
        touch = {}
    }

    function cancelEvent(event) {
        event = event || window.event;
        if (event.preventDefault) {
            event.preventDefault();
            event.stopPropagation();
        } else {
            event.returnValue = false;
            event.cancelBubble = true;
        }
    }

    function isPrimaryTouch(event) {
        return (event.pointerType == 'touch' || event.pointerType == event.MSPOINTER_TYPE_TOUCH) && event.isPrimary
    }

    function isPointerEventType(e, type) {
        return (e.type == 'pointer' + type || e.type.toLowerCase() == 'mspointer' + type)
    }

    $.fn.registerTouch = function () {
        var now, delta, deltaX = 0, deltaY = 0, firstTouch, _isPointerType
        if ('MSGesture' in window) {
            gesture = new MSGesture()
            gesture.target = this[0];
        }
        this.bind('MSGestureEnd', function (e) {
            var swipeDirectionFromVelocity = e.velocityX > 1 ? 'Right' : e.velocityX < -1 ? 'Left' : e.velocityY > 1 ? 'Down' : e.velocityY < -1 ? 'Up' : null;
            if (swipeDirectionFromVelocity) {
                touch.el.trigger('swipe')
                touch.el.trigger('swipe' + swipeDirectionFromVelocity)
            }
        }).on('touchstart MSPointerDown pointerdown', function (e) {
            if ((_isPointerType = isPointerEventType(e, 'down')) && !isPrimaryTouch(e))return
            firstTouch = _isPointerType ? e : e.touches[0]
            if (e.touches && e.touches.length === 1 && touch.x2) {
                touch.x2 = undefined
                touch.y2 = undefined
            }
            now = Date.now()
            delta = now - (touch.last || now)
            touch.el = $('tagName' in firstTouch.target ? firstTouch.target : firstTouch.target.parentNode)
            touchTimeout && clearTimeout(touchTimeout)
            touch.x1 = firstTouch.pageX
            touch.y1 = firstTouch.pageY
            if (delta > 0 && delta <= 250)touch.isDoubleTap = true
            touch.last = now
            longTapTimeout = setTimeout(longTap, longTapDelay)
            if (gesture && _isPointerType)gesture.addPointer(e.pointerId);
        }).on('touchmove MSPointerMove pointermove', function (e) {
            if ((_isPointerType = isPointerEventType(e, 'move')) && !isPrimaryTouch(e))return
            firstTouch = _isPointerType ? e : e.touches[0]
            cancelLongTap()
            touch.x2 = firstTouch.pageX
            touch.y2 = firstTouch.pageY
            var hDistance = Math.abs(touch.x1 - touch.x2)
            deltaX += hDistance
            deltaY += Math.abs(touch.y1 - touch.y2)
            if (hDistance > 20) {
                var event = $.Event('drag')
                event.distance = hDistance
                event.direction = (touch.x1 > touch.x2) ? "left" : "right"
                touch.el.trigger(event)
                cancelEvent(e);
            }
        }).on('touchend MSPointerUp pointerup', function (e) {
            if ((_isPointerType = isPointerEventType(e, 'up')) && !isPrimaryTouch(e))return
            cancelLongTap()
            var event = $.Event('dragend')
            event.distance = touch.x1 - touch.x2;
            event.direction = (touch.x1 > touch.x2) ? "left" : "right"
            touch.el.trigger(event)
            if ((touch.x2 && Math.abs(touch.x1 - touch.x2) > 30) || (touch.y2 && Math.abs(touch.y1 - touch.y2) > 30))
                swipeTimeout = setTimeout(function () {
                    touch.el.trigger('swipe')
                    touch.el.trigger('swipe' + (swipeDirection(touch.x1, touch.x2, touch.y1, touch.y2)))
                    touch = {}
                }, 0)
            else if ('last' in touch)
                if (deltaX < 30 && deltaY < 30) {
                    tapTimeout = setTimeout(function () {
                        var event = $.Event('tap')
                        event.cancelTouch = cancelAll
                        touch.el.trigger(event)
                        if (touch.isDoubleTap) {
                            if (touch.el)touch.el.trigger('doubleTap')
                            touch = {}
                        }
                        else {
                            touchTimeout = setTimeout(function () {
                                touchTimeout = null
                                if (touch.el)touch.el.trigger('singleTap')
                                touch = {}
                            }, 250)
                        }
                    }, 0)
                } else {
                    touch = {}
                }
            deltaX = deltaY = 0
        }).on('touchcancel MSPointerCancel pointercancel', cancelAll)
        $(window).on('scroll', cancelAll)
    };
    ['drag', 'dragend', 'swipe', 'swipeLeft', 'swipeRight', 'swipeUp', 'swipeDown', 'doubleTap', 'tap', 'singleTap', 'longTap'].forEach(function (eventName) {
        $.fn[eventName] = function (callback) {
            return this.on(eventName, callback)
        }
    })
})(Zepto);
;(function ($, undefined) {
    var prefix = '', eventPrefix, endEventName, endAnimationName, vendors = {
        Webkit: 'webkit',
        Moz: '',
        O: 'o'
    }, document = window.document, testEl = document.createElement('div'), supportedTransforms = /^((translate|rotate|scale)(X|Y|Z|3d)?|matrix(3d)?|perspective|skew(X|Y)?)$/i, transform, transitionProperty, transitionDuration, transitionTiming, transitionDelay, animationName, animationDuration, animationTiming, animationDelay, cssReset = {}

    function dasherize(str) {
        return str.replace(/([a-z])([A-Z])/, '$1-$2').toLowerCase()
    }

    function normalizeEvent(name) {
        return eventPrefix ? eventPrefix + name : name.toLowerCase()
    }

    $.each(vendors, function (vendor, event) {
        if (testEl.style[vendor + 'TransitionProperty'] !== undefined) {
            prefix = '-' + vendor.toLowerCase() + '-'
            eventPrefix = event
            return false
        }
    })
    transform = prefix + 'transform'
    cssReset[transitionProperty = prefix + 'transition-property'] = cssReset[transitionDuration = prefix + 'transition-duration'] = cssReset[transitionDelay = prefix + 'transition-delay'] = cssReset[transitionTiming = prefix + 'transition-timing-function'] = cssReset[animationName = prefix + 'animation-name'] = cssReset[animationDuration = prefix + 'animation-duration'] = cssReset[animationDelay = prefix + 'animation-delay'] = cssReset[animationTiming = prefix + 'animation-timing-function'] = ''
    $.fx = {
        off: (eventPrefix === undefined && testEl.style.transitionProperty === undefined),
        speeds: {_default: 400, fast: 200, slow: 600},
        cssPrefix: prefix,
        transitionEnd: normalizeEvent('TransitionEnd'),
        animationEnd: normalizeEvent('AnimationEnd')
    }
    $.fn.animate = function (properties, duration, ease, callback, delay) {
        if ($.isFunction(duration))
            callback = duration, ease = undefined, duration = undefined
        if ($.isFunction(ease))
            callback = ease, ease = undefined
        if ($.isPlainObject(duration))
            ease = duration.easing, callback = duration.complete, delay = duration.delay, duration = duration.duration
        if (duration)duration = (typeof duration == 'number' ? duration : ($.fx.speeds[duration] || $.fx.speeds._default)) / 1000
        if (delay)delay = parseFloat(delay) / 1000
        return this.anim(properties, duration, ease, callback, delay)
    }
    $.fn.anim = function (properties, duration, ease, callback, delay) {
        var key, cssValues = {}, cssProperties, transforms = '', that = this, wrappedCallback, endEvent = $.fx.transitionEnd, fired = false
        if (duration === undefined)duration = $.fx.speeds._default / 1000
        if (delay === undefined)delay = 0
        if ($.fx.off)duration = 0
        if (typeof properties == 'string') {
            cssValues[animationName] = properties
            cssValues[animationDuration] = duration + 's'
            cssValues[animationDelay] = delay + 's'
            cssValues[animationTiming] = (ease || 'linear')
            endEvent = $.fx.animationEnd
        } else {
            cssProperties = []
            for (key in properties)
                if (supportedTransforms.test(key))transforms += key + '(' + properties[key] + ') '
                else cssValues[key] = properties[key], cssProperties.push(dasherize(key))
            if (transforms)cssValues[transform] = transforms, cssProperties.push(transform)
            if (duration > 0 && typeof properties === 'object') {
                cssValues[transitionProperty] = cssProperties.join(', ')
                cssValues[transitionDuration] = duration + 's'
                cssValues[transitionDelay] = delay + 's'
                cssValues[transitionTiming] = (ease || 'linear')
            }
        }
        wrappedCallback = function (event) {
            if (typeof event !== 'undefined') {
                if (event.target !== event.currentTarget)return
                $(event.target).unbind(endEvent, wrappedCallback)
            } else
                $(this).unbind(endEvent, wrappedCallback)
            fired = true
            $(this).css(cssReset)
            callback && callback.call(this)
        }
        if (duration > 0) {
            this.bind(endEvent, wrappedCallback)
            setTimeout(function () {
                if (fired)return
                wrappedCallback.call(that)
            }, (duration * 1000) + 25)
        }
        this.size() && this.get(0).clientLeft
        this.css(cssValues)
        if (duration <= 0)setTimeout(function () {
            that.each(function () {
                wrappedCallback.call(this)
            })
        }, 0)
        return this
    }
    testEl = null
})(Zepto);
(function (SCOPE) {
    SCOPE.ErrorDetector = function (iRoll) {
        var id = iRoll.get('id'), that = this;
        that.startListener = function () {
            SCOPE.Events.on(id + ':video_error', function (e) {
                var eventValue = "";
                if (e && (e.target instanceof HTMLMediaElement)) {
                    eventValue = e.target.error.code;
                }
                that.trigger('video_error', eventValue);
            });
            SCOPE.Events.on(id + ':video_source_error', function (e) {
                var eventValue = "";
                if (e && (e.target instanceof HTMLSourceElement)) {
                    eventValue = e.target.parentNode.networkState;
                    that.trigger('video_source_error', eventValue);
                }
            });
            SCOPE.Events.on(id + ':video_high_buffering_count', function (count) {
                that.trigger('video_high_buffering_count', count);
            });
            SCOPE.Events.on(id + ':video_long_buffering_time', function (time) {
                if (!isNaN(time)) {
                    that.trigger('video_long_buffering_time', time);
                }
            });
            SCOPE.Events.on(id + ":ad_started", function () {
                var winSize = this.canvas.getSize();
                if (!winSize.width || !winSize.height) {
                    that.trigger('bad_window_size_at_video_start');
                }
                if (this.get('checkForVisibility')) {
                    if (this.isHidden()) {
                        that.trigger('document_not_visible_at_video_start');
                    }
                }
                var now = _.now();
                var LATE_IMPRESSION_THRESHOLD_MS = 3000;
                if (now - this.initTimestamp > LATE_IMPRESSION_THRESHOLD_MS) {
                    that.trigger('late_impression', LATE_IMPRESSION_THRESHOLD_MS);
                }
                var VERY_LATE_IMPRESSION_THRESHOLD_MS = 5000;
                if (now - this.initTimestamp > VERY_LATE_IMPRESSION_THRESHOLD_MS) {
                    that.trigger('very_late_impression', VERY_LATE_IMPRESSION_THRESHOLD_MS);
                }
            }, iRoll);
            SCOPE.Events.on(id + ':container_error', function (message, action) {
                var eventValue = "";
                if (_.isString(action)) {
                    eventValue += "(Action:" + action + ")";
                }
                if (_.isString(message)) {
                    eventValue += "(Message:" + message + ")";
                }
                that.trigger('container_error', eventValue);
            });
            SCOPE.Events.on(id + ':video_videoPassed75', function () {
                [25, 50].forEach(function (vp) {
                    if (!iRoll.report.wasPixelLoaded({action: 'vpoint', event_value: vp})) {
                        that.trigger('vpoint_missing', vp);
                    }
                });
            });
            window.onerror = _.throttle(function (e) {
                if (typeof e === "string") {
                    that.trigger('js_error', e.substring(0, 256))
                }
            }, 500);
        };
    };
    _.extend(SCOPE.ErrorDetector.prototype, Backbone.Events);
})(IV);
(function (SCOPE) {
    SCOPE.Session = function (iRoll) {
        var
            that = this, config, errorReportingSample, isMonitored = iRoll.get('forceSessionMonitoring'), sampleOverrides = {};
        this.getConfigValue = function (key) {
            if (config && config.hasOwnProperty(key)) {
                return config[key];
            }
        };
        this.isMonitored = function (eventId) {
            var sampleRateRec = getSampleRateRecord(eventId);
            return sampleRateRec.isMonitored;
        };
        this.getSampleRate = function (eventId) {
            var sampleRateRec = getSampleRateRecord(eventId);
            return sampleRateRec.sampleRate;
        };
        function getSampleRateRecord(eventId) {
            if (_.isUndefined(iRoll.get('data')['placement-config']) || iRoll.get('data')['placement-config']['placement-hash'] === "-1") {
                return {sampleRate: 1, isMonitored: true};
            }
            var globalSampleRateRec = {sampleRate: errorReportingSample, isMonitored: isMonitored};
            if (_.isUndefined(eventId)) {
                return globalSampleRateRec;
            } else {
                if (sampleOverrides.hasOwnProperty(eventId)) {
                    return sampleOverrides[eventId];
                } else {
                    return globalSampleRateRec;
                }
            }
        }

        function init() {
            if (iRoll.get('enableSessionRuntimeConfig')) {
                var runtimeConfigUrl = iRoll.get('runtimeConfigUrl');
                if (runtimeConfigUrl) {
                    fetchRuntimeConfig(runtimeConfigUrl, onRuntimeConfigFetched);
                }
            }
        }

        function fetchRuntimeConfig(runtimeConfigUrl, cb) {
            $.ajax({url: runtimeConfigUrl, dataType: 'jsonp', jsonpCallback: 'iv_mc_callback', success: cb});
        }

        function onRuntimeConfigFetched(data) {
            if (!data)return;
            config = data;
            errorReportingSample = toSampleRate(that.getConfigValue('error-reporting-sample'));
            if (isMonitored === false && !_.isUndefined(errorReportingSample)) {
                isMonitored = isChosenAsSample(errorReportingSample);
            }
            var sampleOverridesConf = that.getConfigValue('sample-overrides');
            if (_.isObject(sampleOverridesConf)) {
                _.each(sampleOverridesConf, function (val, key) {
                    var sampleRate = toSampleRate(val);
                    sampleOverrides[key] = {sampleRate: sampleRate, isMonitored: isChosenAsSample(sampleRate)};
                });
            }
            that.trigger('config-loaded');
        }

        function toSampleRate(val) {
            var samplerate = parseFloat(val);
            if (!isNaN(samplerate) && samplerate >= 0 && samplerate <= 1) {
                return samplerate;
            } else {
                return 0;
            }
        }

        function isChosenAsSample(sampleRate) {
            var rand = Math.random(), chosen = false;
            if (rand < sampleRate) {
                chosen = true;
            }
            return chosen;
        }

        init();
    };
    _.extend(SCOPE.Session.prototype, Backbone.Events);
})(IV);
(function (SCOPE) {
    SCOPE.Canvas = function (iroll, mainContainer) {
        var el = document.createElement("DIV"), defaultFontSize = 16, that = this, currentWidth, currentHeight, currentOrientation;
        el.id = "iv-iroll";
        mainContainer.appendChild(el);
        $(el).one('mouseover', "*", function (event) {
            event.stopPropagation();
            if (SCOPE.device.getPlatformType() === 'desktop') {
                SCOPE.Events.trigger(iroll.get('id') + ':interact');
            }
        });
        function init() {
            var adSize = that.getSize();
            currentWidth = adSize.width;
            currentHeight = adSize.height;
            currentOrientation = SCOPE.device.getDeviceOrientation(adSize.width, adSize.height);
            setInterval(monitorWindowWidth, 500);
            if (typeof $.fn.registerTouch === 'function') {
                $(el).registerTouch();
            }
            $(el).attr("platform-type", SCOPE.device.getPlatformType());
            $(el).attr("os-type", SCOPE.device.getOSType());
            addMouseCaptureOverlay();
        }

        function monitorWindowWidth() {
            var adSize = that.getSize();
            if (currentWidth !== adSize.width || currentHeight !== adSize.height) {
                currentWidth = adSize.width;
                currentHeight = adSize.height;
                SCOPE.Events.trigger('winResize');
            }
            var newOrientation = SCOPE.device.getDeviceOrientation(adSize.width, adSize.height);
            if (currentOrientation !== newOrientation) {
                currentOrientation = newOrientation;
                SCOPE.Events.trigger('orientationChange');
            }
            $(el).attr("orientation", newOrientation);
        }

        function addMouseCaptureOverlay() {
            var overlay = buildResponsiveContainer();
            overlay.addClass("iv-mouse-capture-overlay");
            $(el).append(overlay);
            $(overlay).on(iroll.getVideoClickEventType(), function (ev) {
                SCOPE.Events.trigger("video_click", ev);
            });
            $(overlay).on("touchmove", function (ev) {
                ev.preventDefault();
            })
        }

        function buildResponsiveContainer(className) {
            var cont = $('<div/>'), sizes = that.getSize();
            cont.addClass(className);
            cont.width(sizes.width).height(sizes.height);
            SCOPE.Events.on('winResize', function () {
                var newSizes = that.getSize();
                cont.width(newSizes.width).height(newSizes.height);
            });
            return cont;
        }

        this.addElement = function (elem) {
            if (elem) {
                $(el).append(elem);
            }
        };
        this.addResponsiveElement = function (elem) {
            if (elem) {
                var cont = buildResponsiveContainer("iv-elem-cont");
                cont.append(elem);
                $(el).append(cont);
            }
        };
        this.getSize = function () {
            var externalInterface = iroll.get('interface');
            if (externalInterface !== null && _.isFunction(externalInterface.getAdSize)) {
                return externalInterface.getAdSize();
            } else {
                return {"width": $(window).width(), "height": $(window).height()};
            }
        };
        this.getScale = function () {
            var adSize = this.getSize(), config = iroll.get('config'), platformScale = SCOPE.toolkit.getPlatformScaleParameter(config.platformScaling)
            var maxAdDimension = Math.max(adSize.width, adSize.height), adScale = maxAdDimension / config.previewParam.width;
            return adScale / platformScale;
        };
        this.getDefaultFontSize = function () {
            return defaultFontSize
        };
        this.setScale = function (scale) {
            $(el).css({fontSize: scale});
        };
        this.remove = function () {
            if (el !== null) {
                while (el.firstChild) {
                    el.removeChild(el.firstChild);
                }
                el.parentNode.removeChild(el);
                el = null;
            }
        };
        this.injectCss = function (cssPath) {
            var ownerDoc = el.ownerDocument;
            var linkRef = ownerDoc.createElement("link");
            linkRef.setAttribute("rel", "stylesheet");
            linkRef.setAttribute("type", "text/css");
            linkRef.setAttribute("href", cssPath);
            (ownerDoc.head || ownerDoc.getElementsByTagName("head")[0]).appendChild(linkRef);
        };
        this.registerInteractEvent = function () {
            $(el).on(iroll.get('mainEngagementEvent'), "*", function (event) {
                event.stopPropagation();
                $(event.currentTarget).trigger("interact", event);
            });
            $(el).on(iroll.getVideoClickEventType(), "*", function (event) {
                event.stopPropagation();
                $(event.currentTarget).trigger("interact-to-play", event);
            });
        };
        init.apply(this);
    };
})(IV);
(function (SCOPE) {
    SCOPE.AppsCore = Backbone.Model.extend({
        defaults: {
            sendLogs: false,
            playStartTime: null,
            interface: null,
            debug: false,
            autoscale: false,
            appPath: '',
            servicePath: '',
            nonCdnServicePath: '',
            reportUrl: '',
            errorReportUrl: '',
            runtimeConfigUrl: '',
            version: 'unknown',
            el: null,
            mainContainer: null,
            videoContainer: null,
            appsContainer: null,
            durationBar: null,
            plugins: {},
            data: {},
            config: {},
            toolbar: null,
            id: null,
            sysLog: [],
            CloseButton: false,
            BackButton: false,
            CloseButtonTimeout: 5000,
            windowOpen: null,
            appModeCustomEvents: {
                iOSPauseURL: 'EXTENSION_STOP',
                iOSPlayURL: 'EXTENSION_PLAY',
                iOSClickThrewURL: 'EXTENSION_OPEN_URL:'
            },
            showClickToResume: true,
            delayAppVisibility: true,
            mainEngagementEvent: 'tap',
            displayVideo: true,
            supportHLS: true,
            inlinePlaybackForced: true,
            videoPlayer: null,
            enableErrorReporting: true,
            checkForVisibility: false,
            linearOverStream: false,
            reportDummyErrorPixel: false,
            enableSessionRuntimeConfig: true,
            forceSessionMonitoring: false,
            reportImpressionsToLog: true
        }, canvas: null, session: null, report: null, errorDetector: null, initTimestamp: 0, initialize: function () {
            var that = this, baseData = SCOPE.baseData;
            if (!this.get('autoscale')) {
                $('head').append('<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, ' + 'minimum-scale=1, width=device-width, target-densitydpi=device-dpi">');
            }
            this.set({
                'appPath': baseData.appPath,
                'servicePath': baseData.servicePath,
                'nonCdnServicePath': baseData.nonCdnServicePath,
                'cssPath': baseData.cssPath,
                'reportUrl': baseData.reportUrl,
                'errorReportUrl': baseData.errorReportUrl,
                'runtimeConfigUrl': baseData.runtimeConfigUrl,
                'version': baseData.mobileCoreVersion
            });
            this.set('id', _.uniqueId('IV_'));
            this.on('init', function () {
                that.session = new SCOPE.Session(that);
                that.report = that.report || new SCOPE.reportAnalytics({
                        instance: that.toJSON(),
                        instanceClass: that,
                        session: that.session
                    });
                that.bindErrorEvents();
                that.bindAnalyticsEvents();
                that.bindSystemEvents();
                var id = this.get('id');
                SCOPE.Events.on(id + ':video_videoPassed1Sec', function () {
                    if (that.get('delayAppVisibility')) {
                        $(".in-app-icon, #iv-tray, .floating-icon-container").css({"visibility": "visible"});
                    }
                });
                SCOPE.Events.trigger(id + ':core_initialized', this);
                SCOPE.Events.trigger("IRollInit", this);
                that.createCanvas();
                this.initTimestamp = new Date().getTime();
            });
            if (!this.get('sendLogs')) {
                this.bindTrackingEvents();
            }
            SCOPE.Events.on(this.get('id') + ':appClickThru', function () {
                if (this.get('displayVideo')) {
                    if (this.get('videoPlayer').isPlaying()) {
                        var hideControls = (this.get('showClickToResume') === false);
                        this.get('videoPlayer').pause(hideControls);
                    }
                }
            }, that);
        }, setAttribute: function (attrs) {
            if (_.isObject(attrs)) {
                this.set(attrs, {silent: true});
            }
        }, $log: function () {
            if (this.get('debug')) {
            }
        }, injectVideo: function () {
            var data = this.get('data'), that = this;
            if (!this.has('videoPlayer')) {
                this.set('videoPlayer', new SCOPE.InternalVideoPlayer());
            }
            this.get('videoPlayer').init(data, this);
            if (data.video) {
                this.loadVideoSource(data.video.renditions, this);
            }
            this.get('videoPlayer').on("interact", function (ev) {
                that.videoClickThru(ev);
            });
        }, loadVideoSource: function (renditions) {
            if (this.get('linearOverStream') !== true) {
                this.get('videoPlayer').loadVideoSource(renditions);
            }
        }, injectCSSToDoc: function () {
            this.canvas.injectCss(this.get('cssPath'));
        }, removeVideo: function () {
            if (this.get('videoPlayer')) {
                this.get('videoPlayer').pause();
            }
        }, cleanUp: function () {
            SCOPE.Events.off();
            if (this.get('videoPlayer') && typeof this.get('videoPlayer').cleanUp === 'function') {
                this.get('videoPlayer').cleanUp();
            }
            this.canvas.remove();
        }, initAppsSystem: function () {
            if (this.get('reportDummyErrorPixel')) {
                this.report.reportLog({event_id: 'dummy'});
            }
            if (this.get('displayVideo')) {
                this.injectVideo();
            }
            SCOPE.Events.trigger('IRollReady', this, this.get('data'));
            SCOPE.Events.trigger(this.get('id') + ':impression', this);
        }, createCanvas: function () {
            var canvasContainer = null;
            if (_.isNull(this.get("mainContainer"))) {
                canvasContainer = document.body;
            } else {
                canvasContainer = this.get("mainContainer");
            }
            this.canvas = new SCOPE.Canvas(this, canvasContainer);
        }, windowOpen: function (url) {
            SCOPE.Events.trigger(this.get('id') + ':openUrl', url);
            SCOPE.Events.trigger(this.get('id') + ':appClickThru', url);
            if (_.isFunction(this.get('interface')['windowOpen'])) {
                this.get('interface')['windowOpen'](url);
            }
        }, supportFeature: function (feature) {
            var externalInterface = this.get('interface');
            if (externalInterface !== null && typeof externalInterface.supports === 'function') {
                return externalInterface.supports(feature);
            } else {
                return false;
            }
        }, onInteract: function (elem, func) {
            elem.on(this.get('mainEngagementEvent'), func);
        }, reportEngage: function (eventId) {
            var that = this;
            that.report.submit({action: 'engage', event_id: eventId});
            SCOPE.Events.trigger(that.get('id') + ":engage");
        }, reportInteract: function () {
            this.report.submit({action: 'intrct'});
            this.fireTrackingEvent('adFirstInteraction');
        }, bindAnalyticsEvents: function () {
            var that = this, id = this.get('id'), playFired = false, engaged = false, interactedBeforePlay = false;
            SCOPE.Events.on(id + ':userClick', function () {
                if (engaged) {
                    return;
                }
                engaged = true;
                that.reportEngage('user');
            });
            SCOPE.Events.on(id + ':auto_engage', function () {
                if (engaged) {
                    return;
                }
                engaged = true;
                that.reportEngage('default');
            });
            SCOPE.Events.on(id + ':core_initialized', function () {
                that.report.submit({action: 'init', size: $(window).width() + 'x' + $(window).height()});
            });
            SCOPE.Events.on(id + ':interact', _.once(function () {
                if (playFired) {
                    that.reportInteract();
                }
                else {
                    interactedBeforePlay = true;
                }
            }));
            SCOPE.Events.on(id + ':ad_play', function () {
                if (!playFired) {
                    SCOPE.Events.trigger(id + ':videoStarted');
                    SCOPE.Events.trigger(id + ':ad_started');
                    playFired = true;
                    that.set({playStartTime: new Date().getTime()});
                    that.report.submit({action: 'play'});
                    that.fireTrackingEvent('playingStart');
                    if (that.get('reportImpressionsToLog')) {
                        that.report.reportLog({event_id: 'impression'});
                    }
                    if (interactedBeforePlay) {
                        that.reportInteract();
                    }
                }
            });
            SCOPE.Events.on(id + ':video_videoPassed25', _.once(function () {
                that.report.submit({action: 'vpoint', event_value: 25, event_id: 'percent'});
                that.fireTrackingEvent('playingFirstQuartile');
            }));
            SCOPE.Events.on(id + ':video_videoPassed50', _.once(function () {
                that.report.submit({action: 'vpoint', event_value: 50, event_id: 'percent'});
                that.fireTrackingEvent('playingMidpoint');
            }));
            SCOPE.Events.on(id + ':video_videoPassed75', _.once(function () {
                that.report.submit({action: 'vpoint', event_value: 75, event_id: 'percent'});
                that.fireTrackingEvent('playingThirdQuartile');
            }));
            SCOPE.Events.on(id + ':ad_ended', _.once(function () {
                that.report.submit({action: 'vpoint', event_value: 100, event_id: 'percent'});
                that.fireTrackingEvent('playingComplete');
            }));
            SCOPE.Events.on(id + ':video_videoPassedCustomPoint', function () {
                _.each(that.get('data').customMetrics, function (url) {
                    that.report.submit3rdPatyTracking(url);
                });
            });
        }, bindSystemEvents: function () {
            SCOPE.Events.on('appsDataReady', this.initAppsSystem, this);
            SCOPE.Events.on('startApps', this.initAppsSystem, this);
            SCOPE.Events.on('orientationchange', function () {
                SCOPE.Events.trigger('repaint');
            });
            this.on('start', this.initAppsSystem, this);
        }, bindTrackingEvents: function () {
            var that = this, id = this.get('id');
            var eventsList = {};
            if (_.isObject(this.get('data')['placement-config'])) {
                eventsList = this.get('data')['placement-config']['tracking-events'];
            }
            _.forEach(eventsList, function (urls, eventName) {
                var handler = _.bind(that.reportTrackingEvent, that, eventName, urls);
                SCOPE.Events.on(id + ':tracking:' + eventName, handler);
            });
        }, bindErrorEvents: function () {
            this.errorDetector = new SCOPE.ErrorDetector(this);
            this.errorDetector.on("all", function (eventId, eventValue) {
                this.report.reportLog({event_id: eventId, event_value: eventValue || ''});
            }, this);
            this.errorDetector.startListener();
        }, fireTrackingEvent: function (eventName) {
            var id = this.get('id'), event = id + ':tracking:' + eventName;
            SCOPE.Events.trigger(event);
        }, reportTrackingEvent: function (eventName, urls) {
            var that = this;
            _.forEach(urls, function (url) {
                that.report.submit3rdPatyTracking(url);
            });
        }, videoClickThru: function (ev) {
            var toolbar = SCOPE.baseData.app_data['toolbar'];
            this.report.submit({
                action: 'click',
                event_id: 'position',
                event_value: ev.pageX + 'x' + ev.pageY,
                relative_time: (new Date().getTime() - this.get('playStartTime'))
            });
            if (toolbar && toolbar.data.engagementType === "minisite" && (!toolbar.data.clickBehavior || toolbar.data.clickBehavior === "open-microsite")) {
                SCOPE.Events.trigger('openMicrosite', true);
            }
            else if (SCOPE.baseData.app_data['video-clicks'] && SCOPE.baseData.app_data['video-clicks']['click-thru-url']) {
                var url = SCOPE.baseData.app_data['video-clicks']['click-thru-url'];
                var hideControls = this.get('showClickToResume') === false;
                this.get('videoPlayer').pause(hideControls);
                this.report.submit({
                    action: 'clktru',
                    event_id: 'main',
                    relative_time: (new Date().getTime() - this.get('playStartTime'))
                });
                SCOPE.Events.trigger(this.get('id') + ':userClick');
                SCOPE.Events.trigger(this.get('id') + ':openUrl', url);
                SCOPE.Events.trigger(this.get('id') + ':videoClicked', url);
                if (_.isFunction(this.get('interface')['windowOpen'])) {
                    this.get('interface')['windowOpen'](url);
                }
                return false;
            }
            return true;
        }, getVideoClickEventType: function () {
            if (SCOPE.device.needsClickEventToPlay()) {
                return 'click';
            } else {
                return this.get('mainEngagementEvent');
            }
        }, isHidden: function () {
            var prop = SCOPE.device.getHiddenProp();
            if (!prop)return false;
            return document[prop];
        }
    });
})(IV);
(function (SCOPE) {
    if (_.isUndefined(SCOPE.Events)) {
        SCOPE.Events = function () {
        };
        _.extend(SCOPE.Events, Backbone.Events);
    }
})(IV);
(function (SCOPE) {
    SCOPE.VideoSpy = function (videoElem) {
        this.videoElem = videoElem;
        this.state = null;
        var instance = this, activityLog = new SCOPE.ActivityLog(), passedPoints = {
            pass1sec: false,
            pass25: false,
            pass50: false,
            pass75: false,
            cvv: false
        }, customPoint = null, lastPlayingTime = 0;
        this.MAX_BUFFERING_COUNT = 5;
        this.MAX_BUFFERING_TIMES = [4000, 6000, 8000];
        this.SHORT_BUFFERING_TIME = 200;
        this.setCustomPoint = function (time) {
            customPoint = time
        };
        function fireEvent(eventName, newState, ev) {
            instance.trigger(eventName, ev);
            if (newState) {
                if (isValidState(newState)) {
                    instance.state = newState;
                    activityLog.log(newState);
                }
                else {
                    throw("invalid video state");
                }
            }
        }

        function fireErrorEvent(errorType, ev) {
            instance.trigger(errorType, ev);
        }

        function isValidState(state) {
            var validStates = ['playing', 'paused', 'ended'];
            return (validStates.indexOf(state) != -1);
        }

        function onTimeUpdate(elem, ev) {
            var tDelta = (elem.getCurrentTime() - lastPlayingTime);
            if (tDelta > 1.0) {
                playingHeartbeat(elem.getCurrentTime());
            }
            setPassedPoint(elem.getCurrentTime(), elem.getDuration());
            var data = {"currentTime": elem.getCurrentTime(), "duration": elem.getDuration(), "ev": ev};
            fireEvent('video_timeupdate', null, data);
        }

        function playingHeartbeat(currentTime) {
            lastPlayingTime = currentTime;
            activityLog.log('playing');
        }

        function setPassedPoint(currentTime, duration) {
            var currentProgress = 100 * currentTime / duration;
            if (currentTime > 1 && !passedPoints.pass1sec) {
                passedPoints.pass1sec = true;
                fireEvent('video_videoPassed1Sec', null);
            }
            if (currentProgress > 25 && !passedPoints.pass25) {
                passedPoints.pass25 = true;
                fireEvent('video_videoPassed25', null);
            }
            if (currentProgress > 50 && !passedPoints.pass50) {
                passedPoints.pass50 = true;
                fireEvent('video_videoPassed50', null);
            }
            if (currentProgress > 75 && !passedPoints.pass75) {
                passedPoints.pass75 = true;
                fireEvent('video_videoPassed75', null);
            }
            if (customPoint !== null) {
                if (currentTime > customPoint && !passedPoints.cvv) {
                    passedPoints.cvv = true;
                    fireEvent('video_videoPassedCustomPoint', null);
                }
            }
        }

        videoElem.on('stalled', function () {
            if (instance.state !== "paused") {
                activityLog.log('buffering');
                fireEvent("buffering", null);
            }
        });
        videoElem.on('waiting', function () {
            if (instance.state !== "paused") {
                activityLog.log('buffering');
                fireEvent("buffering", null);
            }
        });
        videoElem.on('playing', function () {
            activityLog.log('playing');
        });
        videoElem.on('durationchange', fireEvent.bind({}, 'video_durationchange', null));
        videoElem.on('playing', fireEvent.bind({}, 'video_play', 'playing'));
        videoElem.on('playing', _.once(fireEvent.bind({}, 'video_started', null)));
        videoElem.on('pause', fireEvent.bind({}, 'video_pause', 'paused'));
        videoElem.on('timeupdate', onTimeUpdate.bind({}, videoElem));
        videoElem.on('ended', fireEvent.bind({}, 'video_ended', 'ended'));
        videoElem.on('webkitendfullscreen', fireEvent.bind({}, 'video_exitfullscreen', null));
        videoElem.on('error', fireErrorEvent.bind({}, 'video_error'));
        _.each(videoElem.getAllSourceChildren(), function (elem) {
            $(elem).on('error', fireErrorEvent.bind({}, 'video_source_error'));
        });
        activityLog.onCount('buffering', this.MAX_BUFFERING_COUNT, fireErrorEvent.bind({}, 'video_high_buffering_count', this.MAX_BUFFERING_COUNT));
        _.each(this.MAX_BUFFERING_TIMES, function (time) {
            activityLog.onTime('buffering', time, fireErrorEvent.bind({}, 'video_long_buffering_time', time));
        });
        activityLog.onTime('buffering', this.SHORT_BUFFERING_TIME, fireEvent.bind({}, "video_short_buffering_time", null));
    };
    _.extend(SCOPE.VideoSpy.prototype, Backbone.Events);
})(IV);
(function (SCOPE) {
    function renderCloseButton(core) {
        var closeButton = $('<div id="iv-close-btn" />');
        closeButton.on(core.get('mainEngagementEvent'), function (ev) {
            ev.preventDefault();
            core.report.submit({action: 'close', event_value: 'click'});
            SCOPE.Events.trigger(core.get('id') + ':close');
        });
        core.canvas.addElement(closeButton);
        SCOPE.Events.trigger("closeButtonRendered");
    }

    function unrenderCloseButton() {
        SCOPE.Events.trigger("closeButtonUnrendered");
    }

    SCOPE.Events.on("IRollReady", function (core) {
        var showCloseButton = core.get('CloseButton'), waitTillImpression = core.get('CloseButtonWaitToImpression');
        if (showCloseButton || waitTillImpression) {
            SCOPE.Events.trigger("closeButtonEnabled");
            var renderFn;
            if (showCloseButton) {
                renderFn = _.once(renderCloseButton.bind(this, core));
            } else {
                renderFn = unrenderCloseButton;
            }
            var timeout = parseInt(core.get('CloseButtonTimeout'), 10);
            if (isNaN(timeout))timeout = 0;
            var timer = setTimeout(function () {
                renderFn();
            }, timeout);
            SCOPE.Events.on(core.get('id') + ':ad_started', function () {
                clearTimeout(timer);
                renderFn();
            });
        }
    });
})(IV);
(function (SCOPE) {
    SCOPE.IRollSimpleTracker = function (eventHandler, eventPrefix) {
        var map = {
            "expand": "dialogOpened",
            "clickthru": "openUrl",
            "engage": "engage",
            "impression": "ad_started",
            "firstquartile": "video_videoPassed25",
            "midpoint": "video_videoPassed50",
            "thirdquartile": "video_videoPassed75",
            "completion": "ad_ended"
        };
        this.registerCustomPixels = function (customPixels) {
            _.each(customPixels, function (urls, eventName) {
                var iRollEventName = mapEventNameToIRollEventName(eventPrefix, eventName);
                if (iRollEventName !== null) {
                    var urlArr = urls;
                    if (!_.isArray(urlArr)) {
                        urlArr = new Array(urlArr);
                    }
                    _.each(urlArr, function (val) {
                        eventHandler.on(iRollEventName, function () {
                            fireCustomPixel(val);
                        });
                    });
                }
            });
        };
        function fireCustomPixel(url) {
            var req = new Image();
            req.src = url;
        }

        function mapEventNameToIRollEventName(eventPrefix, eventName) {
            if (map.hasOwnProperty(eventName)) {
                return eventPrefix + map[eventName];
            } else {
                return null;
            }
        }
    };
})(IV);
(function (SCOPE) {
    SCOPE.VideoRenditions = (function () {
        function VideoRenditions() {
            var renditionsMap = {
                "iphone_stream": {
                    "mimetype": "application/x-mpegurl",
                    "device": ["iPhone", "iPod", "iPad", "Android"],
                    "extension": "m3u8",
                    "isHLS": true
                },
                "low.mp4": {"mimetype": "video/mp4"},
                "mp4": {"mimetype": "video/mp4"},
                "high.mp4": {"mimetype": "video/mp4", "device": ["Desktop"]},
                "webm": {"mimetype": "video/webm"}
            };
            var renditionsPriority = ["high.mp4", "iphone_stream", "low.mp4", "mp4", "webm"];
            this.disableSupport = function (name) {
                if (supported(name)) {
                    delete renditionsMap[name];
                }
                return this;
            };
            this.add = function (name, url) {
                if (supported(name)) {
                    renditionsMap[name]["src"] = filterURL(name, url);
                }
                return this;
            };
            this.isDeviceSupported = function (name, device, supportsHLS) {
                var deviceSupported = false;
                if (supported(name)) {
                    var rend = renditionsMap[name];
                    if (rend.hasOwnProperty("device")) {
                        deviceSupported = (rend["isHLS"]) ? (rend["device"].indexOf(device) != -1) && supportsHLS : (rend["device"].indexOf(device) != -1);
                    }
                    else {
                        deviceSupported = true;
                    }
                }
                return deviceSupported;
            };
            this.getIterator = function () {
                return new VideoRenditionsIterator(renditionsMap, renditionsPriority);
            };
            function supported(name) {
                return renditionsMap.hasOwnProperty(name);
            }

            function filterURL(name, url) {
                if (renditionsMap.hasOwnProperty(name)) {
                    var rendition = renditionsMap[name];
                    if (rendition.hasOwnProperty("extension")) {
                        url = url.replace("." + name, "." + rendition["extension"]);
                    }
                }
                return url;
            }
        }

        var VideoRenditionsIterator = (function () {
            function VideoRenditionsIterator(renditions, order) {
                this.renditions = renditions;
                this.order = order;
                this.current = 0;
            }

            VideoRenditionsIterator.prototype.next = function () {
                var i = this.current;
                var rendWithSrc = null;
                while (i < _.size(this.order) && rendWithSrc === null) {
                    var rend = this.renditions[this.order[i]];
                    if (_.isObject(rend) && rend.hasOwnProperty("src")) {
                        rendWithSrc = rend;
                        this.current = i + 1;
                    }
                    i++;
                }
                return rendWithSrc;
            };
            VideoRenditionsIterator.prototype.reset = function () {
                this.current = 0;
            };
            return VideoRenditionsIterator;
        })();
        return VideoRenditions;
    })();
})(IV);
(function (SCOPE) {
    SCOPE.ActivityLog = function () {
        var eventsMap = [], countListeners = [], timers = [], runningTimers = [];
        this.log = function (event) {
            var now = new Date().getTime(), newCount;
            if (this.has(event)) {
                newCount = ++eventsMap[event].count;
                eventsMap[event].time = now;
            } else {
                newCount = 1;
                eventsMap[event] = {"count": newCount, "time": now};
            }
            resetAllTimers();
            startEventTimers(event);
            notifyCountListeners(event, newCount);
            return this;
        };
        this.getCount = function (event) {
            var count = 0;
            if (this.has(event)) {
                count = eventsMap[event].count;
            }
            return count;
        };
        this.has = function (event) {
            return event in eventsMap;
        };
        this.onCount = function (event, count, cb, context) {
            if (!(event in countListeners)) {
                countListeners[event] = [];
            }
            if (!(count in countListeners[event])) {
                countListeners[event][count] = [];
            }
            countListeners[event][count].push({"callback": cb, "context": context});
        };
        this.onTime = function (event, time, cb, context) {
            if (!(event in timers)) {
                timers[event] = [];
            }
            timers[event].push({"time": time, "cb": cb, "context": context});
        };
        function notifyCountListeners(ev, count) {
            if (ev in countListeners && count in countListeners[ev]) {
                for (var cb in countListeners[ev][count]) {
                    if (countListeners[ev][count].hasOwnProperty(cb)) {
                        var listenerObj = countListeners[ev][count][cb];
                        var context = listenerObj.context !== 'undefined' ? listenerObj.context : null;
                        listenerObj.callback.call(context, ev, count);
                    }
                }
            }
        }

        function resetAllTimers() {
            for (var i = 0; i < runningTimers.length; i++) {
                if (typeof runningTimers[i] === "number") {
                    clearTimeout(runningTimers[i]);
                }
            }
        }

        function startEventTimers(ev) {
            if (ev in timers) {
                for (var i = 0; i < timers[ev].length; i++) {
                    var job = timers[ev][i];
                    var taskId = createTimeoutTask(job.cb, job.context, job.time);
                    runningTimers.push(taskId);
                }
            }
        }

        function createTimeoutTask(cb, context, time) {
            return setTimeout(function () {
                cb.apply(context)
            }, time);
        }
    };
})(IV);
(function (SCOPE) {
    var device = function () {
        this.getPlatformType = function () {
            var ua = this.getNavigatorUserAgent();
            return ua.match(/GoogleTV|SmartTV|Internet.TV|NetCast|NETTV|AppleTV|boxee|Kylo|Roku|DLNADOC|CE\-HTML/i) ? 'tv' : ua.match(/Xbox|PLAYSTATION.3|PLAYSTATION.4|Wii/i) ? 'tv' : ua.match(/iPad/i) || ua.match(/tablet/i) && !ua.match(/RX-34/i) || ua.match(/FOLIO/i) ? 'tablet' : ua.match(/Linux/i) && ua.match(/Android/i) && !ua.match(/Fennec|mobi|HTC.Magic|HTCX06HT|Nexus.One|SC-02B|fone.945/i) ? 'tablet' : ua.match(/Kindle/i) || ua.match(/Mac.OS/i) && ua.match(/Silk/i) ? 'tablet' : ua.match(/Opera/i) && ua.match(/Windows.NT.5/i) && ua.match(/HTC|Xda|Mini|Vario|SAMSUNG\-GT\-i8000|SAMSUNG\-SGH\-i9/i) ? 'mobile' : ua.match(/Windows.(NT|XP|ME|9)/) && !ua.match(/Phone/i) || ua.match(/Win(9|.9|NT)/i) ? 'desktop' : ua.match(/Macintosh|PowerPC/i) && !ua.match(/Silk/i) ? 'desktop' : ua.match(/Linux/i) && ua.match(/X11/i) ? 'desktop' : ua.match(/Solaris|SunOS|BSD/i) ? 'desktop' : 'mobile'
        };
        this.isAndroid = function () {
            var userAgent = this.getNavigatorUserAgent();
            return (userAgent.match(/android/i) !== null);
        };
        this.is_iOS = function () {
            var userAgent = this.getNavigatorUserAgent();
            return userAgent.match('iPod') || userAgent.match('iPhone') || userAgent.match('iPad');
        };
        this.getOSType = function () {
            if (this.is_iOS()) {
                return "ios";
            }
            else if (this.isAndroid()) {
                return "android";
            }
            else {
                return "other"
            }
        };
        this.getDeviceName = function () {
            var userAgent = this.getNavigatorUserAgent();
            if (userAgent.match('iPod')) {
                return 'iPod';
            } else if (userAgent.match('iPad')) {
                return 'iPad';
            } else if (userAgent.match('iPhone')) {
                return 'iPhone';
            } else if (userAgent.match(/android/i)) {
                return 'Android';
            } else if (this.getPlatformType() === 'desktop') {
                return 'Desktop';
            }
            return undefined;
        };
        this.isDeviceHLSSupported = function () {
            if (this.is_iOS()) {
                return true;
            } else if (this.isAndroid() && versionAtLeastAsNewAs(this.getAndroidOSVersion(), "5.0")) {
                return true;
            }
            return false;
        };
        this.getDeviceInformation = function () {
            var device, resolution, version, orientation, os;
            var userAgent = this.getNavigatorUserAgent();
            if (userAgent.match('iPod')) {
                device = 'iPod';
                os = 'iOS';
            } else if (userAgent.match('iPad')) {
                device = 'iPad';
                os = 'iOS';
            } else if (userAgent.match('iPhone')) {
                device = 'iPhone';
                os = 'iOS';
            } else if (userAgent.match(/android/i)) {
                device = 'Android';
                os = 'Android';
            }
            else {
                return userAgent;
            }
            resolution = '(' + window.screen.width + 'x' + window.screen.height + ')';
            if (os == "iOS") {
                version = this.getiPhoneOSVersion();
            } else if (os == "Android") {
                version = this.getAndroidOSVersion();
            }
            orientation = this.getDeviceOrientation();
            return [device, resolution, version, orientation].join(', ');
        };
        this.getWebsiteHost = function () {
            var website;
            try {
                website = this.getLocationHost();
            } catch (e) {
            }
            if (_.isUndefined(website)) {
                website = getHostName(document.referrer);
            }
            return website;
        };
        this.canPlayInline = function () {
            return !(this.getDeviceName() === "iPod" || this.getDeviceName() === "iPhone")
        };
        this.getLocationHost = function () {
            return window.top.location.host;
        };
        this.getDeviceScreenSize = function () {
            return {
                w: Math.round(window.screen.width * window.devicePixelRatio),
                h: Math.round(window.screen.height * window.devicePixelRatio)
            };
        };
        this.getiPhoneOSVersion = function () {
            var match, userAgent = this.getNavigatorUserAgent();
            var version = this.is_iOS() ? 1.0 : false;
            if (!(match = /iP.+ OS (.*) like Mac OS X/.exec(userAgent))) {
            } else {
                version = parseInt(match[1].replace('_', ''), 10) / 100;
                if (version < 1) {
                    version *= 10;
                }
            }
            return version;
        };
        this.getAndroidOSVersion = function () {
            var match, userAgent = this.getNavigatorUserAgent();
            var version = '';
            if (!(match = /Android (\d+(?:\.\d+)+)/.exec(userAgent))) {
            } else {
                version = match[1];
            }
            return version;
        };
        this.getDeviceOrientation = function (width, height) {
            var deviceHeight = _.isUndefined(height) ? window.innerHeight : height, deviceWidth = _.isUndefined(width) ? window.innerWidth : width, aspectRatio = 1.3;
            return (deviceHeight * aspectRatio > deviceWidth) ? 'Portrait' : 'Landscape';
        };
        this.getDeviceScreenSizeClass = function () {
            var dim = this.getDeviceScreenSize();
            var screenSizeClass = 'small';
            if (!this.getiPhoneOSVersion() && !this.getAndroidOSVersion())return screenSizeClass;
            switch (dim.h) {
                case 480:
                    screenSizeClass = 'small';
                    break;
                case 960:
                    screenSizeClass = 'big';
                    break;
                case 1136:
                    screenSizeClass = 'big';
                    break;
                case 1024:
                    screenSizeClass = 'big';
                    break;
                case 2048:
                    screenSizeClass = 'big';
                    break;
                default:
                    if (dim.w >= 1280) {
                        screenSizeClass = 'big';
                    } else
                        screenSizeClass = 'small';
                    break;
            }
            return screenSizeClass;
        };
        this.supportsAnimations = function () {
            return (this.isAndroid() && versionAtLeastAsNewAs(this.getAndroidOSVersion().toString(), "4.1")) || (this.is_iOS() && versionAtLeastAsNewAs(this.getiPhoneOSVersion().toString(), "5.2"));
        };
        this.getNavigatorUserAgent = function () {
            return navigator.userAgent;
        };
        this.needsClickEventToPlay = function () {
            return this.isAndroid();
        };
        this.getHiddenProp = function () {
            var prefixes = ['webkit', 'moz', 'ms', 'o'];
            if ('hidden' in document)return 'hidden';
            for (var i = 0; i < prefixes.length; i++) {
                if ((prefixes[i] + 'Hidden') in document)
                    return prefixes[i] + 'Hidden';
            }
            return null;
        };
        this.needsElemForcedRedraw = function () {
            return this.isAndroid();
        };
        this.getDocumentQueryString = function () {
            return document.location.search;
        };
        this.getDeviceIdFromRequest = function () {
            var deviceId, queryString = this.getDocumentQueryString(), params;
            var currentScript = SCOPE._currentScript;
            if (currentScript && currentScript.src) {
                var scriptQueryString = currentScript.src.split("?")[1];
                if (scriptQueryString && scriptQueryString.indexOf("deviceid") !== -1) {
                    queryString = scriptQueryString;
                }
            }
            params = SCOPE.toolkit.parseQueryString(queryString);
            deviceId = params.deviceid;
            return deviceId;
        };
        function getHostName(url) {
            var a = document.createElement('a');
            a.href = url;
            return a.hostname;
        }

        function versionAtLeastAsNewAs(version, comparedTo) {
            if (!_.isString(version)) {
                return false;
            }
            var versionParts = version.split('.');
            var compareToParts = comparedTo.split('.');
            var i = 0, isNewer = true;
            while (isNewer === true && i < compareToParts.length) {
                if (i < versionParts.length) {
                    var versionPartNum = parseInt(versionParts[i], 10);
                    var compareToPartNum = parseInt(compareToParts[i], 10);
                    var delta = versionPartNum - compareToPartNum;
                    if (delta > 0) {
                        break;
                    } else if (delta < 0) {
                        isNewer = false;
                    }
                } else {
                    isNewer = false;
                }
                i++;
            }
            return isNewer;
        }
    };
    SCOPE.device = new device();
    SCOPE._currentScript = document.currentScript;
})(IV || {});
(function (SCOPE) {
    var root, wrap, zIndex = 1030, iroll, format;
    var Dialog = Backbone.Model.extend({
        initialize: function () {
            this.isOpen = false;
            var that = this;
            SCOPE.Events.on('appsSystemReady', this.registerContext, this);
            this.on('dialogCreated', function () {
                SCOPE.Events.on(iroll.get('id') + ':dialogOpened', function () {
                    iroll.fireTrackingEvent('adOverlayShowExpanded');
                    if (iroll.get('displayVideo')) {
                        iroll.get('videoPlayer').pause();
                    } else {
                        if (_.isFunction(iroll.get('interface')['pauseVideo'])) {
                            iroll.get('interface')['pauseVideo']();
                        }
                    }
                });
                SCOPE.Events.on(iroll.get('id') + ':dialogClosed', function () {
                    iroll.fireTrackingEvent('adOverlayHideExpanded');
                    if (iroll.get('displayVideo')) {
                        if (iroll.get('videoPlayer').getState() != 'ended') {
                            iroll.get('videoPlayer').play();
                        }
                    } else {
                        if (_.isFunction(iroll.get('interface')['playVideo'])) {
                            iroll.get('interface')['playVideo']();
                        }
                    }
                });
                SCOPE.Events.on(iroll.get('id') + ':closeDialog', function () {
                    that.close();
                });
            });
        }, registerContext: function (context) {
            format = context;
            iroll = context.getIRoll();
            root = context.getWrapper();
            this.createDialog();
            this.repaint();
            SCOPE.Events.on('repaint', this.repaint, this);
        }, repaint: function () {
            if (root && wrap) {
                var adSize = iroll.canvas.getSize();
                var h = adSize.height, w = adSize.width;
                wrap.width(w);
                wrap.height(h);
            }
            this.get('dialog').height(wrap.height());
            this.get('content').height(this.get('dialog').height());
        }, createDialog: function () {
            var that = this;
            if (!wrap) {
                wrap = $('<div class="dialog-wrapper"></div>').insertAfter(root).css({
                    display: 'none',
                    backgroundColor: '#fff',
                    position: root.css('position'),
                    top: root.css('top'),
                    left: root.css('left'),
                    zIndex: zIndex++
                });
            }
            var node = $('<div class="iv-overlay-node"></div>').appendTo(wrap);
            var head = $('<div class="iv-overlay-head"></div>').appendTo(node);
            var title = $('<div class="iv-overlay-title"></div>').appendTo(head);
            var shadowFilter = '<filter id="dropshadow" height="130%">' + '<feGaussianBlur in="SourceAlpha" stdDeviation="5"/>' + '<feOffset dx="2" dy="2" result="offsetblur"/>' + '<feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>' + '</filter>'
            var close;
            if (iroll.attributes.BackButton) {
                close = $('<svg class="back-button iv-close" width="240" height="100" ' + 'preserveAspectRatio="xMinYMin meet" viewBox="0 0 240 100">' +
                    shadowFilter + '<path d="m230,10l0,80l-190,0l-30,-40l30,-40l190,0z"  fill="#ff0000" filter="url(#dropshadow)"/>' + '<path class="close-background" d="m230,10l0,80l-190,0l-30,-40l30,-40l190,0z" ' + 'stroke="#ffffff" stroke-width="5" fill="#ffffff"/>' + '<text class="close-text" font-size="55" font-weight="bold" y="70" x="65" fill="#000000">Back</text>' + '</svg>');
            } else {
                close = $('<svg class="close-button iv-close" width="100" height="100" ' + 'preserveAspectRatio="xMinYMin meet" viewBox="0 0 100 100">' +
                    shadowFilter + '<ellipse ry="40" rx="40" cy="50" cx="50" stroke="#ffffff"  fill="#ffffff" filter="url(#dropshadow)"/>' + '<ellipse class="close-background" ry="40" rx="40" id="svg_2" cy="50" cx="50" ' + 'stroke="#ffffff" stroke-width="5" fill="#ffffff"/>' + '<path  class="close-text" fill="#000000"' + 'd="m37.5,27.5l12.5,12.5l12.5,-12.5l10,10l-12.5,12.5l12.5,12.5l-10,10l-12.5,-12.5l' + '-12.5,12.5l-10,-10l12.5,-12.5l-12.5,-12.5l10,-10z"/></svg>');
            }
            close.appendTo(head);
            var content = $('<div class="iv-overlay-contentarea"></div>').appendTo(node);
            node.addClass('dialog').css({position: 'absolute', zIndex: zIndex++});
            this.set('dialog', node);
            this.set('head', head);
            this.set('title', title);
            this.set('content', content);
            close.on(iroll.getVideoClickEventType(), function (ev) {
                SCOPE.Events.trigger("close" + format.getExpandedApp().id);
                _.bind(that.close, that);
                that.close();
                ev.preventDefault();
                ev.stopPropagation();
                SCOPE.Events.trigger(iroll.get('id') + ':userClick');
                iroll.report.submit({
                    action: 'click',
                    event_id: 'position',
                    event_value: ev.pageX + 'x' + ev.pageY,
                    relative_time: (new Date().getTime() - iroll.get('playStartTime'))
                });
                iroll.report.submit({
                    action: 'cxoff',
                    event_id: format.getExpandedApp().namespace || '',
                    event_value: 'click',
                    relative_time: (new Date().getTime() - iroll.get('playStartTime'))
                });
            });
            this.trigger('dialogCreated');
        }, open: function () {
            $(wrap).add(this.get('dialog')).css("display", "block");
            this.repaint();
            SCOPE.Events.trigger(iroll.get('id') + ':dialogOpened');
            this.isOpen = true;
            return this;
        }, close: function () {
            this.setTitle('').setContent('').showTitleBar();
            this.get('content').empty();
            $(wrap).add(this.get('dialog')).hide();
            SCOPE.Events.trigger(iroll.get('id') + ':dialogClosed');
            if (format.getFormat() === "expand") {
                format.resizeLayout();
                SCOPE.Events.trigger('repaint');
            }
            this.isOpen = false;
            format.setExpanded(false);
            return this;
        }, setTitle: function (title) {
            if (typeof title === 'string') {
                this.get('title').html('<h2>' + title + '</h2>');
            } else {
                this.get('title').empty().append(title);
            }
            return this;
        }, setContent: function (content) {
            this.get('content').empty().append(content);
            return this;
        }, hideTitleBar: function () {
            this.get('head').hide();
            return this;
        }, showTitleBar: function () {
            this.get('head').css("display", "block");
            return this;
        }, getContentSize: function () {
            return {h: this.get('content').height(), w: this.get('content').width()};
        }
    });
    SCOPE.Dialog = new Dialog();
})(IV);
(function (SCOPE) {
    var html5video = function (options, container) {
        var that = this, params = options || {}, defaults = {}, iroll = options.iroll;
        var videoControls = options.controls || ['resume'];
        var _videoControls = function (args) {
            var defaults = {show: false, showControls: videoControls || ['resume']};
            var params = args || {};
            var options = _.extend(defaults, params);
            var controlsBar = _.template('<div class="video-controls"></div>');
            var controlsButtons = {
                resume: '<a class="control control-resume" data-fn="play">&nbsp;</a>',
                play: '<a class="control control-play" data-fn="play">&nbsp;</a>'
            };
            if (options.show) {
                if (container.find('.video-controls').length > 0) {
                    $(container.find('.video-controls').remove());
                }
                var controls = $(controlsBar());
                _.each(options.showControls, function (control) {
                    var ctrl = controlsButtons[control];
                    controls.append(ctrl);
                    controls.find('.control').each(function () {
                        $(this).css({display: 'inline-block', cursor: 'pointer'});
                    });
                });
                $(container).append(controls).on(iroll.getVideoClickEventType(), '.control', function (ev) {
                    ev.preventDefault();
                    var action = $(this).attr('data-fn');
                    if (_.isFunction(that[action]))that[action]();
                });
            }
            else {
                $(container.find('.video-controls').remove());
            }
        };
        var _init = function () {
            that.el = document.createElement('video');
            $(that.el).css({
                width: "100%",
                height: "100%",
                top: 0,
                left: 0,
                position: 'absolute',
                'pointer-events': 'visible'
            });
            that.el.preload = true;
            that.el.controls = false;
            $(that.el).attr('webkit-playsinline', 'webkit-playsinline');
            $(that.el).addClass('iv-main-video');
            if (that.params.preview) {
                $(that.el).attr("poster", that.params.preview);
            } else {
                $(that.el).attr("poster", "data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=");
            }
        };
        this.setVideoSource = function (renditions) {
            var elem = new SCOPE.VideoElementWrapper(that.el);
            var videoLoader = new SCOPE.VideoSourceLoader(elem, iroll);
            videoLoader.loadVideoSource(renditions);
            return videoLoader.isLoaded();
        };
        this.play = function () {
            this.el.play();
            _videoControls({show: false});
        };
        this.resume = this.play;
        this.pause = function (hideControls) {
            this.el.pause();
            if (hideControls !== true) {
                _videoControls({show: true});
            }
        };
        this.stop = function () {
            this.el.stop();
            _videoControls({show: false});
        };
        this.showControls = function (controls) {
            _videoControls(_.extend({show: true}, controls || {}));
        };
        this.setSrc = function (src) {
            this.el.src = src;
        };
        this.getDuration = function () {
            return this.el.duration;
        };
        this.getCurrentTime = function () {
            return this.el.currentTime;
        };
        this.getRemainingTime = function () {
            return this.getDuration() - this.getCurrentTime();
        };
        this.load = function () {
            this.el.load();
        };
        this.events = _.extend({}, Backbone.Events);
        this.params = _.extend(defaults, params);
        _init();
    };
    SCOPE.html5video = html5video;
})(IV);
(function (SCOPE) {
    var icons = function () {
        this.setupIcon = function (app, delayAppVisibility) {
            var icon = $('<div></div>').addClass('iv-icon').addClass('in-app-icon').css({
                display: 'inline-block',
                visibility: 'hidden',
                zIndex: 25 + (app.get('app-order-index') || 0),
                cursor: 'pointer'
            });
            if (delayAppVisibility) {
                icon.css({visibility: 'hidden'});
            }
            app.set('icon', icon);
            return icon;
        };
        this.setIconDimensions = function (app, scaleParams, trayIconWidth, placeholder) {
            var iconCss, iconScale = scaleParams.floatingIconScale / scaleParams.iconScaling, iconWidth = trayIconWidth / scaleParams.iconScaling;
            if (placeholder.type === 'docked' && app.get('app-id') !== 'app-skip-ad') {
                iconScale = scaleParams.iconScale;
                iconWidth = trayIconWidth;
            }
            if (app.get('customLauncher') && app.get('customLauncher').url) {
                iconCss = this.getCustomLauncherCss(app.get('customLauncher'), iconScale);
            }
            else {
                if (app.get('app-id') === 'app-custom-icon') {
                    iconCss = this.getCustomIconCss(app.get('data'), iconScale);
                }
                else if ((app.get('app-id') !== 'app-text-label') && (app.get('app-id') !== 'app-skip-ad')) {
                    var iconImageSize = scaleParams.iconImageSize;
                    iconCss = this.getIconCss(app.get('icons'), iconImageSize, iconWidth);
                }
            }
            app.get('icon').css(iconCss);
        };
        this.getIconCss = function (iconImages, iconImageSize, trayIconWidth) {
            var imageUrl = '', maxWidth = 0;
            _.each(iconImages, function (appIcon) {
                if (appIcon.width <= iconImageSize && appIcon.width > maxWidth) {
                    imageUrl = appIcon.url;
                    maxWidth = appIcon.width;
                }
            });
            return {
                width: trayIconWidth,
                height: trayIconWidth,
                backgroundImage: (imageUrl) ? 'url(' + imageUrl + ')' : '',
                backgroundSize: 'contain',
                backgroundRepeat: 'no-repeat',
                lineHeight: trayIconWidth
            }
        };
        this.setIconPosition = function (icon, placeholder, scale, appsContainer, orderIndex) {
            var bounds = {width: $(appsContainer).width(), height: $(appsContainer).height()};
            var floatingIconWidth = icon.width(), floatingIconHeight = icon.height();
            var style = {
                zIndex: 25 + (orderIndex || 0),
                position: "absolute",
                left: Math.round((bounds.width - floatingIconWidth) * placeholder.left / 100 + placeholder.offsetX * scale) + 'px',
                top: Math.round((bounds.height - floatingIconHeight) * placeholder.top / 100 + placeholder.offsetY * scale) + 'px'
            };
            icon.css(style);
            forceIconRedraw(icon[0]);
        };
        this.getCustomIconCss = function (iconData, scale) {
            var width = Math.floor(iconData.width * iconData.scale * scale);
            var height = Math.floor(iconData.height * iconData.scale * scale);
            return {width: width, height: height, lineHeight: height}
        };
        this.getCustomLauncherCss = function (iconData, scale) {
            var customCss = this.getCustomIconCss(iconData, scale);
            customCss.backgroundImage = 'url(' + iconData.url + ')';
            customCss.backgroundSize = customCss.width + "px " + customCss.height + "px";
            return customCss
        };
        function forceIconRedraw(elem) {
            if (SCOPE.device.needsElemForcedRedraw()) {
                elem.style.display = 'inline-block';
                setTimeout(function () {
                    elem.style.display = '';
                }, 0);
            }
        }
    };
    SCOPE.icons = new icons();
})(IV);
(function (SCOPE) {
    SCOPE.reportAnalytics = Backbone.Model.extend({
        defaults: {
            sendLogs: true,
            instance: null,
            instanceClass: null,
            session: null,
            defaultReportData: {
                'ad_criteria': null,
                placement_tag_id: 0,
                r: '',
                viewer_id: '',
                action: '',
                session_id: '',
                client_id: -1,
                channel_id: 0,
                project_state: 0,
                video_id: 0,
                project_hash: '',
                placement_hash: -1,
                impression_id: '',
                event_id: '',
                website: 'unknown',
                publisher_id: 0,
                event_value: '',
                fver: null,
                real_estate_id: 0
            },
            childReportData: {manual_select_project_state: 8, auto_select_project_state: 10}
        },
        CONTEXT: {MANUAL_SELECT: 'manual_select_project_state', AUTO_SELECT: 'auto_select_project_state'},
        reportedUrls: [],
        errorLogQueue: [],
        loadedPixels: [],
        initialize: function () {
            var that = this, instanceData = this.get('instance'), reportData = {}, childReportData = this.get('childReportData'), placementConfig = instanceData.data['placement-config'];
            _.extend(reportData, this.get('defaultReportData'));
            that.reportedUrls = [];
            that.errorLogQueue = [];
            that.get('instanceClass').set({sendLogs: true});
            reportData.session_id = SCOPE.toolkit.randomId();
            reportData.viewer_id = SCOPE.toolkit.randomId();
            reportData.impression_id = SCOPE.toolkit.randomId();
            reportData.ver = instanceData.data['version'];
            if (SCOPE.device.getPlatformType() === "desktop") {
                reportData.website = SCOPE.device.getWebsiteHost();
            }
            else {
                reportData.website = SCOPE.device.getDeviceInformation();
            }
            reportData.website = reportData.website.substring(0, 128);
            if (_.isObject(placementConfig)) {
                reportData.placement_hash = placementConfig['placement-hash'] || '';
                reportData.placement_tag_id = placementConfig['placement-tag-id'] || 0;
                reportData.publisher_id = placementConfig['publisher-id'];
                reportData.channel_id = placementConfig['channel-id'];
                reportData.client_id = placementConfig['client-id'];
                reportData.project_hash = placementConfig['project-hash'];
                reportData.video_id = placementConfig['video-id'];
                reportData.project_state = placementConfig['project-state'];
                reportData.real_estate_id = placementConfig['real_estate_id'];
                childReportData.manual_select_project_state = placementConfig['child-manual-project-state'];
                childReportData.auto_select_project_state = placementConfig['child-auto-project-state'];
            } else {
                reportData.project_hash = instanceData.data['id'];
            }
            var deviceId = SCOPE.device.getDeviceIdFromRequest();
            if (deviceId) {
                reportData.device_id = deviceId;
            }
            this.url = this.get('instance').reportUrl;
            this.get('session').on('config-loaded', function () {
                that.flushErrorQueue();
            });
            this.set("reportData", reportData);
        },
        submit3rdPatyTracking: function (url) {
            if (!this.get('sendLogs'))return;
            var reportUrl = url || '', pattern = /(\[)(.*)(\])/ig, matchTimestamp;
            if (_.isArray(reportUrl)) {
                reportUrl = SCOPE.toolkit.trim(reportUrl.shift() || '');
            } else {
                reportUrl = SCOPE.toolkit.trim(reportUrl);
            }
            matchTimestamp = pattern.exec(reportUrl);
            if (matchTimestamp) {
                reportUrl = reportUrl.replace(pattern, new Date().getTime());
            }
            this.firePixel(reportUrl);
        },
        addReportDataToReportUrl: function (reportData, reportUrl) {
            _.each(reportData, function (val, key) {
                if (val === '')return;
                if (key == 'relative_time') {
                    val = (val / 1000).toFixed(3);
                }
                if (_.indexOf(['init', 'play', 'vpoint', 'engage'], reportData.action) !== -1) {
                    if (key == 'impression_id')return;
                }
                if (key == 'ad_criteria') {
                    if (_.indexOf(['click', 'clktru', 'clkint', 'cxon', 'cxoff'], reportData.action) != -1) {
                        val = null;
                    } else {
                        return;
                    }
                }
                if (key == 'real_estate_id') {
                    if (_.indexOf(['click', 'clktru', 'clkint', 'cxon', 'cxoff', 'engage'], reportData.action) == -1) {
                        return;
                    }
                }
                reportUrl += key + '=' + encodeURIComponent(val) + '&';
            });
            reportUrl = reportUrl.slice(0, -1);
            return reportUrl;
        },
        submit: function (options, context) {
            if (!this.get('sendLogs'))return;
            var that = this, params = options || {}, data = _.extend({}, this.toJSON()['reportData']);
            if (typeof context !== 'undefined') {
                params['project_state'] = this.get('childReportData')[context];
            }
            var reportData = _.extend(data, params);
            reportData.r = SCOPE.toolkit.randomId();
            var reportUrlPrefix = this.get('instance').reportUrl;
            reportUrlPrefix += '?';
            var reportUrl = this.addReportDataToReportUrl(reportData, reportUrlPrefix);
            if (_.indexOf(['click', 'clktru', 'engage'], reportData.action) !== -1) {
                setTimeout(function () {
                    that.firePixel(reportUrl, that.firedPixelCallback.bind(that, options));
                }, 100);
            } else {
                this.firePixel(reportUrl, this.firedPixelCallback.bind(this, options));
            }
        },
        getReportingUrls: function (action, reporing) {
            if (!this.get('sendLogs')) {
                return [];
            }
            var reportingData = _.clone(reporing), eventName = action || '', resultArr = [];
            if (reportingData.hotspots && _.size(reportingData.hotspots) && reportingData.hotspots[eventName]) {
                _.each(reportingData.hotspots[eventName], function (item) {
                    if (!_.isUndefined(item['tracking'])) {
                        _.each(item['tracking'], function (url) {
                            resultArr.push(url);
                        });
                    }
                });
            }
            return resultArr;
        },
        click: function (ev) {
            this.submit({action: 'click', event_id: 'position', event_value: ev.pageX + 'x' + ev.pageY});
        },
        submitError: function (options) {
            options.action = 'error';
            options.runtime_type = 'html';
            options.sample_rate = this.get('session').getSampleRate(options.event_id);
            options.suffix = this.get('instance').version.split('.').splice(0, 2).join('_');
            var params = options || {}, data = _.extend({}, this.toJSON()['reportData']), reportData = _.extend(data, params);
            delete reportData.website;
            reportData.r = SCOPE.toolkit.randomId();
            var reportUrlPrefix = this.get('instance').errorReportUrl;
            reportUrlPrefix += '?';
            var reportUrl = this.addReportDataToReportUrl(reportData, reportUrlPrefix);
            this.firePixel(reportUrl);
        },
        reportLog: function (options) {
            if (this.get('instance').enableErrorReporting && this.get('instance').errorReportUrl) {
                if (this.get('session').isMonitored(options.event_id)) {
                    this.submitError(options);
                } else {
                    this.errorLogQueue.push(options);
                }
            }
        },
        flushErrorQueue: function () {
            for (var i = 0; i < this.errorLogQueue.length; i++) {
                if (this.get('session').isMonitored(this.errorLogQueue[i].event_id)) {
                    this.submitError(this.errorLogQueue[i]);
                }
            }
            this.errorLogQueue = [];
        },
        firePixel: function (reportUrl, cb) {
            var img = new Image(1, 1);
            if (_.isFunction(cb)) {
                img.onload = cb;
            }
            img.src = reportUrl;
            this.reportedUrls.push(reportUrl);
        },
        firedPixelCallback: function (options) {
            this.loadedPixels.push(options);
        },
        wasPixelLoaded: function (options) {
            return !!_.findWhere(this.loadedPixels, options);
        }
    });
})(IV);
(function (SCOPE) {
    SCOPE.Popup = Backbone.View.extend({
        render: function () {
            var block = $('<div class="popup-wrapper"></div>');
            var content = $('<div class="popup-content" />');
            this.$el.html(block);
            content.append(this.model.content);
            block.append(content);
        }, events: {'click': 'close'}, close: function () {
            this.isOpen = false;
            this.$el.remove();
        }, open: function () {
            this.isOpen = true;
            this.render();
            $('#coupon-wrapper').append(this.$el);
        }
    });
})(IV);
(function (SCOPE) {
    SCOPE.Theater = Backbone.Model.extend({
        initialize: function () {
            var self = this;
            this.indrag = false;
            this.current = 0;
            this.slides = $('.gallery-slide', this.get('container'));
            if (this.slides.length > 3) {
                if (SCOPE.enableAnimations) {
                    this.get('container').parent().on('drag', _.bind(this.slideDragStartHandler, this)).on('dragend', _.bind(this.slideDragEndHandler, this));
                } else {
                    this.get('container').parent().on('dragend', _.bind(this.slideDragEndHandler, this));
                }
            }
            this.total_slides = this.slides.length;
            if (this.has('overview')) {
                this.createOverview();
            }
            this.slides.on(this.get('mainEngagementEvent'), function (ev) {
                self.slideClickHandler($(this).data('props'), ev);
                ev.preventDefault();
            });
            this.slideEvent(this.current, false, false);
        }, slideEvent: function (index, report, animate) {
            var that = this;
            var width = this.get('container').parent().width();
            var animation = _.isBoolean(animate) ? animate : SCOPE.enableAnimations;
            var props = {left: -width - (width * index), marginLeft: '0px'};
            if (animation) {
                this.get('container').animate(props, 'fast', 'linear', function () {
                    that.indrag = false;
                    that.slideTo(index, report);
                });
            } else {
                that.slideTo(index, report);
                that.indrag = false;
            }
            return true;
        }, slideTo: function (index, report) {
            var that = this;
            var width = this.get('container').parent().width();
            if (index > this.total_slides - 3) {
                index = 0;
            }
            else if (index < 0) {
                index = this.total_slides - 3;
            }
            var props = {left: -width - (width * index), marginLeft: '0px'};
            that.get('container').css(props);
            if (report) {
                this.trigger('reportSlideChange');
            }
            this.current = index;
            this.trigger('slideChange', this.slides.eq(index + 1).data('props'), index, this.slides.eq(index + 1));
        }, createOverview: function () {
            var self = this;
            this.updateOverview(this.current);
            this.get('overview').find('.iv-page').on(this.get('mainEngagementEvent'), function (ev) {
                self.pagerClickHandler(this, ev);
            });
            this.on('slideChange', function () {
                self.updateOverview(self.current);
            });
        }, updateOverview: function (current) {
            this.get('overview').find('.iv-page').removeClass("active");
            this.get('overview').find('.iv-page').eq(current).addClass('active');
        }, next: function () {
            this.slideEvent(this.current + 1, true);
        }, prev: function () {
            this.slideEvent(this.current - 1, true);
        }, pagerClickHandler: function (element, ev) {
            var index = $(element).index();
            this.slideEvent(index, true);
            ev.preventDefault();
        }, slideClickHandler: function (props, ev) {
            if (this.indrag) {
                return false;
            }
            this.trigger('slideClick', props, ev);
        }, slideDragStartHandler: function (ev) {
            this.indrag = true;
            var left = 0;
            if (ev.direction == 'left') {
                left = 0 - ev.distance;
            } else if (ev.direction == 'right') {
                left = ev.distance;
            }
            this.get('container').css({marginLeft: Math.floor(left) + 'px'});
        }, slideDragEndHandler: function (ev) {
            if (Math.abs(ev.distance) > 100) {
                if (ev.direction == 'right') {
                    this.prev();
                } else if (ev.direction == 'left') {
                    this.next();
                }
            } else {
                this.get('container').animate({marginLeft: '0px'}, 'fast');
            }
        }
    });
})(IV);
(function (SCOPE) {
    if (!_.isObject(SCOPE.toolkit))
        SCOPE.toolkit = {};
    SCOPE.toolkit.randomId = function () {
        var res = "";
        for (var i = 0; i < 8; i++) {
            res += (0x10000 | Math.random() * 0x10000).toString(16).substr(1);
        }
        return res;
    };
    SCOPE.toolkit.getEnvironmentFromURL = function (url) {
        url = url.replace(/^https?:\/\//, '');
        var urlParts = url.split("/");
        var host = urlParts[0];
        return host.split(".").slice(-2).join(".");
    };
    SCOPE.toolkit.getURLparts = function (url) {
        var uriBreakeDownRexExp = new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?");
        var urlPartsArray = url.split(uriBreakeDownRexExp);
        var urlPartObj = {
            scheme: urlPartsArray[2],
            authority: urlPartsArray[4],
            path: urlPartsArray[5],
            query: urlPartsArray[7],
            fragment: urlPartsArray[9]
        };
        return urlPartObj;
    };
    SCOPE.toolkit.getURISchemeFromURL = function (url) {
        return SCOPE.toolkit.getURLparts(url).scheme;
    };
    SCOPE.toolkit.trim = function (str) {
        return str.replace(/^\s+|\s+$/g, "");
    };
    SCOPE.toolkit.getRGBcolorFromMScolor = function (color) {
        var red, blue, green;
        red = Math.floor(Math.floor(color / 256) / 256);
        color = color - red * 256 * 256;
        green = Math.floor(color / 256);
        blue = color - green * 256;
        return {red: red, green: green, blue: blue};
    };
    SCOPE.toolkit.dayCodesToDaysInWeek = function (recurrence) {
        var pos, days = recurrence.split(","), daysInWeek = [], dayCodes = ["SU", "MO", "TU", "WE", "TH", "FR", "SA"];
        _.each(days, function (dayCode) {
            pos = dayCodes.indexOf(dayCode);
            if (pos != -1) {
                daysInWeek.push(pos);
            }
        });
        return daysInWeek;
    };
    SCOPE.toolkit.dateToString = function (date) {
        var weekday = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        var dateParts = date.toDateString().split(" ");
        return weekday[date.getDay()] + ", " + dateParts[1] + ". " + dateParts[2] + ", " + dateParts[3];
    };
    SCOPE.toolkit.getExpirationDate = function (date) {
        var expires = new Date(date);
        expires.setFullYear(expires.getFullYear() + 1);
        return expires.getFullYear()
            + "-" + SCOPE.toolkit.padDigits((expires.getUTCMonth() + 1), 2)
            + "-" + SCOPE.toolkit.padDigits(expires.getUTCDate(), 2)
            + "T"
            + SCOPE.toolkit.padDigits(expires.getUTCHours(), 2)
            + ":" + SCOPE.toolkit.padDigits(expires.getUTCMinutes(), 2)
            + ":" + SCOPE.toolkit.padDigits(expires.getUTCSeconds(), 2);
    };
    SCOPE.toolkit.padDigits = function (number, digits) {
        return Array(Math.max(digits - String(number).length + 1, 0)).join(0) + number;
    };
    SCOPE.toolkit.getIconImageSize = function (sizeArray, iconSize) {
        var iconImageSize = null;
        var nextIndex = 0;
        for (var i in sizeArray) {
            if (iconImageSize == null || Math.abs(sizeArray[i] - iconSize) < Math.abs(iconImageSize - iconSize)) {
                iconImageSize = sizeArray[i];
                nextIndex++;
            }
        }
        if ((nextIndex < sizeArray.length) && (iconSize > iconImageSize)) {
            iconImageSize = sizeArray[nextIndex];
        }
        return iconImageSize
    };
    SCOPE.toolkit.getPlatformScaleParameter = function (platformScaling) {
        var scale = 1;
        var platform = SCOPE.device.getPlatformType();
        switch (platform) {
            case"mobile":
                scale = platformScaling.mobile;
                break;
            case"tablet":
                scale = platformScaling.tablet;
                break;
            case"desktop":
                scale = platformScaling.desktop;
                break;
            case"tv":
                scale = platformScaling.tv;
                break;
        }
        return scale
    };
    SCOPE.toolkit.secondsToHMS = function (seconds) {
        var seconds = Number(seconds);
        var h = Math.floor(seconds / 3600);
        var m = Math.floor(seconds % 3600 / 60);
        var s = Math.floor(seconds % 3600 % 60);
        return ((h > 0 ? h + ":" : "") + (m > 0 ? (m < 10 ? "0" : "") + m + ":" : "00:") + (s < 10 ? "0" : "") + s);
    };
    SCOPE.toolkit.addDaySuffix = function (i) {
        var j = i % 10;
        if (j == 1 && i != 11) {
            return i + "st";
        }
        if (j == 2 && i != 12) {
            return i + "nd";
        }
        if (j == 3 && i != 13) {
            return i + "rd";
        }
        return i + "th";
    };
    SCOPE.toolkit.getDateLabel = function (date) {
        var daysDiff = SCOPE.toolkit.calcDiffInDays(date, new Date());
        switch (daysDiff) {
            case 0:
                return "Today";
            case 1:
                return "Tomorrow";
            default:
                return date.toDateString().split(" ")[1] + " " + SCOPE.toolkit.addDaySuffix(date.getDate());
        }
    };
    SCOPE.toolkit.calcDiffInDays = function (from, to) {
        var diff = from - to;
        return Math.max(Math.ceil(diff / 1000 / 60 / 60 / 24), 0);
    };
    function removeQuestionMark(str) {
        return str.charAt(0) === "?" ? str.substring(1) : str;
    }

    SCOPE.toolkit.parseQueryString = function (querystring) {
        var res = {};
        if (querystring && typeof querystring === "string") {
            var paramString = removeQuestionMark(querystring), paramPartArray = paramString.split("&");
            _.each(paramPartArray, function (paramPart) {
                var splittedParam = paramPart.split("=");
                res[splittedParam[0]] = splittedParam[1] ? decodeURIComponent(splittedParam[1]) : "";
            });
        }
        return res;
    }
})(IV);
(function (SCOPE) {
    var loader;
    var YouTubeApiLoader = Backbone.Model.extend({
        initialize: function () {
            var that = this;
            this.set('ready', false);
            window.onYouTubeIframeAPIReady = function () {
                that.apiReady();
            };
            var script = document.createElement('script');
            script.async = "async";
            script.src = (location.protocol == "https:" ? "https" : "http") + '://www.youtube.com/iframe_api';
            document.getElementsByTagName("head")[0].appendChild(script);
        }, apiReady: function () {
            this.set('ready', true);
            SCOPE.Events.trigger('YouTubeAPI.ready');
        }
    });
    var videoId = function (videoURL) {
        var queryStringParts = videoURL.split('?').pop().split('&');
        var queryParams = {};
        _.each(queryStringParts, function (param) {
            var paramPair = param.split('=');
            if (typeof paramPair[1] !== 'undefined') {
                queryParams[paramPair[0]] = paramPair[1];
            }
        });
        return queryParams.v || null;
    };
    SCOPE.YouTubePlayer = Backbone.Model.extend({
        initialize: function () {
            this.currentState = -1;
            this.placeholder = $('<div></div>').attr('id', this.cid);
        }, init: function () {
            var me = this;
            if (loader.get('ready')) {
                me.createPlayer();
            } else {
                loader.on('change:ready', _.bind(me.createPlayer, me));
            }
        }, getPlaceholder: function () {
            return this.placeholder;
        }, getIframe: function () {
            return this.player.getIframe();
        }, onPlayerReady: function () {
            var me = this;
            me.setSize(me.get('width'), me.get('height'));
            this.trigger('ready');
        }, setSize: function (width, height) {
            if (this.player && this.player.getIframe) {
                var frame = $(this.getIframe());
                if (frame.length) {
                    frame.width(width);
                    frame.height(height);
                }
            }
            if (this.player && this.player.setSize) {
                this.player.setSize(width, height);
            }
        }, isPlayState: function (state) {
            return (state == YT.PlayerState.PLAYING || state == YT.PlayerState.BUFFERING);
        }, onPlayerStateChange: function (event) {
            if (this.isPlayState(event.data) && !this.isPlayState(this.currentState)) {
                this.trigger('play');
            }
            this.currentState = event.data;
        }, onError: function () {
        }, play: function () {
            if (this.player && this.player.playVideo)this.player.playVideo();
        }, pause: function () {
            if (this.player && this.player.pauseVideo)this.player.pauseVideo();
        }, stop: function () {
            if (this.player && this.player.stopVideo)this.player.stopVideo();
        }, createPlayer: function () {
            this.player = new YT.Player(this.placeholder[0], {
                height: this.get('height'),
                width: this.get('width'),
                videoId: this.has('videoId') ? this.get('videoId') : videoId(this.get('source')),
                playerVars: {
                    autoplay: 0,
                    showinfo: this.has('showinfo') ? this.get('showinfo') : 0,
                    autohide: this.has('autohide') ? this.get('autohide') : 0,
                    controls: this.has('showControls') && this.get('showControls') ? 2 : 0
                },
                events: {
                    onReady: _.bind(this.onPlayerReady, this),
                    onStateChange: _.bind(this.onPlayerStateChange, this),
                    onError: _.bind(this.onError, this)
                }
            });
        }
    }, {});
    loader = new YouTubeApiLoader();
})(IV);
(function (SCOPE) {
    SCOPE.Events.on("videoPlayerReady", function (core, videoPlayer, videoSpy) {
        var elem, coreId = core.get('id'), enabled = true;

        function buildElem() {
            elem = $("<div class='iv-video-controls' />");
            elem.hide();
            elem.on(core.get('mainEngagementEvent'), function () {
                videoPlayer.play();
            });
        }

        function bindEvents() {
            ["video_play", "video_ended", "buffering"].forEach(function (ev) {
                videoSpy.on(ev, function () {
                    elem.hide()
                });
            });
            ["dialogClosed", "slateClosed"].forEach(function (ev) {
                IV.Events.on(coreId + ':' + ev, function () {
                    enabled = true
                });
            });
            ["dialogOpened", "slateOpened"].forEach(function (ev) {
                IV.Events.on(coreId + ':' + ev, function () {
                    enabled = false
                });
            });
            videoSpy.on("video_pause", function () {
                setTimeout(function () {
                    if (enabled)elem.show();
                }, 500);
            });
        }

        if (core.get('showClickToResume') === true) {
            buildElem();
            core.canvas.addResponsiveElement(elem);
            bindEvents();
        }
    });
})(IV);
(function (SCOPE) {
    SCOPE.VideoElementWrapper = function (elem) {
        this.elem = elem;
    };
    SCOPE.VideoElementWrapper.prototype.play = function () {
        this.elem.play();
    };
    SCOPE.VideoElementWrapper.prototype.pause = function () {
        this.elem.pause();
    };
    SCOPE.VideoElementWrapper.prototype.getAllSourceChildren = function () {
        return this.elem.children || [];
    };
    SCOPE.VideoElementWrapper.prototype.setSrc = function (src) {
        this.elem.src = src;
    };
    SCOPE.VideoElementWrapper.prototype.hasSrc = function () {
        return !!this.elem.src;
    };
    SCOPE.VideoElementWrapper.prototype.getDuration = function () {
        return this.elem.duration;
    };
    SCOPE.VideoElementWrapper.prototype.getCurrentTime = function () {
        return this.elem.currentTime;
    };
    SCOPE.VideoElementWrapper.prototype.getElem = function () {
        return this.elem;
    };
    SCOPE.VideoElementWrapper.prototype.on = function (event, callback) {
        this.elem.addEventListener(event, callback);
    };
    SCOPE.VideoElementWrapper.prototype.canPlayType = function (mimeType) {
        var canPlay;
        if (this.elem.canPlayType) {
            canPlay = this.elem.canPlayType(mimeType);
        } else {
            var tempVideo = document.createElement('video');
            if (typeof tempVideo.canPlayType === "function") {
                canPlay = tempVideo.canPlayType(mimeType);
            }
        }
        return (canPlay === 'probably' || canPlay === 'maybe');
    };
    SCOPE.VideoElementWrapper.prototype.load = function () {
        if (this.elem.load) {
            this.elem.load();
        }
    };
    SCOPE.VideoElementWrapper.prototype.seekTo = function (secs) {
        this.elem.currentTime = secs;
    };
    SCOPE.VideoElementWrapper.prototype.getVolume = function () {
        if (typeof this.elem.volume !== 'undefined') {
            return this.elem.volume;
        } else {
            return -1;
        }
    };
    SCOPE.VideoElementWrapper.prototype.setVolume = function (val) {
        if (typeof this.elem.volume !== 'undefined') {
            var volumeNum = parseFloat(val);
            if (!isNaN(volumeNum) && volumeNum >= 0 && volumeNum <= 1) {
                this.elem.volume = volumeNum;
            }
        }
    };
    SCOPE.VideoElementWrapper.prototype.exitFullScreen = function () {
        if (this.elem.exitFullscreen) {
            this.elem.exitFullscreen();
        }
        else if (this.elem.webkitExitFullscreen) {
            this.elem.webkitExitFullscreen();
        }
    };
    SCOPE.VideoElementWrapper.prototype.hasTracks = function () {
        return _.isElement(this.elem) && $(this.elem).find("track").size() > 0;
    };
})(IV);
(function (SCOPE) {
    SCOPE.InternalVideoPlayer = function () {
        var elem;
        this.video = null;
        this.core = null;
        this.spy = null;
        this.loaded = false;
        this.everPlayed = false;
        this.init = function (data, core) {
            var that = this, videoOptions = {preview: false, controls: ['resume'], autoplay: true, iroll: core};
            this.videoContainer = $('<div class="video-container" />');
            this.video = new SCOPE.html5video(videoOptions, this.videoContainer);
            elem = new SCOPE.VideoElementWrapper(this.video.el);
            this.spy = new SCOPE.VideoSpy(elem);
            if (data.customMetricsEnabled) {
                this.spy.setCustomPoint(data.customMetricsTime)
            }
            this.spy.on("all", function (eventName, ev) {
                SCOPE.Events.trigger(core.get('id') + ':' + eventName, ev);
                if (eventName === "video_short_buffering_time" || eventName === "video_long_buffering_time") {
                    SCOPE.Events.trigger('buffering');
                }
                else if (eventName !== "video_timeupdate" && eventName !== "buffering") {
                    SCOPE.Events.trigger('not_buffering');
                }
            });
            this.core = core;
            this.videoContainer.append(this.video.el);
            core.canvas.addElement(this.videoContainer);
            SCOPE.Events.on("video_click", function (ev) {
                that.trigger("interact", ev)
            });
            SCOPE.Events.on('winResize', setSizes.bind(null, this));
        };
        this.loadVideoSource = function (renditionsConfig) {
            this.loaded = this.video.setVideoSource(renditionsConfig);
        };
        var setSizes = function (context) {
            var core = context.core;
            var adSize = core.canvas.getSize();
            $(context.video.el).css({
                width: adSize.width,
                height: adSize.height,
                position: 'absolute',
                top: 0,
                left: 0
            });
        };
        this.getDuration = function () {
            return this.video.getDuration();
        };
        this.getRemainingTime = function () {
            return this.video.getRemainingTime();
        };
        this.getCurrentTime = function () {
            return this.video.getCurrentTime();
        };
        this.play = function () {
            if (this.loaded) {
                this.video.play();
                this.everPlayed = true;
            }
            else {
                throw("Failed to load video");
            }
        };
        this.resume = function () {
            this.video.resume();
        };
        this.pause = function (hideControls) {
            this.video.pause(hideControls);
        };
        this.getState = function () {
            return this.spy.state;
        };
        this.isPlaying = function () {
            return (this.spy.state === "playing");
        };
        this.isEverPlayed = function () {
            return this.everPlayed;
        };
        this.preparePlay = function () {
            if (!this.everPlayed) {
                this.video.load();
            }
        };
        this.getVolume = function () {
            return elem.getVolume();
        };
        this.setVolume = function (val) {
            elem.setVolume(val);
        };
        this.exitFullScreen = function () {
            elem.exitFullScreen();
        };
    };
    _.extend(SCOPE.InternalVideoPlayer.prototype, Backbone.Events);
})(IV);
(function (SCOPE) {
    SCOPE.SharedVideoPlayer = function (elem) {
        this.spy = null;
        this.active = true;
        this.loaded = false;
        this.init = function (data, core) {
            var that = this;
            if (!elem instanceof IV.VideoElementWrapper) {
                throw{'name': 'TypeError', 'message': 'elem must be a VideoElementWrapper'};
            }
            this.spy = new SCOPE.VideoSpy(elem);
            this.videoLoader = new SCOPE.VideoSourceLoader(elem, core);
            if (data.customMetricsEnabled) {
                this.spy.setCustomPoint(data.customMetricsTime)
            }
            this.spy.on("all", function (eventName, ev) {
                SCOPE.Events.trigger(core.get('id') + ':' + eventName, ev);
                if (eventName === "video_short_buffering_time" || eventName === "video_long_buffering_time") {
                    SCOPE.Events.trigger('buffering');
                }
                else if (eventName !== "video_timeupdate") {
                    SCOPE.Events.trigger('not_buffering');
                }
            });
            var bareElem = elem.getElem();
            if (_.isElement(bareElem)) {
                videoDecorators.applyByVideoId(bareElem.id, bareElem, core);
            }
            SCOPE.Events.on("video_click", function (ev) {
                if (that.active) {
                    that.trigger("interact", ev);
                }
            });
            SCOPE.Events.trigger("videoPlayerReady", core, this, this.spy);
        };
        this.loadVideoSource = function (renditionsConfig) {
            this.videoLoader.loadVideoSource(renditionsConfig);
            this.loaded = this.videoLoader.isLoaded();
        };
        this.getCurrentTime = function () {
            return elem.getCurrentTime();
        };
        this.getDuration = function () {
            return elem.getDuration();
        };
        this.getRemainingTime = function () {
            return this.getDuration() - this.getCurrentTime();
        };
        this.play = function () {
            if (this.loaded) {
                elem.play();
            }
            else {
                throw new Error("Failed to load video");
            }
        };
        this.resume = function () {
            elem.play();
        };
        this.pause = function () {
            elem.pause();
        };
        this.getState = function () {
            return this.spy.state;
        };
        this.isPlaying = function () {
            return (this.spy.state === "playing");
        };
        this.isEverPlayed = function () {
            return true;
        };
        this.preparePlay = function () {
        };
        this.cleanUp = function () {
            this.spy.off();
            delete this.spy;
            this.active = false;
        };
        this.getVolume = function () {
            return elem.getVolume();
        };
        this.setVolume = function (val) {
            elem.setVolume(val);
        };
        this.exitFullScreen = function () {
            elem.exitFullScreen();
        };
        var videoDecorators = {
            applyByVideoId: function (videoId, videoElement, iroll) {
                if (this.decorators.hasOwnProperty(videoId)) {
                    this.decorators[videoId].call(this, videoElement, iroll);
                    SCOPE.Events.on('winResize', this.decorators[videoId].bind(this, videoElement, iroll));
                }
            }, decorators: {
                "fwVPAIDPlayer": function (videoElement, iroll) {
                    $(videoElement).attr("webkit-playsinline", "webkit-playsinline");
                    var adSize = iroll.canvas.getSize();
                    $(videoElement).css("width", adSize.width || "100%").css("height", adSize.height || "100%");
                }
            }
        };
    };
    _.extend(SCOPE.SharedVideoPlayer.prototype, Backbone.Events);
})(IV);
(function (SCOPE) {
    SCOPE.VideoSourceLoader = function (videoElem, core) {
        var isLoaded = false;
        this.loadVideoSource = function (renditionsConfig) {
            var renditions = new SCOPE.VideoRenditions(), foundSuitableSource = false;
            if (!core.get('supportHLS') || videoElem.hasTracks()) {
                renditions.disableSupport("iphone_stream");
            }
            if (_.isObject(renditionsConfig) && _.size(renditionsConfig) > 0) {
                _.each(renditionsConfig, function (src, name) {
                    if (renditions.isDeviceSupported(name, SCOPE.device.getDeviceName(), SCOPE.device.isDeviceHLSSupported())) {
                        renditions.add(name, src);
                    }
                });
                var iterator = renditions.getIterator();
                var rend = iterator.next();
                while (rend !== null && foundSuitableSource === false) {
                    if (videoElem.canPlayType(rend['mimetype'])) {
                        var hadSrc = videoElem.hasSrc();
                        videoElem.setSrc(rend['src']);
                        if (hadSrc) {
                            videoElem.load();
                        }
                        foundSuitableSource = true;
                    } else {
                        rend = iterator.next();
                    }
                }
                if (!foundSuitableSource) {
                    SCOPE.Events.trigger(core.get('id') + ':video_error');
                }
            }
            isLoaded = foundSuitableSource;
        };
        this.isLoaded = function () {
            return isLoaded;
        }
    };
})(IV);
(function (SCOPE) {
    var updateOrientation = function () {
        $('body').attr('orientation', SCOPE.device.getDeviceOrientation());
        SCOPE.Events.trigger('orientationchange');
    };
    $(document).on('ready', function () {
        SCOPE.Events.trigger('domReady');
    });
    $(window).on('load', function () {
        SCOPE.Events.trigger('winLoad');
    });
    $(window).on('resize', function () {
        $('body').attr('orientation', SCOPE.device.getDeviceOrientation());
    });
    window.onorientationchange = updateOrientation;
    SCOPE.enableAnimations = SCOPE.device.supportsAnimations();
    $(function () {
        SCOPE.editingMode = false;
        $('body').css({
            "margin": 0,
            "padding": 0,
            "border": 0,
            "fontSize": "100%",
            "font": "inherit",
            "verticalAlign": "baseline"
        });
        $('body').attr('orientation', SCOPE.device.getDeviceOrientation());
        $('html').attr('screen-size', SCOPE.device.getDeviceScreenSizeClass()).attr('auto-scale', SCOPE.device.getAndroidOSVersion() !== '');
        $('body').on('focus', ".editable", function () {
            SCOPE.editingMode = true;
        });
        $('body').on("blur", ".editable", function () {
            SCOPE.editingMode = false;
        });
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-twitter-feed', format;
    var TwitterFeed = Backbone.Model.extend({
        initialize: function () {
            this.format = format;
            this.iroll = format.getIRoll();
            format.addApp(this);
            SCOPE.Events.on('repaint', this.updateScroll, this);
        }, updateScroll: function () {
            if (this.has('scroller')) {
                this.get('scroller').refresh();
            }
        }, launch: function () {
            var that = this, contentNode;
            var result = this.getTweets();
            this.format.expand("Twitter Feed", result, this.get('id'), this.get('reporting').namespace);
            contentNode = this.format.getExpandContent()
            $(contentNode).attr('id', this.cid);
            this.set('scroller', new iScroll($(contentNode)[0], {vScrollbar: false, hScroll: false}));
            contentNode.bind('loaded', function () {
                that.updateScroll();
            });
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            this.iroll.report.submit({
                action: 'cxon',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace),
                event_value: 'click',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            this.iroll.report.submit({
                action: 'clkint',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace) + '.open',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            setTimeout(function () {
                _.each(that.iroll.report.getReportingUrls('open', that.get('reporting')), function (url) {
                    that.iroll.report.submit3rdPatyTracking(url);
                });
            }, 500);
        }, repaint: function (iconSize) {
            this.format.repaint(iconSize, this)
        }, openTweet: function (url) {
            var that = this;
            _.each(that.iroll.report.getReportingUrls('clickthru', that.get('reporting')), function (url) {
                that.iroll.report.submit3rdPatyTracking(url);
            });
            this.iroll.windowOpen(url);
        }, openUser: function (url) {
            var that = this;
            this.iroll.report.submit({
                action: 'clkint',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace) + '.user',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            _.each(that.iroll.report.getReportingUrls('user', that.get('reporting')), function (url) {
                that.iroll.report.submit3rdPatyTracking(url);
            });
            this.iroll.windowOpen(url);
        }, getTweets: function () {
            var data = this.get('data'), result, twitterOptions;
            twitterOptions = {
                twitterServiceURL: this.iroll.get('servicePath') + "/api",
                tweetOpenHandler: this,
                join_text: "auto",
                avatar_size: 32,
                count: 40,
                loading_text: "",
                refresh_interval: data.refreshRate,
                template: function (data) {
                    var date, html;
                    date = new Date(data.tweet_time);
                    html = '<div class="single_tweet">' + '<img class="tweet_avatar" src="' + data.avatar_url + '">' + '<div class="tweet_content">' + '<div class="tweet_title">' + data.user + '</div>' + '<div class="tweet_content_inner">' + data.tweet_text + '</div>' + '<div class="tweet-date">' + date + '</div>' + '</div>' + '</div>'
                    return html;
                }
            };
            if (data.useTweetBy && data.tweetBy && data.showFavoritesOnly) {
                twitterOptions.favorites = true;
                twitterOptions.username = data.tweetBy.split(';');
            } else {
                var u = [], f = [], q = [];
                if (data.useTweetBy && data.tweetBy) {
                    _.each(data.tweetBy.split(';'), function (username) {
                        u.push('from:' + username);
                    });
                }
                if (data.searchWords) {
                    _.each(data.searchWords.split(/\s+/), function (word) {
                        f.push(word);
                    });
                }
                if (u.length)q.push('(' + u.join(' OR ') + ')');
                if (f.length)q.push('(' + f.join(' OR ') + ')');
                twitterOptions.query = q.join(' AND ');
            }
            result = $('<div />');
            result.addClass('iv-app-tweet');
            result.tweet(twitterOptions).bind("empty", function () {
                return $(this).append("No matching tweets found");
            });
            return result;
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, TwitterFeed));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-youtube-video', format;
    var defaults = {
        'youtubeId': '',
        'title': '',
        'idAttribute': 'rel',
        'draggable': false,
        'modal': true,
        'width': 640,
        'height': 480,
        'hideTitleBar': false,
        'clickOutsideClose': false,
        'overlayOpacity': 0.5,
        'autohide': 2,
        'autoplay': 1,
        'color': 'red',
        'color1': 'FFFFFF',
        'color2': 'FFFFFF',
        'controls': 1,
        'fullscreen': 1,
        'loop': 0,
        'hd': 1,
        'showinfo': 0,
        'theme': 'light'
    };
    var YouTube = Backbone.Model.extend({
        initialize: function () {
            this.format = format;
            this.iroll = format.getIRoll();
            format.addApp(this);
            var data = this.get('data');
            data.source = data.youtubeVideoURL;
            data.controls = data.showControls ^ 0;
            data.autoplay = data.autoplay ^ 0;
            _.defaults(data, defaults);
            SCOPE.Events.on('repaint', this.resizeVideo, this);
        }, getDim: function () {
            var dim;
            if (!this.get('inInMicrosite')) {
                dim = SCOPE.Dialog.getContentSize();
            } else {
                dim = {
                    w: this.get('micrositeInstance').get('contentArea').width(),
                    h: this.get('micrositeInstance').get('contentArea').height() + 44
                };
            }
            return dim;
        }, resizeVideo: function () {
            var player = this.get('player')
            if (!player)return;
            var dim = this.getDim();
            player.setSize(dim.w, dim.h);
        }, launch: function () {
            var data = this.get('data'), player;
            SCOPE.Events.trigger(this.iroll.get('id') + ':youtube-click', data.youtubeId);
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            this.iroll.report.submit({
                action: 'cxon',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace),
                event_value: 'click',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            this.iroll.report.submit({
                action: 'clkint',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace) + '.open',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            if (this.iroll.report.getReportingUrls('open', this.get('reporting'))) {
                this.iroll.report.submit3rdPatyTracking(this.iroll.report.getReportingUrls('open', this.get('reporting')));
            }
            var dim = this.getDim();
            data.width = dim.width;
            data.height = dim.height;
            player = new SCOPE.YouTubePlayer(data);
            this.set('player', player);
            var videoWrapper = $("<div class='youtube-video-wrapper'></div>");
            videoWrapper.append(player.getPlaceholder());
            this.format.expand("YouTube", videoWrapper, this.get('id'), this.get('reporting').namespace);
            player.init();
            player.on('ready', _.bind(this.videoReady, this));
            this.resizeVideo();
        }, repaint: function (iconSize) {
            this.format.repaint(iconSize, this)
        }, videoReady: function () {
            this.resizeVideo();
            var data = this.get('data');
            if (data.autoplay)this.get('player').play();
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, YouTube));
    });
})(IV);
(function (SCOPE) {
    var format;
    SCOPE._videoSlide = Backbone.Model.extend({
        initialize: function (opts) {
            var that = this;
            this.set('id', this.cid);
            this.player = new SCOPE.html5video({
                preview: opts.props.preview,
                controls: ['play'],
                autoplay: false,
                iroll: opts.iroll
            }, this.get('el'));
            this.player.setVideoSource(opts.props.renditions);
            this.timer = new Date();
            this.get('el').append(this.player.el);
            this.player.showControls();
            this.get('parent').on('slides.repaint', function () {
                that.repaint({width: that.get('el').width(), height: that.get('el').height()});
            });
        }, repaint: function () {
            var that = this;
            var repaintTimer = new Date();
            $(this.player.el).css({position: 'absolute', top: 0, left: 0});
            if (!SCOPE.enableAnimations) {
                if (repaintTimer.getTime() - this.timer.getTime() > 1000) {
                    $('.gallery-slide').hide();
                    setTimeout(function () {
                        $('.gallery-slide').show();
                    }, 100);
                    that.timer = new Date();
                }
            }
        }
    });
    SCOPE.GalleryProto = Backbone.Model.extend({
        initialize: function () {
            appContext = this;
            this.format = format;
            this.iroll = format.getIRoll();
            format.addApp(this);
            var data = this.get('data');
            _.defaults(data, defaults);
        }, launch: function () {
            var id = this.iroll.get('id');
            SCOPE.Events.trigger(id + ':gallery-click');
            SCOPE.Events.trigger(id + ':userClick');
            if (typeof this.updateView == 'function') {
                SCOPE.Events.on('repaint', this.updateView, this);
                SCOPE.Events.on('overflow-fix', this.updateView, this);
            }
            this.iroll.report.submit({
                action: 'cxon',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace),
                event_value: 'click',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            this.iroll.report.submit({
                action: 'clkint',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace) + '.open',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            if (this.iroll.report.getReportingUrls('open', this.get('reporting'))) {
                this.iroll.report.submit3rdPatyTracking(this.iroll.report.getReportingUrls('open', this.get('reporting')));
            }
            this.galleryOpen();
            this.galleryDOMCreate();
            this.trigger('galleryDOMReady');
            this.galleryTheaterCreate();
            this.galleryEventsBind();
            this.trigger('galleryReady');
            this.updateView();
            return false;
        }, repaint: function (iconSize) {
            this.format.repaint(iconSize, this)
        }, galleryOpen: function () {
            var dialog;
            var gallery = '<div class="image-gallery"></div>';
            this.format.expand('', gallery, this.get('id'), this.get('reporting').namespace);
            dialog = SCOPE.Dialog;
            this.galleryNode = $('.image-gallery', dialog.get('dialog'));
            this.width = this.galleryNode.parent().height();
            this.height = this.galleryNode.parent().width();
        }, updateView: function () {
            if (!this.galleryNode) {
                return true;
            }
            var galleryHeight = this.galleryNode.parent().height();
            var galleryWidth = this.galleryNode.parent().width();
            this.galleryNode.css({overflowX: 'hidden', position: 'relative'}).width(galleryWidth).height(galleryHeight);
            var gw = 0;
            $('.gallery-slide', this.slidesContainer).each(function () {
                var itemNode = $(this);
                itemNode.css({
                    lineHeight: galleryHeight + 'px',
                    height: galleryHeight + 'px',
                    width: galleryWidth + 'px'
                });
                var ew = itemNode.data('ew');
                var eh = itemNode.data('eh');
                var itemImage = $('.image', itemNode);
                var itemVideo = $('.video-wrapper', itemNode);
                itemImage.css('vertical-align', 'middle');
                itemVideo.css('lineHeight', 0);
                if (itemNode.data) {
                    if (!itemNode.data('fit')) {
                        if (eh > ew) {
                            itemImage.css({width: '100%', height: ''});
                        } else {
                            itemImage.css({height: '100%', width: ''});
                        }
                    } else {
                        var is_tall = eh > ew * galleryHeight / galleryWidth;
                        if (is_tall) {
                            itemImage.css({height: galleryHeight, width: galleryHeight * ew / eh});
                        } else {
                            itemImage.css({width: galleryWidth, height: galleryWidth * eh / ew});
                        }
                    }
                }
                gw += galleryWidth;
            });
            this.slidesContainer.width(gw);
            this.slidesContainer.height(galleryHeight);
            this.width = galleryWidth;
            this.height = galleryHeight;
            this.trigger('slides.repaint');
            this.trigger('repaintCurrentSlide');
        }, galleryDOMCreate: function () {
            var that = this;
            var data = this.get('data');
            this.slidesContainer = $('<div></div>').addClass('slides_container').appendTo(this.galleryNode);
            var galleryHeight = this.galleryNode.parent().height();
            var galleryWidth = this.galleryNode.parent().width();
            this.galleryNode.css({overflowX: 'hidden', position: 'relative'}).width(galleryWidth).height(galleryHeight);
            this.slidesContainer.css({position: 'absolute', left: 0, top: 0});
            that.visibleSlides = 0;
            that.buildItemNode(data.items[data.items.length - 1], galleryHeight, galleryWidth);
            _.each(data.items, function (element, galleryHeight, galleryWidth) {
                that.buildItemNode(element, galleryHeight, galleryWidth);
            });
            that.buildItemNode(data.items[0], galleryHeight, galleryWidth);
        }, buildItemNode: function (element, galleryHeight, galleryWidth) {
            function createPinitURL(element) {
                var piniterest = encodeURI("http://pinterest.com/pin/create/bookmarklet/?"), media = "media=" + encodeURIComponent(element.source), url = "&url=" + (encodeURIComponent(element.clickthruURL) ? encodeURIComponent(element.clickthruURL) : null), title = "&title=" + encodeURIComponent(element.id), isVideo = "&is_video=" + (element.type === "image"), description = "&description=" + encodeURIComponent(element.caption);
                return piniterest + media + url + title + isVideo + description;
            }

            var that = this;
            var data = this.get('data');
            if (!element) {
                return;
            }
            if (element.hide) {
                return;
            }
            if (!element.source) {
                return;
            }
            var itemNode = $('<div class="gallery-slide"></div>').appendTo(that.slidesContainer);
            itemNode.width(galleryWidth).height(galleryHeight);
            that.visibleSlides++;
            var gallerySlideContent, pinitButton;
            switch (true) {
                case element.type === 'Image' && data.settings.supportImages:
                    itemNode.data('ew', element.width).data('eh', element.height).data('fit', element.autoFit);
                    gallerySlideContent = that.createImageContent(element, itemNode);
                    if (element.hasPinterest) {
                        pinitButton = that.createPinitButton(element, itemNode);
                        pinitButton.on(that.iroll.get('mainEngagementEvent'), function (ev) {
                            var url = createPinitURL(element);
                            if (that.iroll.report.getReportingUrls('Pinterest', that.get('reporting'))) {
                                that.iroll.report.submit3rdPatyTracking(that.iroll.report.getReportingUrls('Pinterest', that.get('reporting')));
                            }
                            that.iroll.windowOpen(url);
                            ev.stopPropagation();
                        });
                    }
                    break;
                case element.type === 'Video' && data.settings.supportVideos:
                    itemNode.data('ew', that.width).data('eh', that.height).data('fit', true);
                    gallerySlideContent = that.createVideoContent(element, itemNode);
                    break;
                case element.type === 'Youtube Video' && data.settings.supportYouTube:
                    itemNode.data('ew', that.width).data('eh', that.height).data('fit', true);
                    gallerySlideContent = that.createYouTubeContent(element, itemNode);
                    break;
                default:
                    itemNode.remove();
                    return;
            }
            if (gallerySlideContent === false) {
                itemNode.remove();
                return;
            }
            itemNode.data('props', element).append(gallerySlideContent);
            if (pinitButton) {
                itemNode.data('props', element).append(pinitButton);
            }
        }, galleryTheaterCreate: function () {
            if (this.slidesContainer) {
                this.theater = new SCOPE.Theater({
                    container: this.slidesContainer,
                    mainEngagementEvent: this.iroll.get('mainEngagementEvent'),
                    overview: this.overview || null
                });
                SCOPE.Events.on('winResize', this.repaintCurrentSlide, this);
                this.on('repaintCurrentSlide', this.repaintCurrentSlide, this);
                SCOPE.Events.on('close' + this.id, this.unbindEvents, this);
                SCOPE.Events.on(this.iroll.get('id') + ':appClickThru', this.pauseInUnitVideos, this);
            }
        }, repaintCurrentSlide: function () {
            this.theater.slideEvent(this.theater.current, false, false);
        }, unbindEvents: function () {
            SCOPE.Events.off('repaint', this.updateView, this);
            SCOPE.Events.off('overflow-fix', this.updateView, this);
            SCOPE.Events.off('winResize', this.repaintCurrentSlide, this);
            SCOPE.Events.off(this.iroll.get('id') + ':appClickThru', this.pauseInUnitVideos, this);
        }, galleryEventsBind: function () {
            var that = this;
            if (!this.theater) {
                return;
            }
            this.theater.on('reportSlideChange', function () {
                that.iroll.report.submit({
                    action: 'clkint',
                    event_id: SCOPE.toolkit.trim(that.get('reporting').namespace) + '.browse',
                    relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                });
                if (that.iroll.report.getReportingUrls('browse', that.get('reporting'))) {
                    that.iroll.report.submit3rdPatyTracking(that.iroll.report.getReportingUrls('browse', that.get('reporting')));
                }
            }).on('slideClick', function (props, ev) {
                if (!props.clickthruURL) {
                    return;
                }
                var url = props.clickthruURL;
                if (that.iroll.get('sendLogs') && that.get('reporting')['hotspots'] && that.get('reporting')['hotspots']['clickthru'] && that.get('reporting')['hotspots']['clickthru'].length) {
                    _.each(that.get('reporting')['hotspots']['clickthru'], function (hotspot) {
                        if (hotspot.main) {
                            url = encodeURI(hotspot.main);
                        }
                    });
                }
                that.iroll.windowOpen(url);
                SCOPE.Events.trigger(that.iroll.get('id') + ':userClick');
                that.iroll.report.submit({
                    action: 'click',
                    event_id: 'position',
                    event_value: ev.pageX + 'x' + ev.pageY,
                    relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                });
                that.iroll.report.submit({
                    action: 'clktru',
                    event_id: that.get('reporting').namespace + '.' + props.id,
                    relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                });
                _.each(that.iroll.report.getReportingUrls(props.id, that.get('reporting')), function (url) {
                    that.iroll.report.submit3rdPatyTracking(url);
                });
            });
        }, createPrevNextPager: function () {
            var that = this;
            if (that.visibleSlides < 4) {
                return;
            }
            this.galleryNode.append('<div class="pager-prev"></div><div class="pager-next"></div>');
            $('.pager-next', this.galleryNode).on(this.iroll.get('mainEngagementEvent'), function () {
                that.theater.next();
            }).css('cursor', 'pointer');
            $('.pager-prev', this.galleryNode).on(this.iroll.get('mainEngagementEvent'), function () {
                that.theater.prev();
            }).css('cursor', 'pointer');
        }, pauseInUnitVideos: function () {
            var that = this;
            $('.gallery-slide', that.slidesContainer).each(function () {
                var video = $(this).data('video-player');
                if (video && _.isFunction(video.player.pause)) {
                    video.player.pause();
                }
                var youtube = $(this).data('youtube-player');
                if (youtube && _.isFunction(youtube.pause)) {
                    youtube.pause();
                }
            });
        }
    });
    var appName = 'app-media-gallery', appContext, defaults = {};
    var MediaGallery = SCOPE.GalleryProto.extend({
        initialize: function () {
            SCOPE.GalleryProto.prototype.initialize.apply(this, arguments);
            this.on('galleryReady', _.bind(this.mediaGalleryBootstrap, this));
        }, mediaGalleryBootstrap: function () {
            var that = this;
            this.createPager();
            var captionData = $('.gallery-slide', this.slidesContainer).first().next().data('props');
            var captionText = '';
            if (captionData && captionData.caption) {
                captionText = captionData.caption;
            }
            var caption = $('<span></span>').addClass('slide-caption').html(captionText);
            SCOPE.Dialog.setTitle(caption);
            this.theater.on('slideChange', function (props, index, node) {
                var caption = $('<span></span>').addClass('slide-caption').html(props.caption || '');
                SCOPE.Dialog.setTitle(caption);
                that.pauseInUnitVideos();
                if (props.type === 'Video' && props.autoplay) {
                    var video = $(node).data('video-player');
                    if (video && _.isFunction(video.player.play)) {
                        video.player.play();
                    }
                }
                if (props.type === 'Youtube Video' && props.autoplay) {
                    var youtube = $(node).data('youtube-player');
                    if (youtube && _.isFunction(youtube.play)) {
                        youtube.play();
                    }
                }
            });
        }, createPager: function () {
            this.createPrevNextPager();
        }, createYouTubeContent: function (element, node) {
            var that = this, youTubeVideoPlayer = new SCOPE.YouTubePlayer(element);
            var videoWrapper = $("<div class='video-wrapper'></div>");
            element.width = this.width;
            element.height = this.height;
            $(node).data('youtube-player', youTubeVideoPlayer);
            $(node).append(videoWrapper.append(youTubeVideoPlayer.getPlaceholder()));
            youTubeVideoPlayer.init();
            youTubeVideoPlayer.on('play', function () {
                that.iroll.report.submit({
                    action: 'clkint',
                    event_id: SCOPE.toolkit.trim(that.get('reporting').namespace) + '.play youtube',
                    relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                });
                _.each(that.iroll.report.getReportingUrls('Play youtube video - ' + element.id, that.get('reporting')), function (url) {
                    that.iroll.report.submit3rdPatyTracking(url);
                });
            });
            this.on('slides.repaint', function () {
                var width = that.width, height = that.width * (9 / 16);
                youTubeVideoPlayer.set({'width': width, 'height': height});
                youTubeVideoPlayer.setSize(width, height);
            });
        }, createPinitButton: function () {
            return $('<img class="pinit">');
        }, createImageContent: function (element) {
            return $('<img class="image">').attr({id: element.id, src: element.source}).css('vertical-align', 'middle');
        }, createVideoContent: function (element, node) {
            var that = this;
            var video = new SCOPE._videoSlide({props: element, el: node, parent: this, iroll: this.iroll});
            $(node).data('video-player', video);
            $(video.player.el).bind('play', function () {
                that.iroll.report.submit({
                    action: 'clkint',
                    event_id: SCOPE.toolkit.trim(that.get('reporting').namespace) + '.play video',
                    relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                });
                _.each(that.iroll.report.getReportingUrls('Play video - ' + element.id, that.get('reporting')), function (url) {
                    that.iroll.report.submit3rdPatyTracking(url);
                });
            });
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, MediaGallery));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-image-gallery';
    var defaults = {};
    var ImageGallery = SCOPE.GalleryProto.extend({
        initialize: function () {
            SCOPE.GalleryProto.prototype.initialize.apply(this, arguments);
            this.on('galleryDOMReady', _.bind(this.imageGalleryBootstrap, this));
        }, imageGalleryBootstrap: function () {
            $('.gallery-slide', this.slidesContainer).each(function () {
                var props = $(this).data('props');
                if (props && props.caption) {
                    $('<div></div>').addClass('caption').appendTo(this).html(props.caption).css('bottom', 0);
                }
            });
            this.overview = this.createPager();
        }, createPinitButton: function () {
            return $('<img class="pinit">');
        }, createImageContent: function (element) {
            return $('<img class="image">').attr({id: element.id, src: element.source}).css('vertical-align', 'middle');
        }, createPager: function () {
            if (this.get('data').items.length <= 1) {
                return;
            }
            var pager = $('<div class="slides-overview"></div>');
            _.each(this.get('data').items, function (element, index) {
                if (!element.hide && element.source) {
                    $('<div class="iv-page"></div>').appendTo(pager).text(index + 1).attr("aid", index + 1);
                }
            });
            this.format.setExpandTitle(pager);
            return pager;
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        var format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, ImageGallery));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-video-gallery';
    var VideoGallery = SCOPE.GalleryProto.extend({
        initialize: function () {
            SCOPE.GalleryProto.prototype.initialize.apply(this, arguments);
            this.on('galleryReady', _.bind(this.videoGalleryBootstrap, this));
        }, videoGalleryBootstrap: function () {
            var that = this;
            this.createPager();
            var captionText = $('.gallery-slide', this.slidesContainer).first().data('props').caption || '';
            var caption = $('<span></span>').addClass('slide-caption').html(captionText);
            that.format.setExpandTitle(caption);
            this.theater.on('slideChange', function (props, index, node) {
                var caption = $('<span></span>').addClass('slide-caption').html(props.caption || '');
                that.format.setExpandTitle(caption);
                $('.gallery-slide', that.slidesContainer).each(function () {
                    var video = $(this).data('video-player');
                    if (video && _.isFunction(video.player.pause)) {
                        video.player.pause();
                    }
                    var youtube = $(this).data('youtube-player');
                    if (youtube && _.isFunction(youtube.pause)) {
                        youtube.pause();
                    }
                });
                if (props.type === 'Video' && props.autoplay) {
                    var video = $(node).data('video-player');
                    if (video && _.isFunction(video.player.play)) {
                        video.player.play();
                    }
                }
                if (props.type === 'Youtube Video' && props.autoplay) {
                    var youtube = $(node).data('youtube-player');
                    if (youtube && _.isFunction(youtube.play)) {
                        youtube.play();
                    }
                }
            });
        }, createPager: function () {
            this.createPrevNextPager();
        }, createYouTubeContent: function (element, node) {
            var that = this, youTubeVideoPlayer = new SCOPE.YouTubePlayer(element);
            var videoWrapper = $("<div class='video-wrapper'></div>");
            element.width = this.width;
            element.height = this.height;
            $(node).data('youtube-player', youTubeVideoPlayer);
            $(node).append(videoWrapper.append(youTubeVideoPlayer.getPlaceholder()));
            this.resizeVideoWrapper(videoWrapper);
            youTubeVideoPlayer.init();
            youTubeVideoPlayer.on('play', function () {
                that.iroll.report.submit({
                    action: 'clkint',
                    event_id: SCOPE.toolkit.trim(that.get('reporting').namespace) + '.play youtube',
                    relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                });
                _.each(that.iroll.report.getReportingUrls('Play youtube video - ' + element.id, that.get('reporting')), function (url) {
                    that.iroll.report.submit3rdPatyTracking(url);
                });
            });
            this.on('slides.repaint', function () {
                that.resizeVideoWrapper($(".video-wrapper"));
                var width = "100%", height = "100%";
                youTubeVideoPlayer.set({'width': width, 'height': height});
                youTubeVideoPlayer.setSize(width, height);
            });
        }, createVideoContent: function (element, node) {
            var that = this;
            var video = new SCOPE._videoSlide({
                props: element,
                el: node,
                parent: this,
                iroll: this.iroll,
                mainEngagementEvent: that.iroll.get('mainEngagementEvent')
            });
            $(node).data('video-player', video);
            $(video.player.el).bind('play', function () {
                that.iroll.report.submit({
                    action: 'clkint',
                    event_id: SCOPE.toolkit.trim(that.get('reporting').namespace) + '.play video',
                    relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                });
                _.each(that.iroll.report.getReportingUrls('Play video - ' + element.id, that.get('reporting')), function (url) {
                    that.iroll.report.submit3rdPatyTracking(url);
                });
            });
        }, resizeVideoWrapper: function (element) {
            var container = element.parent();
            var hMargin = 40;
            var wrapperWidth = container.width() - (hMargin * 2);
            element.width(wrapperWidth);
            var wrapperHeight = (3 / 4) * wrapperWidth;
            element.height(wrapperHeight);
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        var format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, VideoGallery));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-microsite-launcher', format, dialog;
    var MicrositeLauncher = Backbone.Model.extend({
        defaults: {
            wrapper: null,
            contentArea: null,
            trayArea: null,
            tray: null,
            micrositeTray: null,
            trayArrow: null,
            selectedAppIndex: null
        }, initialize: function () {
            var that = this;
            this.videoClickEventId = null;
            this.format = format;
            this.iroll = format.getIRoll();
            this.set('disableIcon', true);
            format.addApp(this);
            SCOPE.Events.on('openMicrosite', function (isVideoClick) {
                that.launch(isVideoClick);
            });
            var irollData = this.iroll.get('data');
            if (_.has(irollData, "defaultLabels") && _.isObject(irollData.defaultLabels) && _.has(irollData.defaultLabels, "videoClick")) {
                this.videoClickEventId = irollData.defaultLabels.videoClick;
            }
        }, repaint: function () {
            if (this.get('contentArea')) {
                this.setSizes();
            }
            var scale = this.format.getScaleParam().iconScale, iconScaling = this.iroll.get('data').toolbar.data.iconScaling, width = this.get('data').width * this.get('data').scale * scale / iconScaling, height = this.get('data').height * this.get('data').scale * scale / iconScaling, containerWidth = $(format.getAppsContainer()).width(), containerHeight = $(format.getAppsContainer()).height(), top = this.get('placeholder').top, left = this.get('placeholder').left, view = this.get('view'), viewImage = this.get('viewImage');
            viewImage.width(width).height(height);
            view.css({
                width: width,
                height: height,
                top: (containerHeight - height) / 100 * top,
                left: (containerWidth - width) / 100 * left
            });
            this.refreshTrayScale(scale);
            this.highlightByIndex(this.get('selectedAppIndex'));
        }, imageView: function (image) {
            var container = $('<div>&nbsp;</div>').css({
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                zIndex: 25
            }).addClass('in-app-icon').addClass('microsite-launcher');
            if (this.iroll.get('delayAppVisibility')) {
                container.css({visibility: 'hidden'});
            }
            var customImageView = $('<img>').attr('src', image.url).css({
                display: 'block',
                position: 'absolute',
                top: 0,
                left: 0
            });
            customImageView.appendTo(container);
            this.set('view', container);
            this.set('viewImage', customImageView);
            this.repaint();
            return container;
        }, setupView: function () {
            var data = this.get('data'), view;
            if (['jpeg', 'png', 'gif'].indexOf(data.type) === -1) {
                data.url = this.iroll.get('appPath') + 'assets/images/apps/microsite/image_default_placeholder.png';
                data.width = 92;
                data.height = 97;
            }
            view = this.imageView(data);
            return view;
        }, getMicrositeContent: function () {
            var wrapper, contentArea, trayArea, tray, micrositeTray, trayArrow;
            wrapper = $('<div class="microsite-wrapper" />');
            contentArea = $('<div class="microsite-content-wrapper" />');
            trayArea = $('<div class="microsite-tray-wrapper" />');
            tray = $('<div id="iv-tray" />');
            micrositeTray = $('<div class="microsite-tray" />');
            var trayArrowTemplate = _.template('<svg id= "tray-arrow" preserveAspectRatio="xMinYMin meet" viewBox="0 0 100 100">' + '<path stroke="#7b7b7b" id="svg_arrow" d="M 0,103 L 50,60 L 100,103" stroke-width="8"  fill="<%=fill%>"/>' + '</svg>');
            if (this.iroll.get('data').toolbar.data.customColor) {
                var trayBgColor = SCOPE.toolkit.getRGBcolorFromMScolor(this.iroll.get('data').toolbar.data.customColor.tint), trayBgColorString = "rgb(" + trayBgColor.red + "," + trayBgColor.green + "," + trayBgColor.blue + ")", trayfontColor = SCOPE.toolkit.getRGBcolorFromMScolor(this.iroll.get('data').toolbar.data.customColor.captionColor), trayfontColorString = "rgb(" + trayfontColor.red + "," + trayfontColor.green + "," + trayfontColor.blue + ")";
                $(trayArea).css("background-color", trayBgColorString);
                $(trayArea).css("color", trayfontColorString);
                if (!trayArrow) {
                    this.set({trayArrow: null});
                    trayArrow = $(trayArrowTemplate({fill: trayBgColorString}));
                }
                $('.close-background').css('fill', trayBgColorString).css('stroke', trayBgColorString);
                $('.close-text').css('fill', trayfontColorString);
            }
            this.set({
                wrapper: wrapper,
                contentArea: contentArea,
                trayArea: trayArea,
                tray: tray,
                micrositeTray: micrositeTray
            });
            trayArea.append(tray);
            tray.append(micrositeTray);
            wrapper.append(contentArea).append(trayArea);
            if (this.iroll.get('data').toolbar.data.enableMicrositeHighlightEffect) {
                this.set({trayArrow: trayArrow});
                wrapper.append(trayArrow);
            }
            var orderedIcons = [];
            _.each(this.iroll.get('plugins'), function (app) {
                var order = app.get('app-order-index');
                if (app.get('placeholder').type === 'docked') {
                    orderedIcons[order] = app.get('icon');
                }
            });
            _.each(orderedIcons, function (icon) {
                this.get('micrositeTray').append(icon);
            }, this);
            return wrapper;
        }, setSizes: function () {
            var getSizes = function () {
                return {
                    dialogWidth: dialog.get('dialog').width(),
                    dialogHeight: dialog.get('dialog').height(),
                    titleHeight: dialog.get('title').outerHeight()
                };
            }();
            this.get('wrapper').css({
                width: getSizes.dialogWidth + 'px',
                height: (getSizes.dialogHeight) + 'px',
                position: 'relative'
            });
            this.get('contentArea').css({
                width: this.get('wrapper').width() + 'px',
                height: (this.get('wrapper').height() - this.get('trayArea').height()) + 'px',
                top: 0
            });
            return getSizes;
        }, openFirstEngadgmentApp: function () {
            var present = false, minIndex, indexes = [];
            minIndex = Object.keys(this.iroll.get('plugins')).length;
            _.each(this.iroll.get('plugins'), function (app) {
                if (app.get('placeholder').type === 'docked' && app.get('category') === 'regular') {
                    present = true;
                    var order = app.get('app-order-index');
                    indexes[order] = app;
                    minIndex = Math.min(minIndex, order);
                }
            });
            if (present) {
                indexes[minIndex].launch();
                this.highlightByIndex(minIndex)
            } else {
                dialog.close();
            }
        }, highlightByIndex: function (index) {
            var that = this;
            if (!this.iroll.get('data').toolbar.data.enableMicrositeHighlightEffect) {
                return;
            }
            if (typeof index === "undefined" || index === null) {
                return;
            }
            that.set({selectedAppIndex: index});
            var selectedApp = that.get('micrositeTray')[0].childNodes[index], selectedAppLeft = $(selectedApp).offset().left, selectedAppWidth = $(selectedApp).offset().width, selectedAppCenter = selectedAppLeft + selectedAppWidth / 2;
            that.changeArrowPosition(selectedAppCenter);
        }, changeArrowPosition: function (appCenter) {
            var arrowWidth = $(this.get('trayArrow')[0]).width();
            this.get('trayArrow').css({left: appCenter - arrowWidth / 2 + 'px'});
        }, getMicrositeTitle: function () {
            var title = this.get('title') || 'Microsite';
            return title;
        }, launchMicrosite: function () {
            var that = this;
            this.format.expand(that.getMicrositeTitle(), that.getMicrositeContent(), that.get('id'), this.get('reporting').namespace);
            this.format.setExpanded(true);
            dialog = SCOPE.Dialog;
            dialog.get('dialog').addClass('microsite-mode');
            this.setSizes();
            SCOPE.Events.trigger(this.iroll.get('id') + ':micrositeOpened', dialog, this);
            SCOPE.Events.on('micrositeRepaint', function () {
                SCOPE.Events.trigger('micrositeOrientationFix', that);
            });
            SCOPE.Events.on('move-microsite-arrow', that.highlightByIndex, that);
            this.iroll.report.submit({
                action: 'clkint',
                event_id: this.getAppNamespace() + '.open',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            this.get('view').hide();
            this.repaint();
        }, launch: function (isVideoClick) {
            this.launchMicrosite();
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            var eventId;
            if (isVideoClick) {
                eventId = this.getVideoClickEventId();
            } else {
                eventId = this.getAppNamespace() + '.click';
            }
            this.iroll.report.submit({
                action: 'clkint',
                event_id: eventId,
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            if (isVideoClick) {
                if (this.iroll.report.getReportingUrls('video-click', this.get('reporting'))) {
                    this.iroll.report.submit3rdPatyTracking(this.iroll.report.getReportingUrls('video-click', this.get('reporting')));
                }
            } else if (this.iroll.report.getReportingUrls('click', this.get('reporting'))) {
                this.iroll.report.submit3rdPatyTracking(this.iroll.report.getReportingUrls('click', this.get('reporting')));
            }
            this.openFirstEngadgmentApp();
        }, repaintMicrositeTray: function () {
            var trayArea = this.get('trayArea'), contentArea = this.get('contentArea'), wrapper = this.get('wrapper'), iconSize = this.format.getScaleParam().iconSize;
            trayArea.height(iconSize * 1.3);
            contentArea.height(wrapper.height() - trayArea.height());
            if (this.get('trayArrow')) {
                this.get('trayArrow').css({bottom: trayArea.css('height')})
            }
            SCOPE.Events.trigger('overflow-fix');
        }, hasItemsInTray: function () {
            var micrositeTray = this.get('micrositeTray');
            return $(micrositeTray).length > 0;
        }, getTrayWidth: function () {
            var micrositeTray = this.get('micrositeTray');
            return $(micrositeTray).width();
        }, refreshTrayScale: function (scale) {
            var micrositeTray = this.get('micrositeTray'), currentScale = 12 * scale;
            $(micrositeTray).css({'fontSize': currentScale + 'px'});
        }, showLauncher: function () {
            this.get('view').show();
        }, getAppNamespace: function () {
            return this.get('title');
        }, getVideoClickEventId: function () {
            var id;
            if (this.videoClickEventId) {
                id = this.videoClickEventId;
            } else {
                id = this.get('app-id') + ".click";
            }
            return id;
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, MicrositeLauncher));
    });
})(IV);
(function (SCOPE) {
    var
        format, excludeApps = ['app-custom-icon', 'app-text-label', 'app-pinterest-page', 'app-custom-swf'];
    var ClickThru = Backbone.Model.extend({
        initialize: function () {
            this.format = format;
            this.iroll = format.getIRoll();
            format.addApp(this);
        }, launch: function () {
            var url = this.get('data').clickthruURL, that = this;
            if (this.iroll.get('sendLogs') && this.get('reporting')['hotspots'] && this.get('reporting')['hotspots']['clickthru'].length) {
                _.each(this.get('reporting')['hotspots']['clickthru'], function (hotspot) {
                    if (hotspot.main)url = encodeURI(hotspot.main);
                });
            }
            SCOPE.Events.trigger('log:appClicked', this, url);
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            this.iroll.report.submit({
                action: 'clktru',
                event_id: this.get('reporting').namespace + '.clickthru',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            _.each(that.iroll.report.getReportingUrls('clickthru', this.get('reporting')), function (url) {
                that.iroll.report.submit3rdPatyTracking(url);
            });
            this.iroll.windowOpen(url);
        }, repaint: function (iconSize) {
            this.format.repaint(iconSize, this)
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(function (conf) {
            return conf && conf.data && conf.data.clickthruURL && excludeApps.indexOf(conf['app-id']) == -1;
        }, ClickThru));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-skip-ad', passedSeconds, skipDelayPassed, repainted, format;
    var SkipAd = Backbone.Model.extend({
        initialize: function () {
            this.format = format;
            this.iroll = format.getIRoll();
            _.each(this.get('icons'), function (icon) {
                delete icon.url;
            });
            format.addApp(this);
            SCOPE.Events.on(this.iroll.get('id') + ':video_timeupdate', function (ev) {
                if (!skipDelayPassed) {
                    this.repaintSkipIcon(ev.currentTime);
                }
            }, this);
        }, repaintSkipIcon: function (currentTime) {
            passedSeconds = Math.floor(currentTime);
            var timeRemainToSkip = this.get('data').skipDelay - passedSeconds;
            if (timeRemainToSkip > 0) {
                $('.iv-skip-label', this.format.getAppsContainer()).text(this.get('data').countdownText.replace("#", timeRemainToSkip));
                if (!repainted) {
                    this.repaint();
                    repainted = true;
                }
            } else {
                var skipText = this.get('data').skipText;
                $('.iv-skip-label', this.format.getAppsContainer()).text(skipText);
                skipDelayPassed = true;
                this.repaint();
            }
        }, setupIcon: function () {
            var icon, template = _.template('<div class="icon iv-skip-icon"><a class="iv-skip-label"><%=skipText%></a></div>'), countDownText = this.get('data').countdownText.replace("#", this.get('data').skipDelay);
            icon = $(template({skipText: countDownText}));
            icon.css({width: '9em'}).addClass('in-app-icon');
            if (this.iroll.get('delayAppVisibility')) {
                icon.css({visibility: 'hidden'});
            }
            this.set('icon', icon);
            return icon;
        }, repaint: function () {
            if (!this.has('icon'))return;
            var iconWidth = this.get('icon').width();
            this.format.repaint(iconWidth, this);
        }, launch: function () {
            var that = this;
            if ((passedSeconds - that.get('data').skipDelay) > -1) {
                SCOPE.Events.trigger(this.iroll.get('id') + ':close');
                this.iroll.report.submit({
                    action: 'clkint',
                    event_id: this.get('reporting').namespace + '.skip',
                    relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
                });
                this.iroll.report.submit({
                    action: 'skip',
                    relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
                });
                _.each(that.iroll.report.getReportingUrls('skip', that.get('reporting')), function (url) {
                    that.iroll.report.submit3rdPatyTracking(url);
                });
            }
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, SkipAd));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-pinterest-page', format
    var Pintersest = Backbone.Model.extend({
        initialize: function () {
            this.format = format;
            this.iroll = format.getIRoll();
            format.addApp(this);
        }, launch: function () {
            var url = this.get('data').clickthruURL;
            if (!url)return;
            SCOPE.Events.trigger('log:appClicked', this, url);
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            this.iroll.report.submit({
                action: 'clktru',
                event_id: this.get('reporting').namespace + '.clickthru',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            _.each(this.iroll.report.getReportingUrls('clickthru', this.get('reporting')), function (url) {
                this.iroll.report.submit3rdPatyTracking(url);
            });
            this.iroll.windowOpen(url);
        }, repaint: function (iconSize) {
            this.format.repaint(iconSize, this)
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, Pintersest));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-custom-icon', format;
    var CustomIcon = Backbone.Model.extend({
        initialize: function () {
            this.format = format;
            this.iroll = format.getIRoll();
            format.addApp(this);
        }, setupIcon: function () {
            var iconSize = this.format.getScaleParam().iconSize;
            var icon = $('<div></div>');
            var customIconImg = $('<img class="iconImg">');
            var url = this.get('data').url;
            if (!url) {
                url = this.iroll.get('appPath') + 'assets/images/apps/placeholder.png';
                this.get('data').url = url;
                this.get('data').width = 92;
                this.get('data').height = 97;
            }
            var customIconSize = {
                width: Math.round(this.get('data').width * this.get('data').scale),
                height: Math.round(this.get('data').height * this.get('data').scale)
            };
            icon.width(customIconSize.width).height((this.get('placeholder').type == 'docked') ? iconSize : customIconSize.height).css({
                display: 'inline-block',
                visibility: 'hidden',
                zIndex: 25 + (this.get('app-order-index') || 0),
                cursor: 'pointer',
                position: 'relative'
            }).addClass('iv-icon').addClass('in-app-icon');
            if (this.iroll.get('delayAppVisibility')) {
                icon.css({visibility: 'hidden'});
            }
            customIconImg.attr('src', url).height("100%").css({display: 'block', float: 'left'});
            icon.append(customIconImg);
            this.set('icon', icon);
            return icon;
        }, launch: function () {
            var url = this.get('data').clickthruURL, that = this;
            if (this.iroll.get('sendLogs') && this.get('reporting')['hotspots'] && this.get('reporting')['hotspots']['clickthru'].length) {
                _.each(this.get('reporting')['hotspots']['clickthru'], function (hotspot) {
                    if (hotspot.main)url = encodeURI(hotspot.main);
                });
            }
            if (!url)return;
            SCOPE.Events.trigger('log:appClicked', this, url);
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            this.iroll.report.submit({
                action: 'clktru',
                event_id: this.get('reporting').namespace + '.clickthru',
                event_value: url,
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            _.each(that.iroll.report.getReportingUrls('clickthru', that.get('reporting')), function (url) {
                that.iroll.report.submit3rdPatyTracking(url);
            });
            this.iroll.windowOpen(url);
        }, repaint: function (iconSize) {
            this.format.repaint(iconSize, this)
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(context.getIRoll().get('data').apps, context.createAppInstance(appName, CustomIcon));
    });
    return SCOPE;
})(IV || {});
(function (SCOPE) {
    var appName = 'app-share-this', format;
    var ShareThis = Backbone.Model.extend({
        initialize: function () {
            this.format = format;
            this.iroll = format.getIRoll();
            format.addApp(this);
        }, launch: function () {
            this.format.expand('Share', this.getShareIcons(), this.get('id'), this.get('reporting').namespace)
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            this.iroll.report.submit({
                action: 'cxon',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace),
                event_value: 'click',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            this.iroll.report.submit({
                action: 'clkint',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace) + '.open',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            if (this.iroll.report.getReportingUrls('open', this.get('reporting'))) {
                this.iroll.report.submit3rdPatyTracking(this.iroll.report.getReportingUrls('open', this.get('reporting')));
            }
        }, repaint: function (iconSize) {
            this.format.repaint(iconSize, this)
        }, getShareIcons: function () {
            var that = this;
            var displayTextLabels = this.get('data').showLabel;
            var block = $('<div class="share-this-wrapper" />'), shareIconTemplate = _.template('<a class="share-item" title="<%=caption%>">' + '<span class="label"><%=caption%></span><br/>' + '<img class="share-item-img" src="<%=appPath%>/assets/images/apps/share-social/<% print(caption.toLowerCase()) %>.png?v=3">' + '</a>'), shareText = this.get('data').shareText, customURL = this.get('data').customURL;
            _.each(this.get('data').items, function (shareItem) {
                if (!shareItem.enabled)return;
                shareItem.appPath = that.iroll.get('appPath');
                shareItem.template = shareItem.template.replace('${shareText}', shareText);
                shareItem.template = shareItem.template.replace('${previewURL}', customURL);
                var shareIcon = shareIconTemplate(shareItem);
                var shareIconNode = $(shareIcon).appendTo(block);
                if (!displayTextLabels) {
                    $('.label', shareIconNode).hide();
                }
                var url = shareItem.template;
                var eventType = shareItem.type;
                shareIconNode.on('click', function () {
                    that.iroll.report.submit({
                        action: 'clktru',
                        event_id: that.get('reporting').namespace + '.' + eventType,
                        relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                    });
                    _.each(that.iroll.report.getReportingUrls(shareItem.type, that.get('reporting')), function (url) {
                        that.iroll.report.submit3rdPatyTracking(url);
                    });
                    var str = "mailto";
                    if (url.substring(0, str.length) === str) {
                        window.location.href = url;
                    }
                    str = "http";
                    if (url.substring(0, str.length) === str) {
                        url = encodeURI(url);
                        that.iroll.windowOpen(url);
                    }
                });
            });
            return block;
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, ShareThis));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-text-label', format;
    var TextLabel = Backbone.Model.extend({
        initialize: function () {
            this.format = format;
            this.iroll = format.getIRoll();
            _.each(this.get('icons'), function (icon) {
                delete icon.url;
            });
            format.addApp(this);
        }, setupIcon: function () {
            var skin = this.get('data').skin, icon, decorator, getColor, templates = {
                text: _.template('<div class="iv-icon"><div class="textIcon" data-skin="text"><a class="label"><%=label%></a></div></div>'),
                button: _.template('<div class="iv-icon"><div class="textIcon" data-skin="button"><a class="label"><%=label%></a></div></div>')
            };
            getColor = function (color) {
                var triplet = {r: (color >> 16) & 0xFF, g: (color >> 8) & 0xFF, b: color & 0xFF};
                return 'rgb(' + triplet.r + ',' + triplet.g + ',' + triplet.b + ')';
            };
            decorator = function (skin) {
                if (skin == 'text') {
                    icon.css({})
                }
                if (skin == 'button') {
                    icon.css({});
                }
            };
            switch (skin) {
                case'Button':
                    icon = $(templates.button(this.get('data')));
                    decorator('button');
                    break;
                case'Text':
                    icon = $(templates.text(this.get('data')));
                    decorator('text');
                    break;
                default:
                    icon = $(templates.button(this.get('data')));
                    decorator('button');
                    break;
            }
            icon.find('.textIcon').css({color: getColor(this.get('data').color)});
            icon.css({
                fontFamily: 'Arial, sans-serif',
                display: 'inline-block',
                visibility: 'hidden',
                zIndex: 25,
                cursor: 'pointer'
            }).addClass('in-app-icon');
            if (this.iroll.get('delayAppVisibility')) {
                icon.css({visibility: 'hidden'});
            }
            this.set('icon', icon);
            return icon;
        }, repaint: function () {
            if (!this.has('icon'))return;
            var iconScaling = 1;
            if (this.get('placeholder').type === "floating") {
                iconScaling = this.iroll.get('data').toolbar.data.iconScaling;
            }
            var scale = this.format.getScaleParam().scale / iconScaling;
            var fontSize = 12 * scale;
            var defaultWidth = this.get('icon').data('defaultWidth');
            if (!defaultWidth) {
                defaultWidth = this.get('icon').width();
                this.get('icon').data('defaultWidth', defaultWidth);
            }
            var iconWidth = defaultWidth;
            var iconHeight = this.format.getScaleParam().iconSize / iconScaling;
            this.get('icon').find('.textIcon').css({
                float: 'left',
                overflow: 'hidden',
                fontSize: fontSize + 'px',
                lineHeight: iconHeight - 2 + 'px',
                height: iconHeight - 2 + 'px',
                padding: '0 0.5em',
                borderRadius: '0.5em'
            });
            this.get('icon').css({lineHeight: iconHeight - 2 + 'px', height: iconHeight + 'px'});
            this.format.repaint(iconWidth, this);
        }, launch: function () {
            var url = this.get('data').clickthruURL, that = this;
            if (!url)return;
            SCOPE.Events.trigger('log:appClicked', this, url);
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            this.iroll.report.submit({
                action: 'clktru',
                event_id: this.get('reporting').namespace + '.clickthru',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            _.each(that.iroll.report.getReportingUrls('clickthru', that.get('reporting')), function (url) {
                that.iroll.report.submit3rdPatyTracking(url);
            });
            this.iroll.windowOpen(url);
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, TextLabel));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-ical-event', format;
    var EventApp = Backbone.Model.extend({
        initialize: function () {
            this.format = format;
            this.iroll = format.getIRoll();
            format.addApp(this);
        }, launch: function () {
            this.format.expand("Event", this.getEventView(), this.get('id'), this.get('reporting').namespace);
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            this.iroll.report.submit({
                action: 'cxon',
                event_id: this.get('reporting').namespace,
                event_value: 'click',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            if (this.iroll.report.getReportingUrls('open', this.get('reporting'))) {
                this.iroll.report.submit3rdPatyTracking(this.iroll.report.getReportingUrls('open', this.get('reporting')));
            }
        }, repaint: function (iconSize) {
            this.format.repaint(iconSize, this)
        }, getEventView: function () {
            var block = $('<div class="event-wrapper" />'), eventLinkTemplate = _.template('<a class="event-link"><img src="<%=appPath%>/assets/images/apps/event/add_calendar_btn.png?v2"></a>');
            var eventDate = new Date(this.get('data').startDate);
            var dateString = SCOPE.toolkit.dateToString(eventDate);
            var caption = $('<div></div>').addClass('caption').appendTo(block).text(this.get('data').subject);
            var time = $('<div></div>').addClass('time').appendTo(block).text(dateString);
            var desc = $('<div></div>').addClass('description').appendTo(block).text(this.get('data').description);
            var descColor = SCOPE.toolkit.getRGBcolorFromMScolor(this.get('data').descColor);
            var subColor = SCOPE.toolkit.getRGBcolorFromMScolor(this.get('data').subColor);
            caption.css("color", "rgb(" + subColor.red + "," + subColor.green + "," + subColor.blue + ")");
            time.css("color", "rgb(" + descColor.red + "," + descColor.green + "," + descColor.blue + ")");
            desc.css("color", "rgb(" + descColor.red + "," + descColor.green + "," + descColor.blue + ")");
            var bgImage = this.get('data').bgImage;
            if (bgImage.source) {
                $(block).css("background-image", 'url(' + bgImage.source + ')');
                if (!bgImage.displayText) {
                    $(caption).hide();
                    $(time).hide();
                    $(desc).hide();
                }
                if (bgImage.autoFit) {
                    $(block).addClass('autoFit');
                }
            }
            var eventLink = this.getEventLink(this.get('data'), $(eventLinkTemplate({appPath: this.iroll.get('appPath')})));
            if (eventLink) {
                eventLink.appendTo(block);
            }
            return block;
        }, getEventLink: function (data, eventNode) {
            var that = this;
            if ((!SCOPE.device.isAndroid()) || (this.iroll.supportFeature("calendar"))) {
                eventNode.on('click', function () {
                    var url = that.getLinkUrl(data);
                    var daysInWeek = SCOPE.toolkit.dayCodesToDaysInWeek(data.recurrence);
                    var expires = SCOPE.toolkit.getExpirationDate(data.startDate);
                    var parameters = {
                        description: data.subject,
                        location: data.location,
                        summary: data.description,
                        start: data.startDate,
                        end: data.endDate,
                        transparency: data.transparency,
                        recurrence: {frequency: 'weekly', daysInWeek: daysInWeek, expires: expires}
                    };
                    that.iroll.report.submit({
                        action: 'clktru',
                        event_id: that.get('reporting').namespace + '.savetomobile',
                        relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                    });
                    if (that.iroll.report.getReportingUrls('savetomobile', that.get('reporting'))) {
                        that.iroll.report.submit3rdPatyTracking(that.iroll.report.getReportingUrls('savetomobile', that.get('reporting')));
                    }
                    that.createCalendarEvent(parameters, url);
                });
                return eventNode;
            } else {
                return false
            }
        }, getLinkUrl: function (data) {
            var url;
            _.each(data.items, function (eventLink) {
                if (eventLink.type === "icalendar") {
                    url = eventLink.url + "&type=icalendar&cal_name=" + encodeURI(data.subject);
                }
            });
            return "webcal" + url.slice(4);
        }, createCalendarEvent: function (parameters, url) {
            if (_.isUndefined(this.iroll))return;
            if (_.isFunction(this.iroll.get('interface')['createCalendarEvent'])) {
                this.iroll.get('interface')['createCalendarEvent'](parameters, url);
            }
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, EventApp));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-tickets-showtimes', format;
    var EventApp = Backbone.Model.extend({
        initialize: function (config) {
            var that = this;
            this.movieName = config.data.movieName ? config.data.movieName : "";
            this.releaseDate = config.data.releaseDate ? config.data.releaseDate : new Date();
            this.format = format;
            this.iroll = format.getIRoll();
            format.addApp(this);
            SCOPE.Events.on("updateTheaterList", that.updateTheaterListView);
            SCOPE.Events.on("googleMapsApiReady", that.findLocation);
        }, launch: function () {
            var that = this;
            that.hasLocation = false;
            that.isLocationPercise = false;
            this.format.expand("Tickets & Showtimes", this.getView(), this.get('id'), this.get('reporting').namespace);
            this.iScroll = new iScroll("theatersListContainer", {hScrollbar: false, vScrollbar: true});
            this.iScrollTimeout = setInterval((function () {
                that.iScroll.refresh();
            }), 500);
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            this.iroll.report.submit({
                action: 'cxon',
                event_id: this.get('reporting').namespace,
                event_value: 'click',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            this.iroll.report.submit({
                action: 'clkint',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace) + '.open',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            if (this.iroll.report.getReportingUrls('open', this.get('reporting'))) {
                this.iroll.report.submit3rdPatyTracking(this.iroll.report.getReportingUrls('open', this.get('reporting')));
            }
        }, repaint: function (iconSize) {
            this.format.repaint(iconSize, this)
        }, loadGoogleMapsApi: function () {
            var that = this;
            window.initializeMap = function () {
                var mapOptions = {
                    zoom: 15,
                    zoomControl: true,
                    zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.LARGE,
                        position: google.maps.ControlPosition.RIGHT_BOTTOM
                    },
                    center: new google.maps.LatLng(0, 0),
                    mapTypeControl: false,
                    streetViewControl: false
                };
                that.map = new google.maps.Map(document.getElementById('ts-map'), mapOptions);
                that.geocoder = new google.maps.Geocoder();
                SCOPE.Events.trigger("googleMapsApiReady", that);
                google.maps.event.addListener(that.map, 'zoom_changed', function () {
                    that.iroll.report.submit({
                        action: 'clkint',
                        event_id: SCOPE.toolkit.trim(that.get('reporting').namespace) + '.Map Zoom Change',
                        relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                    });
                    if (that.iroll.report.getReportingUrls('Map Zoom Change', that.get('reporting'))) {
                        that.iroll.report.submit3rdPatyTracking(that.iroll.report.getReportingUrls('Map Zoom Change', that.get('reporting')));
                    }
                });
            };
            var script = document.createElement('script');
            script.async = "async";
            script.type = 'text/javascript';
            script.src = 'https://maps.googleapis.com/maps/api/js?v=3.exp&key=' + that.iroll.get('config').googleMapsApiKey + '&sensor=false&callback=initializeMap';
            document.head.appendChild(script);
        }, getView: function () {
            var that = this, block = $('<div class="tickets-showtimes-wrapper" />'), loading = $('<div id="loading-map"><div id="loading-map-box"><div id="loading-map-icon"></div><div id="loading-map-text">Loading Map...</div></div></div>');
            block.append(loading);
            block.append(that.getShowTimesView());
            block.append(that.getMapView());
            this.loadGoogleMapsApi();
            return block;
        }, findLocation: function (context) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    context.getShowtimesUsingGPS(position);
                }, function () {
                    context.getShowtimesUsingIP();
                });
            }
            setTimeout(function () {
                if (!context.hasLocation) {
                    context.getShowtimesUsingIP();
                }
            }, 1000);
        }, getShowtimesUsingGPS: function (position) {
            var that = this;
            that.latitude = position.coords.latitude;
            that.longitude = position.coords.longitude;
            that.hasLocation = true;
            that.isLocationPercise = true;
            that.findTheaterNearLatLng(position.coords.latitude, position.coords.longitude);
        }, findTheaterNearLatLng: function (latitude, longitude) {
            var that = this, latlng = new google.maps.LatLng(latitude, longitude);
            that.latitude = latitude;
            that.longitude = longitude;
            that.geocoder.geocode({'latLng': latlng}, function (results, status) {
                var address = "", today = new Date(), date = SCOPE.toolkit.calcDiffInDays(that.releaseDate, today.getTime()), percisionLevel;
                if (status === google.maps.GeocoderStatus.OK) {
                    if (that.isLocationPercise) {
                        percisionLevel = 1;
                    } else {
                        percisionLevel = Math.max(1, results.length - 2);
                    }
                    address = results[percisionLevel].formatted_address;
                }
                that.getTheatersList(address, that.movieName, date);
                $('#zipcodeInput')[0].value = address;
            });
        }, getShowtimesUsingIP: function () {
            var that = this, geolocation, url = this.iroll.get('nonCdnServicePath') + "/jsonpWrapper/?service=geo&callback=?";
            that.hasLocation = true;
            $.getJSON(url, function (data) {
                geolocation = that.parseShowtimesXml(data).parentNode;
                var country = geolocation.childNodes[3].textContent, city = geolocation.childNodes[4].textContent, latitude = geolocation.childNodes[9].textContent, longitude = geolocation.childNodes[10].textContent, zipcode = geolocation.childNodes[11].textContent;
                if ((latitude !== "NA") && (longitude !== "NA")) {
                    that.findTheaterNearLatLng(parseFloat(latitude), parseFloat(longitude));
                } else {
                    var address = "", today = new Date(), date = SCOPE.toolkit.calcDiffInDays(that.releaseDate, today.getTime());
                    if (zipcode !== "NA") {
                        address = zipcode;
                    } else if (country !== "NA") {
                        address = country;
                        if (city !== "NA") {
                            address.concat(" " + city);
                        }
                    }
                    that.getTheatersList(address, that.movieName, date);
                    $('#zipcodeInput')[0].value = address;
                }
            });
        }, getMapView: function () {
            var mapContainer = $('<div id="mapContainer" />'), map = $('<div id="ts-map"></div>');
            map.appendTo(mapContainer);
            return mapContainer;
        }, getShowTimesView: function () {
            var that = this;
            var showtimesContainer = $('<div id="showtimesContainer" />'), theatersListContainer = $('<div id="theatersListContainer" />'), theatersListScroller = $('<div id="theatersListScroller" />');
            theatersListContainer.append(theatersListScroller);
            showtimesContainer.append(that.getSearchBar());
            theatersListContainer.appendTo(showtimesContainer);
            return showtimesContainer;
        }, getSearchBar: function () {
            var that = this, searchBar = $('<div id="ts-searchBar"/>'), zipcodeInput = $('<input id="zipcodeInput" class="editable" placeholder="Enter Zipcode"/>'), styledSelect = $('<div class="styled-select"></div>'), daySelect = $('<select id="daySelect" class="editable"/>'), optionTemplate = _.template('<option value="<%=value%>"><%=label%></option>'), today = new Date(), daysToRelease = SCOPE.toolkit.calcDiffInDays(that.releaseDate, today.getTime());
            var day = new Date();
            day.setDate(day.getDate() + daysToRelease);
            for (var i = daysToRelease; i < daysToRelease + 5; i++) {
                var label = SCOPE.toolkit.getDateLabel(day);
                daySelect.append($(optionTemplate({value: i, label: label})));
                day.setDate(day.getDate() + 1);
            }
            zipcodeInput.change(function () {
                that.performSearch(that);
            }).focus(that.onEnterEditingMode).blur(that.onExitEditingMode);
            daySelect.change(function () {
                that.performSearch(that);
            }).focus(that.onEnterEditingMode).blur(that.onExitEditingMode);
            searchBar.append(zipcodeInput);
            styledSelect.append(daySelect);
            searchBar.append(styledSelect);
            return searchBar;
        }, performSearch: function (context) {
            var zipcode = $('#zipcodeInput')[0], daySelect = $('#daySelect')[0], date = daySelect[daySelect.selectedIndex].value;
            zipcode.blur();
            daySelect.blur();
            context.getTheatersList(zipcode.value, context.movieName, date);
            this.iroll.report.submit({
                action: 'clkint',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace) + '.Perform Search',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            if (this.iroll.report.getReportingUrls('Perform Search', this.get('reporting'))) {
                this.iroll.report.submit3rdPatyTracking(this.iroll.report.getReportingUrls('Perform Search', this.get('reporting')));
            }
        }, onExitEditingMode: function () {
            $('#mapContainer').show();
            $('#showtimesContainer').removeClass('withkeyboard');
            SCOPE.Events.trigger('winResize');
        }, onEnterEditingMode: function () {
            $('#mapContainer').hide();
            $('#showtimesContainer').addClass('withkeyboard');
        }, getTheatersList: function (zipcode, movie, date) {
            var that = this, showtimes;
            if (!zipcode) {
                SCOPE.Events.trigger("updateTheaterList", null, that);
            } else {
                var url = this.iroll.get('servicePath') + "/jsonpWrapper/?service=movie&zip=" + zipcode + "&movie=" + movie + "&date=" + date + "&callback=?";
                $.getJSON(url, function (data) {
                    showtimes = that.parseShowtimesXml(data);
                    SCOPE.Events.trigger("updateTheaterList", showtimes, that);
                });
            }
        }, updateTheaterListView: function (showtimeData, context) {
            var theatersListScroller = $('#theatersListScroller'), theatersList = $('<ul id="theatersList"/>'), theaterNodeTemplate = _.template('<li class="theaterNode" id="theater_<%=id%>">' + '<div class="theater-name"><%=name%></div>' + '<div class="theater-address"><%=address%></div>' + '<div class="tickets-text">Get Tickets:</div></li>'), ticketTemplate = _.template('<div class="ticket" id="theater_<%=theater%>_ticket_<%=id%>"><%=time%></div>'), noResults = $('<div id="noResults">' + '<div id="noResults-icon"></div>' + '<div id="noResults-text1">No results Found.</div>' + '<div id="noResults-text2">Please try a different search.</div></div>');
            $('#theatersList').remove();
            $('#noResults').remove();
            if ((showtimeData) && (showtimeData.childElementCount > 0) && (showtimeData.childNodes[0].childNodes[0].childNodes[0])) {
                var theaterIndex = 0;
                _.each(showtimeData.childNodes, function (theater) {
                    var name = theater.childNodes[0].childNodes[0] ? theater.childNodes[0].childNodes[0].data : "", address = theater.childNodes[1].childNodes[0] ? theater.childNodes[1].childNodes[0].data : "", showsDetails = theater.childNodes[2].childNodes;
                    var theaterNode = $(theaterNodeTemplate({
                        id: theaterIndex,
                        name: name,
                        address: address
                    })), showtimes = $('<div class="showtimes"/>'), ticketIndex = 0;
                    _.each(showsDetails, function (ticket) {
                        var time = $(ticket).attr('time'), url = $(ticket).attr('link');
                        var ticketButton = $(ticketTemplate({time: time, id: ticketIndex, theater: theaterIndex}));
                        if (url) {
                            ticketButton.on(context.iroll.get('mainEngagementEvent'), function () {
                                context.iroll.report.submit({
                                    action: 'clkint',
                                    event_id: SCOPE.toolkit.trim(context.get('reporting').namespace) + '.Buy Tickets',
                                    relative_time: (new Date().getTime() - context.iroll.get('playStartTime'))
                                });
                                if (context.iroll.report.getReportingUrls('Buy Tickets', context.get('reporting'))) {
                                    context.iroll.report.submit3rdPatyTracking(context.iroll.report.getReportingUrls('Buy Tickets', context.get('reporting')));
                                }
                                context.iroll.windowOpen(url);
                            }, context).addClass("withLink");
                            $(theaterNode[0].childNodes[2]).text("Get Tickets:").addClass("getTickets");
                        } else {
                            ticketButton.addClass("withoutLink");
                            $(theaterNode[0].childNodes[2]).text("Showtimes:");
                        }
                        showtimes.append(ticketButton);
                        ticketIndex++;
                    });
                    showtimes.appendTo(theaterNode);
                    theaterNode.on(context.iroll.get('mainEngagementEvent'), function () {
                        context.iroll.report.submit({
                            action: 'clkint',
                            event_id: SCOPE.toolkit.trim(context.get('reporting').namespace) + '.Show Theater On Map',
                            relative_time: (new Date().getTime() - context.iroll.get('playStartTime'))
                        });
                        if (context.iroll.report.getReportingUrls('Show Theater On Map', context.get('reporting'))) {
                            context.iroll.report.submit3rdPatyTracking(context.iroll.report.getReportingUrls('Show Theater On Map', context.get('reporting')));
                        }
                        context.selectTheater($(this));
                    });
                    theatersList.append(theaterNode);
                    theaterIndex++;
                });
                theatersListScroller.append(theatersList);
                context.selectTheater($('#theater_0'));
                context.iScroll.scrollToElement('li:nth-child(1)', 100);
            }
            else {
                var latlng = new google.maps.LatLng(context.latitude, context.longitude);
                context.map.setCenter(latlng);
                theatersListScroller.append(noResults);
            }
            $('#loading-map').hide();
            context.iScroll.refresh();
        }, selectTheater: function (theater) {
            var that = this;
            google.maps.event.trigger(that.map, 'resize');
            $('#theatersList li').removeClass('selected');
            $(theater).addClass('selected');
            var address = theater[0].childNodes[1].textContent;
            that.geocoder.geocode({'address': address}, function (results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    that.map.setCenter(results[0].geometry.location);
                    var marker = new google.maps.Marker({map: that.map, position: results[0].geometry.location});
                } else {
                    var latlng = new google.maps.LatLng(that.latitude, that.longitude);
                    that.map.setCenter(latlng);
                }
            });
        }, parseShowtimesXml: function (data) {
            var xml;
            if (window.DOMParser) {
                var parser = new DOMParser();
                xml = parser.parseFromString(data, "text/xml");
            }
            return xml.firstChild.childNodes[1];
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, EventApp));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-coupon-print', format;
    var CouponApp = Backbone.Model.extend({
        initialize: function () {
            this.format = format;
            this.iroll = format.getIRoll();
            format.addApp(this);
        }, launch: function () {
            this.format.expand(this.get('data').couponTitle, this.getCouponView(), this.get('id'), this.get('reporting').namespace)
            SCOPE.Events.trigger(this.iroll.get('id') + ':userClick');
            this.iroll.report.submit({
                action: 'cxon',
                event_id: this.get('reporting').namespace,
                event_value: 'click',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            this.iroll.report.submit({
                action: 'clkint',
                event_id: SCOPE.toolkit.trim(this.get('reporting').namespace) + '.open',
                relative_time: (new Date().getTime() - this.iroll.get('playStartTime'))
            });
            if (this.iroll.report.getReportingUrls('open', this.get('reporting'))) {
                this.iroll.report.submit3rdPatyTracking(this.iroll.report.getReportingUrls('open', this.get('reporting')));
            }
        }, repaint: function (iconSize) {
            this.format.repaint(iconSize, this)
        }, getCouponView: function () {
            var block = $('<div class="coupon-wrapper" id="coupon-wrapper"/>'), saveCouponTemplate = _.template('<a class="coupon-btn"><img class="coupon-img" id="<%=id%>" src="' + '<%=appPath%>/assets/images/apps/coupon/<%=button%>.png?v2"></a>'), printLine = $('<div class="desc-bottom-line" />');
            $(block).css("background-image", 'url(' + this.get('data').couponURL + ')');
            var saveCoupon = this.getCouponLink(this.get('data').couponURL, $(saveCouponTemplate({
                appPath: this.iroll.get('appPath'),
                id: "save-coupon",
                button: "save_coupon_btn"
            })));
            var couponDetails = this.getDetailsLink($(saveCouponTemplate({
                appPath: this.iroll.get('appPath'),
                id: "coupon-details",
                button: "coupon_details_btn"
            })));
            printLine.append(saveCoupon);
            printLine.append(couponDetails);
            block.append(printLine);
            return block;
        }, getCouponDetails: function () {
            var that = this
            var text = that.get('data').couponText.replace(/\n/g, '<br/>');
            var content = $('<div class="details-text">' + text + '</div>');
            return {content: content};
        }, getCouponInstructions: function () {
            var view;
            var img = $('<img class="instruction-img" ' + 'src=' + this.iroll.get('appPath') + '/assets/images/apps/coupon/instructions_img.png?v2></img>');
            var instruction1 = '1.Press the "Home" and "Power" button at the same time and wait for the shutter sound.';
            var instruction2 = "2.The coupon will be saved to your device's Photo Gallery";
            var text = $('<div class="instruction-text">' + instruction1 + '<br/><br/>' + instruction2 + '</div>');
            var content = $('<div class="instruction" />');
            content.append(text);
            content.append(img);
            view = {content: content};
            return view;
        }, getCouponLink: function (couponURL, saveCoupon) {
            var that = this;
            saveCoupon.on(this.iroll.get('mainEngagementEvent'), function () {
                if ((that.detailsPopup) && (that.detailsPopup.isOpen)) {
                    that.detailsPopup.close();
                }
                if (that.iroll.supportFeature("storePicture")) {
                    that.storePicture(couponURL);
                } else {
                    if ((that.saveCouponPopup) && (that.saveCouponPopup.isOpen)) {
                        that.saveCouponPopup.close();
                    }
                    else {
                        that.saveCouponPopup = new SCOPE.Popup({model: that.getCouponInstructions()});
                        that.saveCouponPopup.open();
                    }
                }
                that.iroll.report.submit({
                    action: 'clktru',
                    event_id: that.get('reporting').namespace + '.savetomobile',
                    relative_time: (new Date().getTime() - that.iroll.get('playStartTime'))
                });
                if (that.iroll.report.getReportingUrls('savetomobile', that.get('reporting'))) {
                    that.iroll.report.submit3rdPatyTracking(that.iroll.report.getReportingUrls('savetomobile', that.get('reporting')));
                }
            });
            return saveCoupon;
        }, getDetailsLink: function (couponDetails) {
            var that = this;
            couponDetails.on(this.iroll.get('mainEngagementEvent'), function () {
                if ((that.saveCouponPopup) && (that.saveCouponPopup.isOpen)) {
                    that.saveCouponPopup.close();
                }
                if ((that.detailsPopup) && (that.detailsPopup.isOpen)) {
                    that.detailsPopup.close();
                }
                else {
                    that.detailsPopup = new SCOPE.Popup({model: that.getCouponDetails()});
                    that.detailsPopup.open();
                }
            });
            return couponDetails;
        }, storePicture: function (url) {
            if (_.isUndefined(this.iroll))return;
            if (_.isFunction(this.iroll.get('interface')['storePicture'])) {
                this.iroll.get('interface')['storePicture'](url);
            }
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, CouponApp));
    });
})(IV);
(function (SCOPE) {
    var appName = 'app-custom-swf', format;
    var CssApp = Backbone.Model.extend({
        initialize: function () {
            var cssUrl = this.get('data').clickthruURL;
            if (cssUrl && cssUrl.indexOf(".css") !== -1) {
                format.getIRoll().canvas.injectCss(cssUrl);
            }
        }, launch: function () {
        }, repaint: function () {
        }
    });
    SCOPE.Events.on('appsSystemReady', function (context) {
        format = context;
        _.each(format.getIRoll().get('data').apps, context.createAppInstance(appName, CssApp));
    });
})(IV);
(function (SCOPE) {
    var wrapper, format, appsContainer, micrositeDialog, micrositeInstance, scaleParam, expanded, expandedApp, _toolbarIconsOrder = [];
    SCOPE.ExpandFormat = function (iroll, data) {
        var config = iroll.get('config'), canvas = iroll.canvas, delayAppVisibility = iroll.get('delayAppVisibility');
        this.resizeLayout = function (callback) {
            if (!config.previewParam) {
                return;
            }
            scaleParam = {};
            scaleParam.screenScale = canvas.getScale();
            scaleParam.iconSize = config.previewParam.iconSize * scaleParam.screenScale * data.toolbar.data.iconScaling;
            scaleParam.iconScale = scaleParam.iconSize / config.previewParam.iconSize;
            scaleParam.floatingIconScale = scaleParam.iconScale;
            if (!SCOPE.editingMode) {
                canvas.setScale(canvas.getDefaultFontSize() * scaleParam.screenScale);
                $('#trayContainer').css({fontSize: canvas.getDefaultFontSize() * scaleParam.iconScale * data.toolbar.data.iconScaling});
            }
            if (typeof callback == "function") {
                callback(scaleParam.iconSize)
            }
        };
        this.createWrapper = function () {
            var that = this;
            var appId = data['id'];
            wrapper = $('<div class="iv-wrapper" data-appid="' + appId + '" id="app_' + appId + '"></div>');
            appsContainer = $('<div class="appsContainer"></div>');
            var _setSizes = function () {
                var adSize = canvas.getSize();
                wrapper.css({
                    width: adSize.width,
                    height: adSize.height,
                    position: 'absolute',
                    top: '0em',
                    left: '0em',
                    overflow: 'hidden'
                });
                appsContainer.css({
                    position: 'absolute',
                    top: '0em',
                    left: '0em',
                    bottom: '0em',
                    right: '0em',
                    overflow: 'hidden'
                });
                that.resizeLayout(that.resizeIcons);
                that.overflowFix();
                SCOPE.Events.trigger('repaint');
                if (that.isMicrositeOpen()) {
                    SCOPE.Events.trigger('micrositeRepaint');
                }
            };
            _setSizes();
            $(wrapper).append(appsContainer);
            this.drawFloatingIconContainer();
            canvas.addElement(wrapper);
            SCOPE.Events.trigger('wrapperReady');
            SCOPE.Events.on('orientationchange', _.debounce(_setSizes, 30));
            SCOPE.Events.on('winResize', _.debounce(_setSizes, 30));
            SCOPE.Events.on('overflow-fix', that.overflowFix, that);
            SCOPE.Events.on(iroll.get('id') + ':micrositeOpened', function (dialog, microsite) {
                micrositeDialog = dialog;
                micrositeInstance = microsite;
                SCOPE.Events.trigger('overflow-fix');
            });
            SCOPE.Events.on('micrositeRepaint', function () {
                micrositeInstance.repaintMicrositeTray();
            });
        };
        this.resizeIcons = function (iconsize) {
            SCOPE.Events.trigger('icon-repaint', iconsize);
        };
        this.overflowFix = function () {
            var adSize = canvas.getSize(), windowWidth = adSize.width, overflowRatio = 0, floatingOverflowRatio = 0;
            if (this.isMicrositeOpen()) {
                if (this.getMicrositeRightMostPixel() > windowWidth) {
                    overflowRatio = this.getMicrositeRightMostPixel() / windowWidth;
                }
            } else {
                if (this.getFloatingIconsRightMostPixel() > windowWidth) {
                    floatingOverflowRatio = this.getFloatingIconsRightMostPixel() / windowWidth;
                }
            }
            if (overflowRatio > config.previewParam.trayMargin) {
                var newIconSize = scaleParam.iconSize / overflowRatio, scale = newIconSize / config.previewParam.iconSize;
                scaleParam.iconSize = newIconSize;
                scaleParam.iconScale = scale;
                if (micrositeInstance) {
                    micrositeInstance.refreshTrayScale(scale);
                }
            }
            if (floatingOverflowRatio > 1) {
                var floatingIconScale = 1 / floatingOverflowRatio * scaleParam.floatingIconScale;
                scaleParam.floatingIconScale = floatingIconScale;
            }
            if (floatingOverflowRatio > 1 || overflowRatio > config.previewParam.trayMargin) {
                SCOPE.Events.trigger('icon-repaint');
                if (this.isMicrositeOpen()) {
                    micrositeInstance.repaintMicrositeTray();
                }
            }
        };
        this.isMicrositeOpen = function () {
            return micrositeInstance && micrositeInstance.hasItemsInTray();
        };
        this.getMicrositeRightMostPixel = function () {
            return micrositeInstance.getTrayWidth() * config.previewParam.trayMargin;
        };
        this.getFloatingIconsRightMostPixel = function () {
            var floatingIconContainer = $('.floating-icon-container', wrapper)[0], rightMostPixel = 0;
            if (floatingIconContainer) {
                _.each(floatingIconContainer.children, function (icon) {
                    rightMostPixel = Math.max(rightMostPixel, (icon.offsetWidth + icon.offsetLeft));
                });
            }
            return rightMostPixel;
        };
        this.drawFloatingIconContainer = function () {
            var floatingContainer = $("<div class='floating-container' />");
            var floatingIconContainer = $("<div class='floating-icon-container' />");
            floatingIconContainer.appendTo(floatingContainer);
            floatingContainer.appendTo(appsContainer);
            if (delayAppVisibility) {
                floatingContainer.css({visibility: 'hidden'});
            }
        };
        this.getScaleParam = function () {
            return scaleParam;
        };
        this.getAppsContainer = function () {
            return appsContainer;
        };
        this.getWrapper = function () {
            return wrapper;
        };
        this.getIRoll = function () {
            return iroll;
        };
        this.getFormat = function () {
            return "expand";
        };
        this.createAppInstance = function (appMatch, appModel) {
            var that = this;
            var plugins = iroll.get('plugins');
            return function (config, index) {
                var appInstanceName = config['app-id'];
                if (appInstanceName === appMatch || (typeof appMatch === 'function' && appMatch(config))) {
                    config['app-order-index'] = index;
                    if (!plugins[config.id] || !plugins[config.id].created) {
                        plugins[config.id] = new appModel(_.extend(config, {instance: that}));
                        plugins[config.id].created = true;
                    }
                } else {
                    return;
                }
            };
        };
        this.repaint = function (iconSize, app) {
            var icon = app.get('icon'), trayIconWidth = iconSize || scaleParam.iconSize, scale = trayIconWidth / iroll.get('config').previewParam.iconSize, placeholder = app.get('placeholder'), showTooltips = iroll.get('data').toolbar.data.showTooltips, title = showTooltips ? app.get('tooltip') : '';
            icon.attr('title', title);
            var iconScaleParams = {
                floatingIconScale: scaleParam.floatingIconScale,
                iconScale: scale,
                iconScaling: iroll.get('data').toolbar.data.iconScaling,
                iconImageSize: SCOPE.toolkit.getIconImageSize(iroll.get('config').iconSizes, scaleParam.iconSize)
            };
            SCOPE.icons.setIconDimensions(app, iconScaleParams, trayIconWidth, placeholder);
            if (placeholder.type === 'docked') {
                this.setupIconForMicrosite(app, scaleParam.iconSize, scale);
            }
            if (placeholder.type === 'floating') {
                SCOPE.icons.setIconPosition(icon, placeholder, scale, appsContainer);
            }
        };
        this.setExpanded = function (expand) {
            expanded = expand;
            if (expand === false) {
                micrositeInstance.showLauncher();
            }
        };
        this.getDialog = function () {
            return micrositeDialog;
        };
        this.expand = function (title, content, id, namespace) {
            if (expanded) {
                if (expandedApp) {
                    SCOPE.Events.trigger('close' + expandedApp.id);
                }
                micrositeDialog.setTitle(title);
                micrositeInstance.get('contentArea').html(content);
            }
            else {
                SCOPE.Dialog.setTitle(title).setContent(content).open();
            }
            expandedApp = {id: id, namespace: namespace}
        };
        this.getExpandContent = function () {
            if (expanded) {
                return micrositeInstance.get('contentArea');
            }
            else {
                return SCOPE.Dialog.get('content')
            }
        };
        this.getExpandContentSize = function () {
            if (expanded) {
                return {
                    w: micrositeInstance.get('contentArea').width(),
                    h: micrositeInstance.get('contentArea').height()
                };
            }
            else {
                return SCOPE.Dialog.getContentSize();
            }
        };
        this.setExpandTitle = function (title) {
            if (expanded) {
                micrositeDialog.setTitle(title);
            } else {
                SCOPE.Dialog.setTitle(title);
            }
        };
        this.getExpandedApp = function () {
            return expandedApp;
        };
        this.setupIconForMicrosite = function (app, iconSize, scale) {
            var iconHeight = parseInt(app.get('icon').css('height'), 10), iconWidth = parseInt(app.get('icon').css('width'), 10), micrositeIconScale = iconHeight / iconSize, micrositeIconWidth = iconWidth / micrositeIconScale, micrositeIconHeight = iconHeight / micrositeIconScale;
            app.get('icon').height(micrositeIconHeight).css({
                backgroundSize: 'contain',
                backgroundRepeat: 'no-repeat',
                fontSize: 'inherit',
                lineHeight: micrositeIconHeight + 'px'
            });
            var titleText = app.get('icon')[0].attributes.getNamedItem('title') ? app.get('icon')[0].attributes.getNamedItem('title').value : "";
            var titleTextContainer = $('<div class="titleText"></div>');
            $(titleTextContainer).text(titleText);
            if (app.get('app-id') === 'app-text-label') {
                if (iroll.get('data').toolbar.data.menuStyle !== "Icons Only") {
                    $(titleTextContainer).css({float: 'left', textIndent: 0.3 + 'em'});
                    if (app.get('icon').find('.titleText').length === 0) {
                        app.get('icon').append(titleTextContainer);
                        if (iroll.get('data').toolbar.data.menuStyle === "Text Only") {
                            app.get('icon').css({
                                height: app.get('icon').find('.textIcon').height(),
                                lineHeight: app.get('icon').find('.textIcon').height()
                            });
                            app.get('icon').find('.textIcon').hide();
                            $(titleTextContainer).css({padding: '0 0.5em', textIndent: 0});
                        }
                    }
                }
            } else {
                app.get('icon').width(micrositeIconWidth).css({fontSize: 12 * scale + 'px'});
                if (iroll.get('data').toolbar.data.menuStyle !== "Icons Only") {
                    if (app.get('icon').find('.titleText').length === 0) {
                        app.get('icon').append(titleTextContainer);
                        app.get('icon').addClass('iconsAndText');
                    }
                    if (iroll.get('data').toolbar.data.menuStyle === "Text Only") {
                        app.get('icon').removeClass('iconsAndText');
                        app.get('icon').addClass('textOnly').find('.iconImg').hide();
                        $(titleTextContainer).css({padding: '0 0.5em', textIndent: 0});
                    } else {
                        app.get('icon').css({textIndent: micrositeIconWidth * 1.1 + 'px'})
                    }
                    if (app.get('app-id') === 'app-custom-icon') {
                        app.get('icon').css({textIndent: 0.3 + 'em'});
                        $(titleTextContainer).css({float: 'left', textIndent: 0.3 + 'em'});
                    }
                }
            }
        };
        this.addApp = function (app) {
            updateAppHotspotClicks(app);
            if (!app.get('disableView')) {
                registerView(app);
            }
            if (!app.get('disableIcon')) {
                registerIcon(app);
            } else {
                SCOPE.Events.on('repaint', app.repaint, app);
            }
            app.repaint();
        };
        this.repaintDurationBar = function (duration, currentTime, durationBarData) {
            if (!iroll.get('durationBar')) {
                var durationBar = $('<div class="durationBar"><a class="iv-duration-label"></a></div>');
                $(wrapper).append(durationBar);
                if (durationBarData.align === "top") {
                    $(durationBar).addClass("atTop");
                    $(appsContainer).css({top: "1.5em !important"});
                } else {
                    $(durationBar).addClass("atBottom");
                    $(appsContainer).css({bottom: "1.5em !important"});
                }
                SCOPE.Events.trigger('winResize');
                iroll.set({durationBar: durationBar}, {silent: true});
            }
            var timeRemaining = Math.floor(duration - currentTime);
            $('.iv-duration-label', iroll.get('durationBar')).text(durationBarData.format.replace("#", SCOPE.toolkit.secondsToHMS(timeRemaining)));
        };
        function registerView(app) {
            var view = app.get('view') || (typeof app.setupView == 'function' ? app.setupView() : null);
            if (view) {
                $(view).appendTo(appsContainer).on(iroll.get('mainEngagementEvent'), function (ev) {
                    if (typeof app.launch === "function") {
                        iroll.report.click(ev);
                        app.launch();
                    }
                });
            }
        }

        function registerIcon(app) {
            var icon = app.get('icon') || (typeof app.setupIcon == 'function' ? app.setupIcon() : SCOPE.icons.setupIcon(app, delayAppVisibility));
            icon.data('application', app);
            if (app.get('placeholder').type === 'docked') {
                var order = app.get('app-order-index');
                _toolbarIconsOrder[order] = icon;
                if (app.get('app-id') === 'app-custom-icon') {
                    var customTrayIconWidth = Math.round(app.get('data').width * app.get('data').scale);
                    icon.data({width: customTrayIconWidth, custom: true});
                }
            } else {
                var floatingIconContainer = $(".floating-icon-container", appsContainer);
                icon.appendTo(floatingIconContainer);
            }
            SCOPE.Events.on('icon-repaint', app.repaint, app);
            if (icon) {
                $(icon).on(iroll.get('mainEngagementEvent'), function (ev) {
                    if (typeof app.launch === "function") {
                        iroll.report.click(ev);
                        app.launch();
                        if (app.get('category') === 'regular') {
                            SCOPE.Events.trigger('move-microsite-arrow', app.get('app-order-index'));
                        }
                    }
                });
            }
        }

        function updateAppHotspotClicks(app) {
            if ((iroll.get('sendLogs')) && (_.isObject(iroll.get('data')['placement-config']))) {
                var _tmpArr = _.clone(iroll.get('data')['placement-config']['hotspot-clicks']);
                app.get('reporting')['hotspots'] = {};
                _.each(_tmpArr, function (item, index) {
                    var _id = (item['id'].split('.'))[0], _event = (item['id'].split('.'))[1];
                    if (app.get('reporting').namespace == _id) {
                        if (!_.isArray(app.get('reporting')['hotspots'][_event])) {
                            app.get('reporting')['hotspots'][_event] = [];
                        }
                        app.get('reporting')['hotspots'][_event].push(item);
                        delete _tmpArr[index];
                    }
                });
            }
        }

        SCOPE.Events.on('closeSlates', function () {
            SCOPE.Events.trigger(iroll.get('id') + ":closeDialog");
        });
    };
    SCOPE.Events.on("IRollReady", function (iroll, data) {
        SCOPE.Events.on(iroll.get('id') + ':video_ended', function () {
            SCOPE.Events.trigger(iroll.get('id') + ':ad_ended');
        });
        SCOPE.Events.on(iroll.get('id') + ':video_play', function () {
            SCOPE.Events.trigger(iroll.get('id') + ':ad_play');
        });
        SCOPE.Events.on('buffering', function () {
            wrapper.addClass("iv-buffering");
        });
        SCOPE.Events.on('not_buffering', function () {
            wrapper.removeClass("iv-buffering");
        });
        if (iroll.get('displayVideo')) {
            iroll.get('videoPlayer').play();
        }
        format = new SCOPE.ExpandFormat(iroll, data);
        format.createWrapper();
        SCOPE.Events.trigger('appsSystemReady', format);
        if (data.toolbar.data.durationBar && data.toolbar.data.durationBar.visible) {
            SCOPE.Events.on(iroll.get('id') + ':video_timeupdate', function (ev) {
                format.repaintDurationBar(ev.duration, ev.currentTime, data.toolbar.data.durationBar);
            });
        }
        SCOPE.Events.trigger(iroll.get('id') + ':impression', iroll);
    }, this);
})(IV);
var VPAIDAd = function () {
    this.irollAd = null;
    this.width = 0;
    this.height = 0;
    this.initialWidth = 0;
    this.initialHeight = 0;
    this.slot = null;
    this.videoSlot = null;
    this.videoSlotCanAutoPlay = false;
    this.callbacks = {};
    this.adDuration = -2;
    this.adRemainingTime = -2;
    this.adExpanded = false;
    this.AD_STOP_DELAY_TIME_MS = 100;
    this._stopped = false;
    this._volume = -1;
};
VPAIDAd.prototype.initAd = function (width, height, viewMode, desiredBitrate, creativeData, environmentVars) {
    this.initialWidth = this.width = this._dimToNum(width);
    this.initialHeight = this.height = this._dimToNum(height);
    if (typeof environmentVars !== 'undefined') {
        if (environmentVars.hasOwnProperty('slot')) {
            this.slot = environmentVars.slot;
        }
        if (environmentVars.hasOwnProperty('videoSlot')) {
            this.videoSlot = environmentVars.videoSlot;
        }
        if (environmentVars.hasOwnProperty('videoSlotCanAutoPlay')) {
            this.videoSlotCanAutoPlay = environmentVars.videoSlotCanAutoPlay;
        }
    }
    this.irollAd = new IV.AppsCore({
        data: IV.baseData.app_data,
        config: IV.baseData.config_data,
        interface: this,
        delayAppVisibility: false,
        showClickToResume: true,
        BackButton: true,
        mainEngagementEvent: "click",
        checkForVisibility: false
    });
    if (this.videoSlot !== null) {
        var elementWrapper = new IV.VideoElementWrapper(this.videoSlot);
        var videoPlayer = new IV.SharedVideoPlayer(elementWrapper);
        this.irollAd.setAttribute({"videoPlayer": videoPlayer});
    } else {
        this.irollAd.setAttribute({videoPlayer: new IV.InternalVideoPlayer()});
    }
    if (typeof creativeSettings !== 'undefined') {
        this.irollAd.setAttribute(creativeSettings);
    }
    if (typeof creativeData !== 'undefined') {
        var creativeParams = this._parseCreativeParams(creativeData);
        this.irollAd.setAttribute(creativeParams);
    }
    if (this.slot !== null) {
        this.irollAd.setAttribute({"mainContainer": this.slot});
    }
    this.irollAd.trigger('init');
    this.irollAd.injectCSSToDoc();
    IV.vpaidExtensions.execute(IV.vpaidExtensions.EXTENSION_POINTS.BEFORE_AD_LOAD, this);
    this._fire("AdLoaded");
};
VPAIDAd.prototype.handshakeVersion = function () {
    return "2.0";
};
VPAIDAd.prototype.startAd = function () {
    if (this.slot !== null) {
        this.slot.style.display = "block";
        if (this.videoSlot !== null && (this.videoSlot instanceof HTMLMediaElement) && this.videoSlot.parentNode != this.slot) {
            this.slot.style.pointerEvents = "none";
        }
    }
    IV.vpaidExtensions.execute(IV.vpaidExtensions.EXTENSION_POINTS.BEFORE_AD_START, this);
    this._mapIRollEventsToVPAID();
    this.irollAd.trigger('start');
    this._fire("AdStarted");
};
VPAIDAd.prototype.stopAd = function () {
    var that = this;
    if (!this._stopped) {
        setTimeout(function () {
            that.irollAd.cleanUp();
            that._fire("AdStopped");
        }, this.AD_STOP_DELAY_TIME_MS);
        this._stopped = true;
    }
};
VPAIDAd.prototype.resizeAd = function (width, height) {
    this.width = this._dimToNum(width);
    this.height = this._dimToNum(height);
    IV.Events.trigger("winResize");
    this._fire("AdSizeChange");
};
VPAIDAd.prototype.pauseAd = function () {
    this.irollAd.get('videoPlayer').pause();
    this._fire("AdPaused");
};
VPAIDAd.prototype.resumeAd = function () {
    if (!this.adExpanded) {
        this.irollAd.get('videoPlayer').play();
    }
    this._fire("AdPlaying");
};
VPAIDAd.prototype.expandAd = function () {
};
VPAIDAd.prototype.collapseAd = function () {
    if (this.adExpanded) {
        IV.Events.trigger("closeSlates");
    }
};
VPAIDAd.prototype.skipAd = function () {
    this.irollAd.get('videoPlayer').pause();
    this._fire("AdSkipped");
};
VPAIDAd.prototype.subscribe = function (aCallback, eventName, aContext) {
    var fns = this.callbacks[eventName];
    if (!fns) {
        fns = [];
        this.callbacks[eventName] = fns;
    }
    if (fns.indexOf(aCallback) === -1) {
        fns.push({"callback": aCallback, "context": aContext});
    }
};
VPAIDAd.prototype.unsubscribe = function (aCallback, eventName) {
    if (typeof this.callbacks[eventName] !== "undefined") {
        delete this.callbacks[eventName];
    }
};
VPAIDAd.prototype.getAdExpanded = function () {
    return this.adExpanded;
};
VPAIDAd.prototype.getAdSize = function () {
    return {"width": this.width, "height": this.height};
};
VPAIDAd.prototype.getAdSkippableState = function () {
    return true;
};
VPAIDAd.prototype.getAdWidth = function () {
    return this.width;
};
VPAIDAd.prototype.getAdHeight = function () {
    return this.height;
};
VPAIDAd.prototype.getAdCompanions = function () {
    return "";
};
VPAIDAd.prototype.getAdIcons = function () {
    return false;
};
VPAIDAd.prototype.getAdLinear = function () {
    return true;
};
VPAIDAd.prototype.setAdVolume = function (vol) {
    if (vol !== this._volume) {
        this.irollAd.get('videoPlayer').setVolume(vol);
        this._volume = vol;
        this._fire("AdVolumeChange");
    }
};
VPAIDAd.prototype.getAdVolume = function () {
    var vol = this.irollAd.get('videoPlayer').getVolume();
    if (vol === -1) {
        vol = this._volume;
    }
    return vol;
};
VPAIDAd.prototype.getAdDuration = function () {
    return this.adDuration;
};
VPAIDAd.prototype.getAdRemainingTime = function () {
    return this.adRemainingTime;
};
VPAIDAd.prototype._fire = function (eventName) {
    var props = Array.prototype.slice.call(arguments, 1);
    (this.callbacks[eventName] || []).forEach(function (cb) {
        var scope = null;
        if (typeof cb.context !== 'undefined') {
            scope = cb.context;
        }
        cb.callback.apply(scope, props);
    });
};
VPAIDAd.prototype._setAdDuration = function (duration) {
    this.adDuration = duration;
};
VPAIDAd.prototype._setAdRemainingTime = function (time) {
    this.adRemainingTime = time;
};
VPAIDAd.prototype._mapIRollEventsToVPAID = function () {
    var id = this.irollAd.get('id'), vpaidAd = this, irollAd = this.irollAd;
    IV.Events.on(id + ':ad_started', function () {
        vpaidAd._fire('AdImpression');
        vpaidAd._fire('AdVideoStart');
    });
    IV.Events.on(id + ':video_videoPassed25', function () {
        vpaidAd._fire('AdVideoFirstQuartile');
    });
    IV.Events.on(id + ':video_videoPassed50', function () {
        vpaidAd._fire('AdVideoMidpoint');
    });
    IV.Events.on(id + ':video_videoPassed75', function () {
        vpaidAd._fire('AdVideoThirdQuartile');
    });
    IV.Events.on(id + ':video_timeupdate', function () {
        vpaidAd._setAdRemainingTime(irollAd.get('videoPlayer').getRemainingTime());
    });
    IV.Events.on(id + ':video_durationchange', function () {
        vpaidAd._setAdDuration(irollAd.get('videoPlayer').getDuration());
    });
    IV.Events.on(id + ':ad_ended', function () {
        vpaidAd._fire('AdVideoComplete');
        vpaidAd.stopAd();
    });
    IV.Events.on(id + ':close', function () {
        vpaidAd.stopAd();
    });
    IV.Events.on(id + ':openUrl', function (url) {
        vpaidAd._fire('AdClickThru', url, null, true);
    });
    IV.Events.on(id + ':userClick', function () {
        vpaidAd._fire('AdInteraction');
    });
    IV.Events.on(id + ':dialogOpened', function () {
        vpaidAd.adExpanded = true;
        vpaidAd._fire("AdPaused");
        vpaidAd._fire('AdExpandedChange');
    });
    IV.Events.on(id + ':dialogClosed', function () {
        vpaidAd.adExpanded = false;
        vpaidAd._fire('AdExpandedChange');
        vpaidAd._fire("AdPlaying");
    });
    IV.Events.on(id + ':slateOpened', function () {
        vpaidAd.adExpanded = true;
        vpaidAd._fire("AdPaused");
        vpaidAd._fire('AdExpandedChange');
    });
    IV.Events.on(id + ':slateClosed', function () {
        vpaidAd.adExpanded = false;
        vpaidAd._fire('AdExpandedChange');
        vpaidAd._fire("AdPlaying");
    });
    IV.Events.on(id + ':video_error', function () {
        setTimeout(function () {
            vpaidAd.irollAd.cleanUp();
            vpaidAd._fire("AdError");
        }, vpaidAd.AD_STOP_DELAY_TIME_MS);
    });
};
VPAIDAd.prototype._parseCreativeParams = function (creativeData) {
    function _str2bool(str) {
        return str == "true" ? true : ((str == "false") ? false : str);
    }

    var createDataObj = {};
    var creativeDataString = "";
    if (creativeData) {
        if (creativeData.hasOwnProperty("AdParameters") && typeof creativeData.AdParameters === 'string') {
            creativeDataString = creativeData.AdParameters;
        } else if (typeof creativeData === 'string') {
            creativeDataString = creativeData;
        }
        _.each(creativeDataString.split(';'), function (param) {
            var parts = param.split('=');
            if (parts.length == 2) {
                createDataObj[parts[0]] = _str2bool(parts[1]);
            }
        });
    }
    return createDataObj;
};
VPAIDAd.prototype._dimToNum = function (dim) {
    return Number(dim) || 0;
};
var getVPAIDAd = function () {
    return new VPAIDAd();
};
(function (SCOPE) {
    SCOPE.VPAIDExtensions = function () {
        var extensions = {};
        this.EXTENSION_POINTS = {"BEFORE_AD_LOAD": 1, "BEFORE_AD_START": 2};
        this.PRIORTIES = {"LOW": 1, "HIGH": 2, "MONITOR": 3};
        this.PRIORITY_ORDER = [this.PRIORTIES.LOW, this.PRIORTIES.HIGH, this.PRIORTIES.MONITOR];
        this.register = function (func, extensionPoint, priority) {
            if (typeof priority === "undefined") {
                priority = this.PRIORTIES.LOW;
            }
            if (!extensions.hasOwnProperty(extensionPoint)) {
                extensions[extensionPoint] = {};
                _.each(this.PRIORTIES, function (val) {
                    extensions[extensionPoint][val] = [];
                });
            }
            extensions[extensionPoint][priority].push(func);
        };
        this.execute = function (extPoint, context) {
            if (extensions.hasOwnProperty(extPoint)) {
                _.each(this.PRIORITY_ORDER, function (pr) {
                    _.each(extensions[extPoint][pr], function (func) {
                        func.call(this, context);
                    });
                });
            }
        };
    };
    SCOPE.vpaidExtensions = new SCOPE.VPAIDExtensions();
})(IV);
IV.vpaidExtensions.register(function (vpaidAd) {
    var
        doc = vpaidAd.slot.ownerDocument, _isFullScreen = false;

    function toggleFullScreen(isFullScreen) {
        _isFullScreen = isFullScreen;
        if (isFullScreen) {
            vpaidAd.resizeAd(screen.width, screen.height);
        } else {
            vpaidAd.resizeAd(vpaidAd.initialWidth, vpaidAd.initialHeight);
        }
    }

    $(doc).on("fullscreenchange", function () {
        toggleFullScreen(doc.fullscreen)
    }).on("mozfullscreenchange", function () {
        toggleFullScreen(doc.mozFullScreen)
    }).on("webkitfullscreenchange", function () {
        toggleFullScreen(doc.webkitIsFullScreen)
    }).on("MSFullscreenChange", function () {
        toggleFullScreen(!!doc.msFullscreenElement)
    });
    var view = doc.parentWindow || doc.defaultView;
    $(view).on("orientationchange", function () {
        setTimeout(function () {
            if (_isFullScreen) {
                vpaidAd.resizeAd($(view).width(), $(view).height());
            }
        }, 300);
    });
}, IV.vpaidExtensions.EXTENSION_POINTS.BEFORE_AD_START);
